(window.webpackJsonp=window.webpackJsonp||[]).push([[46],{390:function(t,a,e){"use strict";e.r(a);var s=e(45),n=Object(s.a)({},(function(){var t=this,a=t.$createElement,e=t._self._c||a;return e("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[e("h2",{attrs:{id:"什么是优先级"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#什么是优先级"}},[t._v("#")]),t._v(" 什么是优先级")]),t._v(" "),e("p",[t._v("在"),e("a",{attrs:{href:"https://react.iamkasong.com/preparation/idea.html#%E7%90%86%E8%A7%A3-%E5%93%8D%E5%BA%94%E8%87%AA%E7%84%B6",target:"_blank",rel:"noopener noreferrer"}},[t._v("React理念一节"),e("OutboundLink")],1),t._v("我们聊到"),e("code",[t._v("React")]),t._v("将人机交互研究的结果整合到真实的"),e("code",[t._v("UI")]),t._v("中。具体到"),e("code",[t._v("React")]),t._v("运行上这是什么意思呢？")]),t._v(" "),e("p",[e("code",[t._v("状态更新")]),t._v("由"),e("code",[t._v("用户交互")]),t._v("产生，用户心里对"),e("code",[t._v("交互")]),t._v("执行顺序有个预期。"),e("code",[t._v("React")]),t._v("根据"),e("code",[t._v("人机交互研究的结果")]),t._v("中用户对"),e("code",[t._v("交互")]),t._v("的预期顺序为"),e("code",[t._v("交互")]),t._v("产生的"),e("code",[t._v("状态更新")]),t._v("赋予不同优先级。")]),t._v(" "),e("p",[t._v("具体如下：")]),t._v(" "),e("ul",[e("li",[t._v("生命周期方法：同步执行。")]),t._v(" "),e("li",[t._v("受控的用户输入：比如输入框内输入文字，同步执行。")]),t._v(" "),e("li",[t._v("交互事件：比如动画，高优先级执行。")]),t._v(" "),e("li",[t._v("其他：比如数据请求，低优先级执行。")])]),t._v(" "),e("h2",{attrs:{id:"如何调度优先级"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#如何调度优先级"}},[t._v("#")]),t._v(" "),e("a",{attrs:{href:"https://react.iamkasong.com/state/priority.html#%E5%A6%82%E4%BD%95%E8%B0%83%E5%BA%A6%E4%BC%98%E5%85%88%E7%BA%A7",target:"_blank",rel:"noopener noreferrer"}},[t._v("#"),e("OutboundLink")],1),t._v("如何调度优先级")]),t._v(" "),e("p",[t._v("我们在"),e("a",{attrs:{href:"https://react.iamkasong.com/preparation/newConstructure.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("新的React结构一节"),e("OutboundLink")],1),t._v("讲到，"),e("code",[t._v("React")]),t._v("通过"),e("code",[t._v("Scheduler")]),t._v("调度任务。")]),t._v(" "),e("p",[t._v("具体到代码，每当需要调度任务时，"),e("code",[t._v("React")]),t._v("会调用"),e("code",[t._v("Scheduler")]),t._v("提供的方法"),e("code",[t._v("runWithPriority")]),t._v("。")]),t._v(" "),e("p",[t._v("该方法接收一个"),e("code",[t._v("优先级")]),t._v("常量与一个"),e("code",[t._v("回调函数")]),t._v("作为参数。"),e("code",[t._v("回调函数")]),t._v("会以"),e("code",[t._v("优先级")]),t._v("高低为顺序排列在一个"),e("code",[t._v("定时器")]),t._v("中并在合适的时间触发。")]),t._v(" "),e("p",[t._v("对于更新来讲，传递的"),e("code",[t._v("回调函数")]),t._v("一般为"),e("a",{attrs:{href:"https://react.iamkasong.com/state/prepare.html#render%E9%98%B6%E6%AE%B5%E7%9A%84%E5%BC%80%E5%A7%8B",target:"_blank",rel:"noopener noreferrer"}},[t._v("状态更新流程概览一节"),e("OutboundLink")],1),t._v("讲到的"),e("code",[t._v("render阶段的入口函数")]),t._v("。")]),t._v(" "),e("blockquote",[e("p",[t._v("你可以在"),e("a",{attrs:{href:"https://github.com/facebook/react/blob/970fa122d8188bafa600e9b5214833487fbf1092/packages/scheduler/src/Scheduler.js#L217",target:"_blank",rel:"noopener noreferrer"}},[t._v("==unstable_runWithPriority== 这里 (opens new window)"),e("OutboundLink")],1),t._v("看到"),e("code",[t._v("runWithPriority")]),t._v("方法的定义。在"),e("a",{attrs:{href:"https://github.com/facebook/react/blob/970fa122d8188bafa600e9b5214833487fbf1092/packages/scheduler/src/SchedulerPriorities.js",target:"_blank",rel:"noopener noreferrer"}},[t._v("这里 (opens new window)"),e("OutboundLink")],1),t._v("看到"),e("code",[t._v("Scheduler")]),t._v("对优先级常量的定义。")])]),t._v(" "),e("h2",{attrs:{id:"例子"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#例子"}},[t._v("#")]),t._v(" "),e("a",{attrs:{href:"https://react.iamkasong.com/state/priority.html#%E4%BE%8B%E5%AD%90",target:"_blank",rel:"noopener noreferrer"}},[t._v("#"),e("OutboundLink")],1),t._v("例子")]),t._v(" "),e("p",[t._v("优先级最终会反映到"),e("code",[t._v("update.lane")]),t._v("变量上。当前我们只需要知道这个变量能够区分"),e("code",[t._v("Update")]),t._v("的优先级。")]),t._v(" "),e("p",[t._v("接下来我们通过一个例子结合上一节介绍的"),e("code",[t._v("Update")]),t._v("相关字段讲解优先级如何决定更新的顺序。")]),t._v(" "),e("blockquote",[e("p",[t._v("该例子来自"),e("a",{attrs:{href:"https://twitter.com/acdlite/status/978412930973687808",target:"_blank",rel:"noopener noreferrer"}},[t._v("React Core Team Andrew向网友讲解Update工作流程的推文(opens new window)"),e("OutboundLink")],1)])]),t._v(" "),e("p",[e("img",{attrs:{src:"https://react.iamkasong.com/img/update-process.png",alt:"优先级如何决定更新的顺序"}})]),t._v(" "),e("p",[t._v("在这个例子中，有两个"),e("code",[t._v("Update")]),t._v("。我们将“关闭黑夜模式”产生的"),e("code",[t._v("Update")]),t._v("称为"),e("code",[t._v("u1")]),t._v("，输入字母“I”产生的"),e("code",[t._v("Update")]),t._v("称为"),e("code",[t._v("u2")]),t._v("。")]),t._v(" "),e("p",[t._v("其中"),e("code",[t._v("u1")]),t._v("先触发并进入"),e("code",[t._v("render阶段")]),t._v("。其优先级较低，执行时间较长。此时：")]),t._v(" "),e("div",{staticClass:"language-js extra-class"},[e("pre",{pre:!0,attrs:{class:"language-js"}},[e("code",[t._v("fiber"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("updateQueue "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  baseState"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    blackTheme"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    text"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'H'")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  firstBaseUpdate"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  lastBaseUpdate"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),t._v("\n  shared"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    pending"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" u1\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  effects"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),e("p",[t._v("在"),e("code",[t._v("u1")]),t._v("完成"),e("code",[t._v("render阶段")]),t._v("前用户通过键盘输入字母“I”，产生了"),e("code",[t._v("u2")]),t._v("。"),e("code",[t._v("u2")]),t._v("属于"),e("strong",[t._v("受控的用户输入")]),t._v("，优先级高于"),e("code",[t._v("u1")]),t._v("，于是中断"),e("code",[t._v("u1")]),t._v("产生的"),e("code",[t._v("render阶段")]),t._v("。")]),t._v(" "),e("p",[t._v("此时：")]),t._v(" "),e("div",{staticClass:"language-js extra-class"},[e("pre",{pre:!0,attrs:{class:"language-js"}},[e("code",[t._v("fiber"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("updateQueue"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("shared"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("pending "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" u2 "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" u1\n                                     "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("^")]),t._v("        "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("\n                                     "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("________"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 即")]),t._v("\nu2"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("next "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" u1"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nu1"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("next "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" u2"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),e("p",[t._v("其中"),e("code",[t._v("u2")]),t._v("优先级高于"),e("code",[t._v("u1")]),t._v("。")]),t._v(" "),e("p",[t._v("接下来进入"),e("code",[t._v("u2")]),t._v("产生的"),e("code",[t._v("render阶段")]),t._v("。")]),t._v(" "),e("p",[t._v("在"),e("code",[t._v("processUpdateQueue")]),t._v("方法中，"),e("code",[t._v("shared.pending")]),t._v("环状链表会被剪开并拼接在"),e("code",[t._v("baseUpdate")]),t._v("后面。")]),t._v(" "),e("p",[t._v("需要明确一点，"),e("code",[t._v("shared.pending")]),t._v("指向最后一个"),e("code",[t._v("pending")]),t._v("的"),e("code",[t._v("update")]),t._v("，所以实际执行时"),e("code",[t._v("update")]),t._v("的顺序为：")]),t._v(" "),e("div",{staticClass:"language-js extra-class"},[e("pre",{pre:!0,attrs:{class:"language-js"}},[e("code",[t._v("u1 "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v(" u2\n")])])]),e("p",[t._v("接下来遍历"),e("code",[t._v("baseUpdate")]),t._v("，处理优先级合适的"),e("code",[t._v("Update")]),t._v("（这一次处理的是更高优的"),e("code",[t._v("u2")]),t._v("）。")]),t._v(" "),e("p",[t._v("由于"),e("code",[t._v("u2")]),t._v("不是"),e("code",[t._v("baseUpdate")]),t._v("中的第一个"),e("code",[t._v("update")]),t._v("，在其之前的"),e("code",[t._v("u1")]),t._v("由于优先级不够被跳过。")]),t._v(" "),e("p",[e("code",[t._v("update")]),t._v("之间可能有依赖关系，所以被跳过的"),e("code",[t._v("update")]),t._v("及其后面所有"),e("code",[t._v("update")]),t._v("会成为下次更新的"),e("code",[t._v("baseUpdate")]),t._v("。（即"),e("code",[t._v("u1 -- u2")]),t._v("）。")]),t._v(" "),e("p",[t._v("最终"),e("code",[t._v("u2")]),t._v("完成"),e("code",[t._v("render - commit阶段")]),t._v("。")]),t._v(" "),e("p",[t._v("此时：")]),t._v(" "),e("div",{staticClass:"language-js extra-class"},[e("pre",{pre:!0,attrs:{class:"language-js"}},[e("code",[t._v("fiber"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("updateQueue "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  baseState"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    blackTheme"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    text"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'HI'")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  firstBaseUpdate"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" u1"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  lastBaseUpdate"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" u2\n  shared"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    pending"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  effects"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),e("p",[t._v("在"),e("code",[t._v("commit")]),t._v("阶段结尾会再调度一次更新。在该次更新中会基于"),e("code",[t._v("baseState")]),t._v("中"),e("code",[t._v("firstBaseUpdate")]),t._v("保存的"),e("code",[t._v("u1")]),t._v("，开启一次新的"),e("code",[t._v("render阶段")]),t._v("。")]),t._v(" "),e("p",[t._v("最终两次"),e("code",[t._v("Update")]),t._v("都完成后的结果如下：")]),t._v(" "),e("div",{staticClass:"language-js extra-class"},[e("pre",{pre:!0,attrs:{class:"language-js"}},[e("code",[t._v("fiber"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("updateQueue "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  baseState"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    blackTheme"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    text"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'HI'")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  firstBaseUpdate"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  lastBaseUpdate"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),t._v("\n  shared"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    pending"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  effects"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),e("p",[t._v("我们可以看见，"),e("code",[t._v("u2")]),t._v("对应的更新执行了两次，相应的"),e("code",[t._v("render阶段")]),t._v("的生命周期勾子"),e("code",[t._v("componentWillXXX")]),t._v("也会触发两次。这也是为什么这些勾子会被标记为"),e("code",[t._v("unsafe_")]),t._v("。")]),t._v(" "),e("h2",{attrs:{id:"如何保证状态正确"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#如何保证状态正确"}},[t._v("#")]),t._v(" "),e("a",{attrs:{href:"https://react.iamkasong.com/state/priority.html#%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81%E7%8A%B6%E6%80%81%E6%AD%A3%E7%A1%AE",target:"_blank",rel:"noopener noreferrer"}},[t._v("#"),e("OutboundLink")],1),t._v("如何保证状态正确")]),t._v(" "),e("p",[t._v("现在我们基本掌握了"),e("code",[t._v("updateQueue")]),t._v("的工作流程。还有两个疑问：")]),t._v(" "),e("ul",[e("li",[e("code",[t._v("render阶段")]),t._v("可能被中断。如何保证"),e("code",[t._v("updateQueue")]),t._v("中保存的"),e("code",[t._v("Update")]),t._v("不丢失？")]),t._v(" "),e("li",[t._v("有时候当前"),e("code",[t._v("状态")]),t._v("需要依赖前一个"),e("code",[t._v("状态")]),t._v("。如何在支持跳过"),e("code",[t._v("低优先级状态")]),t._v("的同时保证"),e("strong",[t._v("状态依赖的连续性")]),t._v("？")])]),t._v(" "),e("p",[t._v("我们分别讲解下。")]),t._v(" "),e("h3",{attrs:{id:"如何保证update不丢失"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#如何保证update不丢失"}},[t._v("#")]),t._v(" "),e("a",{attrs:{href:"https://react.iamkasong.com/state/priority.html#%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81update%E4%B8%8D%E4%B8%A2%E5%A4%B1",target:"_blank",rel:"noopener noreferrer"}},[t._v("#"),e("OutboundLink")],1),t._v("如何保证"),e("code",[t._v("Update")]),t._v("不丢失")]),t._v(" "),e("p",[t._v("在"),e("a",{attrs:{href:"https://react.iamkasong.com/state/update.html#%E4%BE%8B%E5%AD%90",target:"_blank",rel:"noopener noreferrer"}},[t._v("上一节例子"),e("OutboundLink")],1),t._v("中我们讲到，在"),e("code",[t._v("render阶段")]),t._v("，"),e("code",[t._v("shared.pending")]),t._v("的环被剪开并连接在"),e("code",[t._v("updateQueue.lastBaseUpdate")]),t._v("后面。")]),t._v(" "),e("p",[t._v("实际上"),e("code",[t._v("shared.pending")]),t._v("会被同时连接在"),e("code",[t._v("workInProgress updateQueue.lastBaseUpdate")]),t._v("与"),e("code",[t._v("current updateQueue.lastBaseUpdate")]),t._v("后面。")]),t._v(" "),e("blockquote",[e("p",[t._v("具体代码见"),e("a",{attrs:{href:"https://github.com/facebook/react/blob/970fa122d8188bafa600e9b5214833487fbf1092/packages/react-reconciler/src/ReactUpdateQueue.new.js#L424",target:"_blank",rel:"noopener noreferrer"}},[t._v("这里(opens new window)"),e("OutboundLink")],1)])]),t._v(" "),e("p",[t._v("当"),e("code",[t._v("render阶段")]),t._v("被中断后重新开始时，会基于"),e("code",[t._v("current updateQueue")]),t._v("克隆出"),e("code",[t._v("workInProgress updateQueue")]),t._v("。由于"),e("code",[t._v("current updateQueue.lastBaseUpdate")]),t._v("已经保存了上一次的"),e("code",[t._v("Update")]),t._v("，所以不会丢失。")]),t._v(" "),e("p",[t._v("当"),e("code",[t._v("commit阶段")]),t._v("完成渲染，由于"),e("code",[t._v("workInProgress updateQueue.lastBaseUpdate")]),t._v("中保存了上一次的"),e("code",[t._v("Update")]),t._v("，所以 "),e("code",[t._v("workInProgress Fiber树")]),t._v("变成"),e("code",[t._v("current Fiber树")]),t._v("后也不会造成"),e("code",[t._v("Update")]),t._v("丢失。")]),t._v(" "),e("h3",{attrs:{id:"如何保证状态依赖的连续性"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#如何保证状态依赖的连续性"}},[t._v("#")]),t._v(" "),e("a",{attrs:{href:"https://react.iamkasong.com/state/priority.html#%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81%E7%8A%B6%E6%80%81%E4%BE%9D%E8%B5%96%E7%9A%84%E8%BF%9E%E7%BB%AD%E6%80%A7",target:"_blank",rel:"noopener noreferrer"}},[t._v("#"),e("OutboundLink")],1),t._v("如何保证状态依赖的连续性")]),t._v(" "),e("p",[t._v("当某个"),e("code",[t._v("Update")]),t._v("由于优先级低而被跳过时，保存在"),e("code",[t._v("baseUpdate")]),t._v("中的不仅是该"),e("code",[t._v("Update")]),t._v("，还包括链表中该"),e("code",[t._v("Update")]),t._v("之后的所有"),e("code",[t._v("Update")]),t._v("。")]),t._v(" "),e("p",[t._v("考虑如下例子：")]),t._v(" "),e("div",{staticClass:"language-js extra-class"},[e("pre",{pre:!0,attrs:{class:"language-js"}},[e("code",[t._v("baseState"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("''")]),t._v("\nshared"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("pending"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token constant"}},[t._v("A1")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token constant"}},[t._v("B2")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token constant"}},[t._v("C1")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token constant"}},[t._v("D2")]),t._v("\n")])])]),e("p",[t._v("其中"),e("code",[t._v("字母")]),t._v("代表该"),e("code",[t._v("Update")]),t._v("要在页面插入的字母，"),e("code",[t._v("数字")]),t._v("代表"),e("code",[t._v("优先级")]),t._v("，值越低"),e("code",[t._v("优先级")]),t._v("越高。")]),t._v(" "),e("p",[t._v("第一次"),e("code",[t._v("render")]),t._v("，"),e("code",[t._v("优先级")]),t._v("为1。")]),t._v(" "),e("div",{staticClass:"language-js extra-class"},[e("pre",{pre:!0,attrs:{class:"language-js"}},[e("code",[t._v("baseState"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("''")]),t._v("\nbaseUpdate"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),t._v("\nrender阶段使用的Update"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),e("span",{pre:!0,attrs:{class:"token constant"}},[t._v("A1")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token constant"}},[t._v("C1")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\nmemoizedState"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'AC'")]),t._v("\n")])])]),e("p",[t._v("其中"),e("code",[t._v("B2")]),t._v("由于优先级为2，低于当前优先级，所以他及其后面的所有"),e("code",[t._v("Update")]),t._v("会被保存在"),e("code",[t._v("baseUpdate")]),t._v("中作为下次更新的"),e("code",[t._v("Update")]),t._v("（即"),e("code",[t._v("B2 C1 D2")]),t._v("）。")]),t._v(" "),e("p",[t._v("这么做是为了保持"),e("code",[t._v("状态")]),t._v("的前后依赖顺序。")]),t._v(" "),e("p",[t._v("第二次"),e("code",[t._v("render")]),t._v("，"),e("code",[t._v("优先级")]),t._v("为2。")]),t._v(" "),e("div",{staticClass:"language-js extra-class"},[e("pre",{pre:!0,attrs:{class:"language-js"}},[e("code",[t._v("baseState"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'A'")]),t._v("\nbaseUpdate"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token constant"}},[t._v("B2")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token constant"}},[t._v("C1")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token constant"}},[t._v("D2")]),t._v("\nrender阶段使用的Update"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),e("span",{pre:!0,attrs:{class:"token constant"}},[t._v("B2")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token constant"}},[t._v("C1")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token constant"}},[t._v("D2")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\nmemoizedState"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'ABCD'")]),t._v("\n")])])]),e("p",[t._v("注意这里"),e("code",[t._v("baseState")]),t._v("并不是上一次更新的"),e("code",[t._v("memoizedState")]),t._v("。这是由于"),e("code",[t._v("B2")]),t._v("被跳过了。")]),t._v(" "),e("p",[t._v("即当有"),e("code",[t._v("Update")]),t._v("被跳过时，"),e("code",[t._v("下次更新的baseState !== 上次更新的memoizedState")]),t._v("。")]),t._v(" "),e("blockquote",[e("p",[t._v("跳过"),e("code",[t._v("B2")]),t._v("的逻辑见"),e("a",{attrs:{href:"https://github.com/facebook/react/blob/970fa122d8188bafa600e9b5214833487fbf1092/packages/react-reconciler/src/ReactUpdateQueue.new.js#L479",target:"_blank",rel:"noopener noreferrer"}},[t._v("这里(opens new window)"),e("OutboundLink")],1)])]),t._v(" "),e("p",[t._v("通过以上例子我们可以发现，"),e("code",[t._v("React")]),t._v("保证最终的状态一定和用户触发的"),e("code",[t._v("交互")]),t._v("一致，但是中间过程"),e("code",[t._v("状态")]),t._v("可能由于设备不同而不同。")]),t._v(" "),e("p",[t._v("经过五章的学习，我们终于回到了"),e("code",[t._v("React")]),t._v("应用的起点。")]),t._v(" "),e("p",[t._v("这一节我们完整的走通"),e("code",[t._v("ReactDOM.render")]),t._v("完成页面渲染的整个流程。")]),t._v(" "),e("h2",{attrs:{id:"创建fiber"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#创建fiber"}},[t._v("#")]),t._v(" "),e("a",{attrs:{href:"https://react.iamkasong.com/state/reactdom.html#%E5%88%9B%E5%BB%BAfiber",target:"_blank",rel:"noopener noreferrer"}},[t._v("#"),e("OutboundLink")],1),t._v("创建fiber")]),t._v(" "),e("p",[t._v("从"),e("a",{attrs:{href:"https://react.iamkasong.com/process/doubleBuffer.html#mount%E6%97%B6",target:"_blank",rel:"noopener noreferrer"}},[t._v("双缓存机制一节"),e("OutboundLink")],1),t._v("我们知道，首次执行"),e("code",[t._v("ReactDOM.render")]),t._v("会创建"),e("code",[t._v("fiberRootNode")]),t._v("和"),e("code",[t._v("rootFiber")]),t._v("。其中"),e("code",[t._v("fiberRootNode")]),t._v("是整个应用的根节点，"),e("code",[t._v("rootFiber")]),t._v("是要渲染组件所在组件树的"),e("code",[t._v("根节点")]),t._v("。")]),t._v(" "),e("p",[t._v("这一步发生在调用"),e("code",[t._v("ReactDOM.render")]),t._v("后进入的"),e("code",[t._v("legacyRenderSubtreeIntoContainer")]),t._v("方法中。")]),t._v(" "),e("div",{staticClass:"language-js extra-class"},[e("pre",{pre:!0,attrs:{class:"language-js"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// container指ReactDOM.render的第二个参数（即应用挂载的DOM节点）")]),t._v("\nroot "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" container"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("_reactRootContainer "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("legacyCreateRootFromDOMContainer")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n  container"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  forceHydrate"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nfiberRoot "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" root"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("_internalRoot"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),e("blockquote",[e("p",[t._v("你可以从"),e("a",{attrs:{href:"https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-dom/src/client/ReactDOMLegacy.js#L193",target:"_blank",rel:"noopener noreferrer"}},[t._v("这里 (opens new window)"),e("OutboundLink")],1),t._v("看到这一步的代码")])]),t._v(" "),e("p",[e("code",[t._v("legacyCreateRootFromDOMContainer")]),t._v("方法内部会调用"),e("code",[t._v("createFiberRoot")]),t._v("方法完成"),e("code",[t._v("fiberRootNode")]),t._v("和"),e("code",[t._v("rootFiber")]),t._v("的创建以及关联。并初始化"),e("code",[t._v("updateQueue")]),t._v("。")]),t._v(" "),e("div",{staticClass:"language-js extra-class"},[e("pre",{pre:!0,attrs:{class:"language-js"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("createFiberRoot")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("containerInfo"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" any"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  tag"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" RootTag"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  hydrate"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" boolean"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  hydrationCallbacks"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" SuspenseHydrationCallbacks"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")])]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" FiberRoot "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 创建fiberRootNode")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" root"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" FiberRoot "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("FiberRootNode")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("containerInfo"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" tag"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" hydrate"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" any"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  \n  "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 创建rootFiber")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" uninitializedFiber "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("createHostRootFiber")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("tag"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 连接rootFiber与fiberRootNode")]),t._v("\n  root"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("current "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" uninitializedFiber"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  uninitializedFiber"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("stateNode "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" root"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 初始化updateQueue")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("initializeUpdateQueue")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("uninitializedFiber"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" root"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),e("p",[t._v("根据以上代码，现在我们可以在"),e("a",{attrs:{href:"https://react.iamkasong.com/process/doubleBuffer.html#mount%E6%97%B6",target:"_blank",rel:"noopener noreferrer"}},[t._v("双缓存机制一节"),e("OutboundLink")],1),t._v("基础上补充上"),e("code",[t._v("rootFiber")]),t._v("到"),e("code",[t._v("fiberRootNode")]),t._v("的引用。")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://react.iamkasong.com/img/fiberroot.png",alt:"fiberRoot"}})]),t._v(" "),e("blockquote",[e("p",[t._v("你可以从"),e("a",{attrs:{href:"https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactFiberRoot.new.js#L97",target:"_blank",rel:"noopener noreferrer"}},[t._v("这里 (opens new window)"),e("OutboundLink")],1),t._v("看到这一步的代码")])]),t._v(" "),e("h2",{attrs:{id:"创建update"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#创建update"}},[t._v("#")]),t._v(" "),e("a",{attrs:{href:"https://react.iamkasong.com/state/reactdom.html#%E5%88%9B%E5%BB%BAupdate",target:"_blank",rel:"noopener noreferrer"}},[t._v("#"),e("OutboundLink")],1),t._v("创建update")]),t._v(" "),e("p",[t._v("我们已经做好了组件的初始化工作，接下来就等待创建"),e("code",[t._v("Update")]),t._v("来开启一次更新。")]),t._v(" "),e("p",[t._v("这一步发生在"),e("code",[t._v("updateContainer")]),t._v("方法中。")]),t._v(" "),e("div",{staticClass:"language-js extra-class"},[e("pre",{pre:!0,attrs:{class:"language-js"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("updateContainer")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("element"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" ReactNodeList"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  container"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" OpaqueRoot"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  parentComponent"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),t._v("React$Component"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("any"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" any"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  callback"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),t._v("Function"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")])]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Lane "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...省略与逻辑不相关代码")]),t._v("\n\n  "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 创建update")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" update "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("createUpdate")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("eventTime"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" lane"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" suspenseConfig"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  \n  "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// update.payload为需要挂载在根节点的组件")]),t._v("\n  update"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("payload "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("element"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// callback为ReactDOM.render的第三个参数 —— 回调函数")]),t._v("\n  callback "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" callback "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("undefined")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" callback"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("callback "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!==")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    update"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("callback "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" callback"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n  "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 将生成的update加入updateQueue")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("enqueueUpdate")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("current"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" update"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 调度更新")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("scheduleUpdateOnFiber")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("current"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" lane"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" eventTime"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...省略与逻辑不相关代码")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),e("blockquote",[e("p",[t._v("你可以从"),e("a",{attrs:{href:"https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactFiberReconciler.new.js#L255",target:"_blank",rel:"noopener noreferrer"}},[t._v("这里 (opens new window)"),e("OutboundLink")],1),t._v("看到"),e("code",[t._v("updateContainer")]),t._v("的代码")])]),t._v(" "),e("p",[t._v("值得注意的是其中"),e("code",[t._v("update.payload = {element};")])]),t._v(" "),e("p",[t._v("这就是我们在"),e("a",{attrs:{href:"https://react.iamkasong.com/state/update.html#update%E7%9A%84%E7%BB%93%E6%9E%84",target:"_blank",rel:"noopener noreferrer"}},[t._v("Update一节"),e("OutboundLink")],1),t._v("介绍的，对于"),e("code",[t._v("HostRoot")]),t._v("，"),e("code",[t._v("payload")]),t._v("为"),e("code",[t._v("ReactDOM.render")]),t._v("的第一个传参。")]),t._v(" "),e("h2",{attrs:{id:"流程概览"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#流程概览"}},[t._v("#")]),t._v(" "),e("a",{attrs:{href:"https://react.iamkasong.com/state/reactdom.html#%E6%B5%81%E7%A8%8B%E6%A6%82%E8%A7%88",target:"_blank",rel:"noopener noreferrer"}},[t._v("#"),e("OutboundLink")],1),t._v("流程概览")]),t._v(" "),e("p",[t._v("至此，"),e("code",[t._v("ReactDOM.render")]),t._v("的流程就和我们已知的流程连接上了。")]),t._v(" "),e("p",[t._v("整个流程如下：")]),t._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[t._v("创建fiberRootNode、rootFiber、updateQueue（"),e("span",{pre:!0,attrs:{class:"token variable"}},[e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("`")]),t._v("legacyCreateRootFromDOMContainer"),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("`")])]),t._v("）\n\n    "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("v")]),t._v("\n\n创建Update对象（"),e("span",{pre:!0,attrs:{class:"token variable"}},[e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("`")]),t._v("updateContainer"),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("`")])]),t._v("）\n\n    "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("v")]),t._v("\n\n从fiber到root（"),e("span",{pre:!0,attrs:{class:"token variable"}},[e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("`")]),t._v("markUpdateLaneFromFiberToRoot"),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("`")])]),t._v("）\n\n    "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("v")]),t._v("\n\n调度更新（"),e("span",{pre:!0,attrs:{class:"token variable"}},[e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("`")]),t._v("ensureRootIsScheduled"),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("`")])]),t._v("）\n\n    "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("v")]),t._v("\n\nrender阶段（"),e("span",{pre:!0,attrs:{class:"token variable"}},[e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("`")]),t._v("performSyncWorkOnRoot"),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("`")])]),t._v(" 或 "),e("span",{pre:!0,attrs:{class:"token variable"}},[e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("`")]),t._v("performConcurrentWorkOnRoot"),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("`")])]),t._v("）\n\n    "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("v")]),t._v("\n\ncommit阶段（"),e("span",{pre:!0,attrs:{class:"token variable"}},[e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("`")]),t._v("commitRoot"),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("`")])]),t._v("）\n")])])]),e("h2",{attrs:{id:"react的其他入口函数"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#react的其他入口函数"}},[t._v("#")]),t._v(" "),e("a",{attrs:{href:"https://react.iamkasong.com/state/reactdom.html#react%E7%9A%84%E5%85%B6%E4%BB%96%E5%85%A5%E5%8F%A3%E5%87%BD%E6%95%B0",target:"_blank",rel:"noopener noreferrer"}},[t._v("#"),e("OutboundLink")],1),t._v("React的其他入口函数")]),t._v(" "),e("p",[t._v("当前"),e("code",[t._v("React")]),t._v("共有三种模式：")]),t._v(" "),e("ul",[e("li",[e("code",[t._v("legacy")]),t._v("，这是当前"),e("code",[t._v("React")]),t._v("使用的方式。当前没有计划删除本模式，但是这个模式可能不支持一些新功能。")]),t._v(" "),e("li",[e("code",[t._v("blocking")]),t._v("，开启部分"),e("code",[t._v("concurrent")]),t._v("模式特性的中间模式。目前正在实验中。作为迁移到"),e("code",[t._v("concurrent")]),t._v("模式的第一个步骤。")]),t._v(" "),e("li",[e("code",[t._v("concurrent")]),t._v("，面向未来的开发模式。我们之前讲的"),e("code",[t._v("任务中断/任务优先级")]),t._v("都是针对"),e("code",[t._v("concurrent")]),t._v("模式。")])]),t._v(" "),e("p",[t._v("你可以从下表看出各种模式对特性的支持：")]),t._v(" "),e("table",[e("thead",[e("tr",[e("th"),t._v(" "),e("th",[t._v("legacy 模式")]),t._v(" "),e("th",[t._v("blocking 模式")]),t._v(" "),e("th",[t._v("concurrent 模式")])])]),t._v(" "),e("tbody",[e("tr",[e("td",[e("a",{attrs:{href:"https://zh-hans.reactjs.org/docs/refs-and-the-dom.html#legacy-api-string-refs",target:"_blank",rel:"noopener noreferrer"}},[t._v("String Refs(opens new window)"),e("OutboundLink")],1)]),t._v(" "),e("td",[t._v("✅")]),t._v(" "),e("td",[t._v("🚫**")]),t._v(" "),e("td",[t._v("🚫**")])]),t._v(" "),e("tr",[e("td",[e("a",{attrs:{href:"https://zh-hans.reactjs.org/docs/legacy-context.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("Legacy Context(opens new window)"),e("OutboundLink")],1)]),t._v(" "),e("td",[t._v("✅")]),t._v(" "),e("td",[t._v("🚫**")]),t._v(" "),e("td",[t._v("🚫**")])]),t._v(" "),e("tr",[e("td",[e("a",{attrs:{href:"https://zh-hans.reactjs.org/docs/strict-mode.html#warning-about-deprecated-finddomnode-usage",target:"_blank",rel:"noopener noreferrer"}},[t._v("findDOMNode(opens new window)"),e("OutboundLink")],1)]),t._v(" "),e("td",[t._v("✅")]),t._v(" "),e("td",[t._v("🚫**")]),t._v(" "),e("td",[t._v("🚫**")])]),t._v(" "),e("tr",[e("td",[e("a",{attrs:{href:"https://zh-hans.reactjs.org/docs/concurrent-mode-suspense.html#what-is-suspense-exactly",target:"_blank",rel:"noopener noreferrer"}},[t._v("Suspense(opens new window)"),e("OutboundLink")],1)]),t._v(" "),e("td",[t._v("✅")]),t._v(" "),e("td",[t._v("✅")]),t._v(" "),e("td",[t._v("✅")])]),t._v(" "),e("tr",[e("td",[e("a",{attrs:{href:"https://zh-hans.reactjs.org/docs/concurrent-mode-patterns.html#suspenselist",target:"_blank",rel:"noopener noreferrer"}},[t._v("SuspenseList(opens new window)"),e("OutboundLink")],1)]),t._v(" "),e("td",[t._v("🚫")]),t._v(" "),e("td",[t._v("✅")]),t._v(" "),e("td",[t._v("✅")])]),t._v(" "),e("tr",[e("td",[t._v("Suspense SSR + Hydration")]),t._v(" "),e("td",[t._v("🚫")]),t._v(" "),e("td",[t._v("✅")]),t._v(" "),e("td",[t._v("✅")])]),t._v(" "),e("tr",[e("td",[t._v("Progressive Hydration")]),t._v(" "),e("td",[t._v("🚫")]),t._v(" "),e("td",[t._v("✅")]),t._v(" "),e("td",[t._v("✅")])]),t._v(" "),e("tr",[e("td",[t._v("Selective Hydration")]),t._v(" "),e("td",[t._v("🚫")]),t._v(" "),e("td",[t._v("🚫")]),t._v(" "),e("td",[t._v("✅")])]),t._v(" "),e("tr",[e("td",[t._v("Cooperative Multitasking")]),t._v(" "),e("td",[t._v("🚫")]),t._v(" "),e("td",[t._v("🚫")]),t._v(" "),e("td",[t._v("✅")])]),t._v(" "),e("tr",[e("td",[t._v("Automatic batching of multiple setStates")]),t._v(" "),e("td",[t._v("🚫*")]),t._v(" "),e("td",[t._v("✅")]),t._v(" "),e("td",[t._v("✅")])]),t._v(" "),e("tr",[e("td",[e("a",{attrs:{href:"https://zh-hans.reactjs.org/docs/concurrent-mode-patterns.html#splitting-high-and-low-priority-state",target:"_blank",rel:"noopener noreferrer"}},[t._v("Priority-based Rendering(opens new window)"),e("OutboundLink")],1)]),t._v(" "),e("td",[t._v("🚫")]),t._v(" "),e("td",[t._v("🚫")]),t._v(" "),e("td",[t._v("✅")])]),t._v(" "),e("tr",[e("td",[e("a",{attrs:{href:"https://zh-hans.reactjs.org/docs/concurrent-mode-intro.html#interruptible-rendering",target:"_blank",rel:"noopener noreferrer"}},[t._v("Interruptible Prerendering(opens new window)"),e("OutboundLink")],1)]),t._v(" "),e("td",[t._v("🚫")]),t._v(" "),e("td",[t._v("🚫")]),t._v(" "),e("td",[t._v("✅")])]),t._v(" "),e("tr",[e("td",[e("a",{attrs:{href:"https://zh-hans.reactjs.org/docs/concurrent-mode-patterns.html#transitions",target:"_blank",rel:"noopener noreferrer"}},[t._v("useTransition(opens new window)"),e("OutboundLink")],1)]),t._v(" "),e("td",[t._v("🚫")]),t._v(" "),e("td",[t._v("🚫")]),t._v(" "),e("td",[t._v("✅")])]),t._v(" "),e("tr",[e("td",[e("a",{attrs:{href:"https://zh-hans.reactjs.org/docs/concurrent-mode-patterns.html#deferring-a-value",target:"_blank",rel:"noopener noreferrer"}},[t._v("useDeferredValue(opens new window)"),e("OutboundLink")],1)]),t._v(" "),e("td",[t._v("🚫")]),t._v(" "),e("td",[t._v("🚫")]),t._v(" "),e("td",[t._v("✅")])]),t._v(" "),e("tr",[e("td",[e("a",{attrs:{href:"https://zh-hans.reactjs.org/docs/concurrent-mode-patterns.html#suspense-reveal-train",target:"_blank",rel:"noopener noreferrer"}},[t._v('Suspense Reveal "Train"(opens new window)'),e("OutboundLink")],1)]),t._v(" "),e("td",[t._v("🚫")]),t._v(" "),e("td",[t._v("🚫")]),t._v(" "),e("td",[t._v("✅")])])])]),t._v(" "),e("p",[t._v("*："),e("code",[t._v("legacy")]),t._v("模式在合成事件中有自动批处理的功能，但仅限于一个浏览器任务。非"),e("code",[t._v("React")]),t._v("事件想使用这个功能必须使用 "),e("code",[t._v("unstable_batchedUpdates")]),t._v("。在"),e("code",[t._v("blocking")]),t._v("模式和"),e("code",[t._v("concurrent")]),t._v("模式下，所有的"),e("code",[t._v("setState")]),t._v("在默认情况下都是批处理的。")]),t._v(" "),e("p",[t._v("**：会在开发中发出警告。")]),t._v(" "),e("p",[t._v("模式的变化影响整个应用的工作方式，所以无法只针对某个组件开启不同模式。")]),t._v(" "),e("p",[t._v("基于此原因，可以通过不同的"),e("code",[t._v("入口函数")]),t._v("开启不同模式：")]),t._v(" "),e("ul",[e("li",[e("code",[t._v("legacy")]),t._v(" -- "),e("code",[t._v("ReactDOM.render(<App />, rootNode)")])]),t._v(" "),e("li",[e("code",[t._v("blocking")]),t._v(" -- "),e("code",[t._v("ReactDOM.createBlockingRoot(rootNode).render(<App />)")])]),t._v(" "),e("li",[e("code",[t._v("concurrent")]),t._v(" -- "),e("code",[t._v("ReactDOM.createRoot(rootNode).render(<App />)")])])]),t._v(" "),e("blockquote",[e("p",[t._v("你可以在"),e("a",{attrs:{href:"https://zh-hans.reactjs.org/docs/concurrent-mode-adoption.html#why-so-many-modes",target:"_blank",rel:"noopener noreferrer"}},[t._v("这里 (opens new window)"),e("OutboundLink")],1),t._v("看到"),e("code",[t._v("React")]),t._v("团队解释为什么会有这么多模式")])]),t._v(" "),e("p",[t._v("虽然不同模式的"),e("code",[t._v("入口函数")]),t._v("不同，但是他们仅对"),e("code",[t._v("fiber.mode")]),t._v("变量产生影响，对我们在"),e("a",{attrs:{href:"https://react.iamkasong.com/state/reactdom.html#%E6%B5%81%E7%A8%8B%E6%A6%82%E8%A7%88",target:"_blank",rel:"noopener noreferrer"}},[t._v("流程概览"),e("OutboundLink")],1),t._v("中描述的流程并无影响。")]),t._v(" "),e("p",[t._v("当我们有了前面知识的铺垫，就很容易理解"),e("code",[t._v("this.setState")]),t._v("的工作流程。")]),t._v(" "),e("h2",{attrs:{id:"流程概览-2"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#流程概览-2"}},[t._v("#")]),t._v(" "),e("a",{attrs:{href:"https://react.iamkasong.com/state/setstate.html#%E6%B5%81%E7%A8%8B%E6%A6%82%E8%A7%88",target:"_blank",rel:"noopener noreferrer"}},[t._v("#"),e("OutboundLink")],1),t._v("流程概览")]),t._v(" "),e("p",[t._v("可以看到，"),e("code",[t._v("this.setState")]),t._v("内会调用"),e("code",[t._v("this.updater.enqueueSetState")]),t._v("方法。")]),t._v(" "),e("div",{staticClass:"language-js extra-class"},[e("pre",{pre:!0,attrs:{class:"language-js"}},[e("code",[e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Component")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("prototype"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("setState")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("partialState"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" callback")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("typeof")]),t._v(" partialState "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'object'")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("typeof")]),t._v(" partialState "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'function'")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v(" partialState "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("throw")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("Error")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"setState(...): takes an object of state variables to update or a function which returns an object of state variables."')]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("updater"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("enqueueSetState")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" partialState"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" callback"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'setState'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),e("blockquote",[e("p",[t._v("你可以在"),e("a",{attrs:{href:"https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react/src/ReactBaseClasses.js#L57",target:"_blank",rel:"noopener noreferrer"}},[t._v("这里 (opens new window)"),e("OutboundLink")],1),t._v("看到这段代码")])]),t._v(" "),e("p",[t._v("在"),e("code",[t._v("enqueueSetState")]),t._v("方法中就是我们熟悉的从"),e("code",[t._v("创建update")]),t._v("到"),e("code",[t._v("调度update")]),t._v("的流程了。")]),t._v(" "),e("div",{staticClass:"language-js extra-class"},[e("pre",{pre:!0,attrs:{class:"language-js"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("enqueueSetState")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("inst"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" payload"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" callback")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 通过组件实例获取对应fiber")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" fiber "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("getInstance")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("inst"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" eventTime "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("requestEventTime")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" suspenseConfig "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("requestCurrentSuspenseConfig")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 获取优先级")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" lane "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("requestUpdateLane")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("fiber"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" suspenseConfig"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 创建update")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" update "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("createUpdate")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("eventTime"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" lane"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" suspenseConfig"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  update"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("payload "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" payload"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 赋值回调函数")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("callback "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!==")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("undefined")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" callback "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!==")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    update"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("callback "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" callback"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n  "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 将update插入updateQueue")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("enqueueUpdate")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("fiber"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" update"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 调度update")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("scheduleUpdateOnFiber")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("fiber"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" lane"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" eventTime"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),e("blockquote",[e("p",[t._v("你可以在"),e("a",{attrs:{href:"https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactFiberClassComponent.old.js#L196",target:"_blank",rel:"noopener noreferrer"}},[t._v("这里 (opens new window)"),e("OutboundLink")],1),t._v("看到"),e("code",[t._v("enqueueSetState")]),t._v("代码")])]),t._v(" "),e("p",[t._v("这里值得注意的是对于"),e("code",[t._v("ClassComponent")]),t._v("，"),e("code",[t._v("update.payload")]),t._v("为"),e("code",[t._v("this.setState")]),t._v("的第一个传参（即要改变的"),e("code",[t._v("state")]),t._v("）。")]),t._v(" "),e("h2",{attrs:{id:"this-forceupdate"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#this-forceupdate"}},[t._v("#")]),t._v(" "),e("a",{attrs:{href:"https://react.iamkasong.com/state/setstate.html#this-forceupdate",target:"_blank",rel:"noopener noreferrer"}},[t._v("#"),e("OutboundLink")],1),t._v("this.forceUpdate")]),t._v(" "),e("p",[t._v("在"),e("code",[t._v("this.updater")]),t._v("上，除了"),e("code",[t._v("enqueueSetState")]),t._v("外，还存在"),e("code",[t._v("enqueueForceUpdate")]),t._v("，当我们调用"),e("code",[t._v("this.forceUpdate")]),t._v("时会调用他。")]),t._v(" "),e("p",[t._v("可以看到，除了赋值"),e("code",[t._v("update.tag = ForceUpdate;")]),t._v("以及没有"),e("code",[t._v("payload")]),t._v("外，其他逻辑与"),e("code",[t._v("this.setState")]),t._v("一致。")]),t._v(" "),e("div",{staticClass:"language-js extra-class"},[e("pre",{pre:!0,attrs:{class:"language-js"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("enqueueForceUpdate")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("inst"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" callback")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" fiber "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("getInstance")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("inst"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" eventTime "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("requestEventTime")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" suspenseConfig "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("requestCurrentSuspenseConfig")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" lane "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("requestUpdateLane")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("fiber"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" suspenseConfig"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" update "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("createUpdate")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("eventTime"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" lane"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" suspenseConfig"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 赋值tag为ForceUpdate")]),t._v("\n    update"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("tag "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" ForceUpdate"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("callback "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!==")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("undefined")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" callback "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!==")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      update"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("callback "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" callback"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("enqueueUpdate")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("fiber"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" update"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("scheduleUpdateOnFiber")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("fiber"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" lane"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" eventTime"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),e("blockquote",[e("p",[t._v("你可以在"),e("a",{attrs:{href:"https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactFiberClassComponent.old.js#L260",target:"_blank",rel:"noopener noreferrer"}},[t._v("这里 (opens new window)"),e("OutboundLink")],1),t._v("看到"),e("code",[t._v("enqueueForceUpdate")]),t._v("代码")])]),t._v(" "),e("p",[t._v("那么赋值"),e("code",[t._v("update.tag = ForceUpdate;")]),t._v("有何作用呢？")]),t._v(" "),e("p",[t._v("在判断"),e("code",[t._v("ClassComponent")]),t._v("是否需要更新时有两个条件需要满足：")]),t._v(" "),e("div",{staticClass:"language-js extra-class"},[e("pre",{pre:!0,attrs:{class:"language-js"}},[e("code",[t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" shouldUpdate "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("checkHasForceUpdateAfterProcessing")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("checkShouldComponentUpdate")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n    workInProgress"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    ctor"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    oldProps"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    newProps"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    oldState"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    newState"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    nextContext"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),e("blockquote",[e("p",[t._v("你可以在"),e("a",{attrs:{href:"https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactFiberClassComponent.old.js#L1137",target:"_blank",rel:"noopener noreferrer"}},[t._v("这里 (opens new window)"),e("OutboundLink")],1),t._v("看到这段代码")])]),t._v(" "),e("ul",[e("li",[t._v("checkHasForceUpdateAfterProcessing：内部会判断本次更新的"),e("code",[t._v("Update")]),t._v("是否为"),e("code",[t._v("ForceUpdate")]),t._v("。即如果本次更新的"),e("code",[t._v("Update")]),t._v("中存在"),e("code",[t._v("tag")]),t._v("为"),e("code",[t._v("ForceUpdate")]),t._v("，则返回"),e("code",[t._v("true")]),t._v("。")]),t._v(" "),e("li",[t._v("checkShouldComponentUpdate：内部会调用"),e("code",[t._v("shouldComponentUpdate")]),t._v("方法。以及当该"),e("code",[t._v("ClassComponent")]),t._v("为"),e("code",[t._v("PureComponent")]),t._v("时会浅比较"),e("code",[t._v("state")]),t._v("与"),e("code",[t._v("props")]),t._v("。")])]),t._v(" "),e("blockquote",[e("p",[t._v("你可以在"),e("a",{attrs:{href:"https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactFiberClassComponent.old.js#L294",target:"_blank",rel:"noopener noreferrer"}},[t._v("这里 (opens new window)"),e("OutboundLink")],1),t._v("看到"),e("code",[t._v("checkShouldComponentUpdate")]),t._v("代码")])]),t._v(" "),e("p",[t._v("所以，当某次更新含有"),e("code",[t._v("tag")]),t._v("为"),e("code",[t._v("ForceUpdate")]),t._v("的"),e("code",[t._v("Update")]),t._v("，那么当前"),e("code",[t._v("ClassComponent")]),t._v("不会受其他"),e("code",[t._v("性能优化手段")]),t._v("（"),e("code",[t._v("shouldComponentUpdate")]),t._v("|"),e("code",[t._v("PureComponent")]),t._v("）影响，一定会更新。")]),t._v(" "),e("h2",{attrs:{id:"总结"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[t._v("#")]),t._v(" "),e("a",{attrs:{href:"https://react.iamkasong.com/state/setstate.html#%E6%80%BB%E7%BB%93",target:"_blank",rel:"noopener noreferrer"}},[t._v("#"),e("OutboundLink")],1),t._v("总结")]),t._v(" "),e("p",[t._v("至此，我们学习完了"),e("code",[t._v("HostRoot | ClassComponent")]),t._v("所使用的"),e("code",[t._v("Update")]),t._v("的更新流程。")]),t._v(" "),e("p",[t._v("在下一章我们会学习另一种数据结构的"),e("code",[t._v("Update")]),t._v(" —— 用于"),e("code",[t._v("Hooks")]),t._v("的"),e("code",[t._v("Update")]),t._v("。")])])}),[],!1,null,null,null);a.default=n.exports}}]);