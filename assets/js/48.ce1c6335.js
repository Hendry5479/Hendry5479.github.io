(window.webpackJsonp=window.webpackJsonp||[]).push([[48],{392:function(t,a,s){"use strict";s.r(a);var e=s(45),n=Object(e.a)({},(function(){var t=this,a=t.$createElement,s=t._self._c||a;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h2",{attrs:{id:"dispatcher"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#dispatcher"}},[t._v("#")]),t._v(" dispatcher")]),t._v(" "),s("p",[t._v("在上一节的极简"),s("code",[t._v("useState")]),t._v("实现中，使用"),s("code",[t._v("isMount")]),t._v("变量区分"),s("code",[t._v("mount")]),t._v("与"),s("code",[t._v("update")]),t._v("。")]),t._v(" "),s("p",[t._v("在真实的"),s("code",[t._v("Hooks")]),t._v("中，组件"),s("code",[t._v("mount")]),t._v("时的"),s("code",[t._v("hook")]),t._v("与"),s("code",[t._v("update")]),t._v("时的"),s("code",[t._v("hook")]),t._v("来源于不同的对象，这类对象在源码中被称为"),s("code",[t._v("dispatcher")]),t._v("。")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// mount时的Dispatcher")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" HooksDispatcherOnMount"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Dispatcher "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  useCallback"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" mountCallback"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  useContext"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" readContext"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  useEffect"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" mountEffect"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  useImperativeHandle"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" mountImperativeHandle"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  useLayoutEffect"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" mountLayoutEffect"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  useMemo"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" mountMemo"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  useReducer"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" mountReducer"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  useRef"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" mountRef"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  useState"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" mountState"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...省略")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// update时的Dispatcher")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" HooksDispatcherOnUpdate"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Dispatcher "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  useCallback"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" updateCallback"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  useContext"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" readContext"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  useEffect"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" updateEffect"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  useImperativeHandle"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" updateImperativeHandle"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  useLayoutEffect"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" updateLayoutEffect"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  useMemo"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" updateMemo"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  useReducer"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" updateReducer"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  useRef"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" updateRef"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  useState"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" updateState"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...省略")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("p",[t._v("可见，"),s("code",[t._v("mount")]),t._v("时调用的"),s("code",[t._v("hook")]),t._v("和"),s("code",[t._v("update")]),t._v("时调用的"),s("code",[t._v("hook")]),t._v("其实是两个不同的函数。")]),t._v(" "),s("p",[t._v("在"),s("code",[t._v("FunctionComponent")]),t._v(" "),s("code",[t._v("render")]),t._v("前，会根据"),s("code",[t._v("FunctionComponent")]),t._v("对应"),s("code",[t._v("fiber")]),t._v("的以下条件区分"),s("code",[t._v("mount")]),t._v("与"),s("code",[t._v("update")]),t._v("。")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[t._v("current "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v(" current"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("memoizedState "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),t._v("\n")])])]),s("p",[t._v("并将不同情况对应的"),s("code",[t._v("dispatcher")]),t._v("赋值给全局变量"),s("code",[t._v("ReactCurrentDispatcher")]),t._v("的"),s("code",[t._v("current")]),t._v("属性。")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[t._v("ReactCurrentDispatcher"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("current "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("\n      current "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v(" current"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("memoizedState "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),t._v(" HooksDispatcherOnMount\n        "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" HooksDispatcherOnUpdate"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("  \n")])])]),s("blockquote",[s("p",[t._v("你可以在"),s("a",{attrs:{href:"https://github.com/acdlite/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactFiberHooks.new.js#L409",target:"_blank",rel:"noopener noreferrer"}},[t._v("这里 (opens new window)"),s("OutboundLink")],1),t._v("看到这行代码")])]),t._v(" "),s("p",[t._v("在"),s("code",[t._v("FunctionComponent")]),t._v(" "),s("code",[t._v("render")]),t._v("时，会从"),s("code",[t._v("ReactCurrentDispatcher.current")]),t._v("（即当前"),s("code",[t._v("dispatcher")]),t._v("）中寻找需要的"),s("code",[t._v("hook")]),t._v("。")]),t._v(" "),s("p",[t._v("换言之，不同的调用栈上下文为"),s("code",[t._v("ReactCurrentDispatcher.current")]),t._v("赋值不同的"),s("code",[t._v("dispatcher")]),t._v("，则"),s("code",[t._v("FunctionComponent")]),t._v(" "),s("code",[t._v("render")]),t._v("时调用的"),s("code",[t._v("hook")]),t._v("也是不同的函数。")]),t._v(" "),s("blockquote",[s("p",[t._v("除了这两个"),s("code",[t._v("dispatcher")]),t._v("，你可以在"),s("a",{attrs:{href:"https://github.com/acdlite/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactFiberHooks.new.js#L1775",target:"_blank",rel:"noopener noreferrer"}},[t._v("这里 (opens new window)"),s("OutboundLink")],1),t._v("看到其他"),s("code",[t._v("dispatcher")]),t._v("定义")])]),t._v(" "),s("h2",{attrs:{id:"一个dispatcher使用场景"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#一个dispatcher使用场景"}},[t._v("#")]),t._v(" "),s("a",{attrs:{href:"https://react.iamkasong.com/hooks/structure.html#%E4%B8%80%E4%B8%AAdispatcher%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF",target:"_blank",rel:"noopener noreferrer"}},[t._v("#"),s("OutboundLink")],1),t._v("一个dispatcher使用场景")]),t._v(" "),s("p",[t._v("当错误的书写了嵌套形式的"),s("code",[t._v("hook")]),t._v("，如：")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("useEffect")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("useState")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),s("p",[t._v("此时"),s("code",[t._v("ReactCurrentDispatcher.current")]),t._v("已经指向"),s("code",[t._v("ContextOnlyDispatcher")]),t._v("，所以调用"),s("code",[t._v("useState")]),t._v("实际会调用"),s("code",[t._v("throwInvalidHookError")]),t._v("，直接抛出异常。")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" ContextOnlyDispatcher"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Dispatcher "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  useCallback"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" throwInvalidHookError"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  useContext"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" throwInvalidHookError"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  useEffect"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" throwInvalidHookError"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  useImperativeHandle"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" throwInvalidHookError"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  useLayoutEffect"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" throwInvalidHookError"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...省略")]),t._v("\n")])])]),s("blockquote",[s("p",[t._v("你可以在"),s("a",{attrs:{href:"https://github.com/acdlite/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactFiberHooks.new.js#L458",target:"_blank",rel:"noopener noreferrer"}},[t._v("这里 (opens new window)"),s("OutboundLink")],1),t._v("看到这段逻辑")])]),t._v(" "),s("h2",{attrs:{id:"hook的数据结构"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#hook的数据结构"}},[t._v("#")]),t._v(" "),s("a",{attrs:{href:"https://react.iamkasong.com/hooks/structure.html#hook%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84",target:"_blank",rel:"noopener noreferrer"}},[t._v("#"),s("OutboundLink")],1),t._v("Hook的数据结构")]),t._v(" "),s("p",[t._v("接下来我们学习"),s("code",[t._v("hook")]),t._v("的数据结构。")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" hook"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Hook "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  memoizedState"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\n  baseState"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  baseQueue"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  queue"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\n  next"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("blockquote",[s("p",[t._v("你可以在"),s("a",{attrs:{href:"https://github.com/acdlite/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactFiberHooks.new.js#L546",target:"_blank",rel:"noopener noreferrer"}},[t._v("这里 (opens new window)"),s("OutboundLink")],1),t._v("看到创建"),s("code",[t._v("hook")]),t._v("的逻辑")])]),t._v(" "),s("p",[t._v("其中除"),s("code",[t._v("memoizedState")]),t._v("以外字段的意义与上一章介绍的"),s("a",{attrs:{href:"https://react.iamkasong.com/state/update.html#updatequeue",target:"_blank",rel:"noopener noreferrer"}},[t._v("updateQueue"),s("OutboundLink")],1),t._v("类似。")]),t._v(" "),s("h2",{attrs:{id:"memoizedstate"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#memoizedstate"}},[t._v("#")]),t._v(" "),s("a",{attrs:{href:"https://react.iamkasong.com/hooks/structure.html#memoizedstate",target:"_blank",rel:"noopener noreferrer"}},[t._v("#"),s("OutboundLink")],1),t._v("memoizedState")]),t._v(" "),s("p",[t._v("注意")]),t._v(" "),s("p",[s("code",[t._v("hook")]),t._v("与"),s("code",[t._v("FunctionComponent fiber")]),t._v("都存在"),s("code",[t._v("memoizedState")]),t._v("属性，不要混淆他们的概念。")]),t._v(" "),s("ul",[s("li",[s("code",[t._v("fiber.memoizedState")]),t._v("："),s("code",[t._v("FunctionComponent")]),t._v("对应"),s("code",[t._v("fiber")]),t._v("保存的"),s("code",[t._v("Hooks")]),t._v("链表。")]),t._v(" "),s("li",[s("code",[t._v("hook.memoizedState")]),t._v("："),s("code",[t._v("Hooks")]),t._v("链表中保存的单一"),s("code",[t._v("hook")]),t._v("对应的数据。")])]),t._v(" "),s("p",[t._v("不同类型"),s("code",[t._v("hook")]),t._v("的"),s("code",[t._v("memoizedState")]),t._v("保存不同类型数据，具体如下：")]),t._v(" "),s("ul",[s("li",[t._v("useState：对于"),s("code",[t._v("const [state, updateState] = useState(initialState)")]),t._v("，"),s("code",[t._v("memoizedState")]),t._v("保存"),s("code",[t._v("state")]),t._v("的值")]),t._v(" "),s("li",[t._v("useReducer：对于"),s("code",[t._v("const [state, dispatch] = useReducer(reducer, {});")]),t._v("，"),s("code",[t._v("memoizedState")]),t._v("保存"),s("code",[t._v("state")]),t._v("的值")]),t._v(" "),s("li",[t._v("useEffect："),s("code",[t._v("memoizedState")]),t._v("保存包含"),s("code",[t._v("useEffect回调函数")]),t._v("、"),s("code",[t._v("依赖项")]),t._v("等的链表数据结构"),s("code",[t._v("effect")]),t._v("，你可以在"),s("a",{attrs:{href:"https://github.com/acdlite/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactFiberHooks.new.js#L1181",target:"_blank",rel:"noopener noreferrer"}},[t._v("这里 (opens new window)"),s("OutboundLink")],1),t._v("看到"),s("code",[t._v("effect")]),t._v("的创建过程。"),s("code",[t._v("effect")]),t._v("链表同时会保存在"),s("code",[t._v("fiber.updateQueue")]),t._v("中")]),t._v(" "),s("li",[t._v("useRef：对于"),s("code",[t._v("useRef(1)")]),t._v("，"),s("code",[t._v("memoizedState")]),t._v("保存"),s("code",[t._v("{current: 1}")])]),t._v(" "),s("li",[t._v("useMemo：对于"),s("code",[t._v("useMemo(callback, [depA])")]),t._v("，"),s("code",[t._v("memoizedState")]),t._v("保存"),s("code",[t._v("[callback(), depA]")])]),t._v(" "),s("li",[t._v("useCallback：对于"),s("code",[t._v("useCallback(callback, [depA])")]),t._v("，"),s("code",[t._v("memoizedState")]),t._v("保存"),s("code",[t._v("[callback, depA]")]),t._v("。与"),s("code",[t._v("useMemo")]),t._v("的区别是，"),s("code",[t._v("useCallback")]),t._v("保存的是"),s("code",[t._v("callback")]),t._v("函数本身，而"),s("code",[t._v("useMemo")]),t._v("保存的是"),s("code",[t._v("callback")]),t._v("函数的执行结果")])]),t._v(" "),s("p",[t._v("有些"),s("code",[t._v("hook")]),t._v("是没有"),s("code",[t._v("memoizedState")]),t._v("的，比如：")]),t._v(" "),s("ul",[s("li",[t._v("useContext")])]),t._v(" "),s("p",[s("code",[t._v("Redux")]),t._v("的作者"),s("code",[t._v("Dan")]),t._v("加入"),s("code",[t._v("React")]),t._v("核心团队后的一大贡献就是“将"),s("code",[t._v("Redux")]),t._v("的理念带入"),s("code",[t._v("React")]),t._v("”。")]),t._v(" "),s("p",[t._v("这里面最显而易见的影响莫过于"),s("code",[t._v("useState")]),t._v("与"),s("code",[t._v("useReducer")]),t._v("这两个"),s("code",[t._v("Hook")]),t._v("。本质来说，"),s("code",[t._v("useState")]),t._v("只是预置了"),s("code",[t._v("reducer")]),t._v("的"),s("code",[t._v("useReducer")]),t._v("。")]),t._v(" "),s("p",[t._v("本节我们来学习"),s("code",[t._v("useState")]),t._v("与"),s("code",[t._v("useReducer")]),t._v("的实现。")]),t._v(" "),s("h2",{attrs:{id:"流程概览"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#流程概览"}},[t._v("#")]),t._v(" "),s("a",{attrs:{href:"https://react.iamkasong.com/hooks/usestate.html#%E6%B5%81%E7%A8%8B%E6%A6%82%E8%A7%88",target:"_blank",rel:"noopener noreferrer"}},[t._v("#"),s("OutboundLink")],1),t._v("流程概览")]),t._v(" "),s("p",[t._v("我们将这两个"),s("code",[t._v("Hook")]),t._v("的工作流程分为"),s("code",[t._v("声明阶段")]),t._v("和"),s("code",[t._v("调用阶段")]),t._v("，对于：")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("App")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("state"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" dispatch"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("useReducer")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("reducer"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("a"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("num"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" updateNum"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("useState")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  \n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("div"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("button onClick"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("dispatch")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("type"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'a'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("state"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("a"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("button"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("  \n      "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("button onClick"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("updateNum")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("num")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" num "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("num"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("button"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("  \n    "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("div"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[s("code",[t._v("声明阶段")]),t._v("即"),s("code",[t._v("App")]),t._v("调用时，会依次执行"),s("code",[t._v("useReducer")]),t._v("与"),s("code",[t._v("useState")]),t._v("方法。")]),t._v(" "),s("p",[s("code",[t._v("调用阶段")]),t._v("即点击按钮后，"),s("code",[t._v("dispatch")]),t._v("或"),s("code",[t._v("updateNum")]),t._v("被调用时。")]),t._v(" "),s("h2",{attrs:{id:"声明阶段"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#声明阶段"}},[t._v("#")]),t._v(" "),s("a",{attrs:{href:"https://react.iamkasong.com/hooks/usestate.html#%E5%A3%B0%E6%98%8E%E9%98%B6%E6%AE%B5",target:"_blank",rel:"noopener noreferrer"}},[t._v("#"),s("OutboundLink")],1),t._v("声明阶段")]),t._v(" "),s("p",[t._v("当"),s("code",[t._v("FunctionComponent")]),t._v("进入"),s("code",[t._v("render阶段")]),t._v("的"),s("code",[t._v("beginWork")]),t._v("时，会调用"),s("a",{attrs:{href:"https://github.com/acdlite/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactFiberBeginWork.new.js#L1419",target:"_blank",rel:"noopener noreferrer"}},[t._v("renderWithHooks (opens new window)"),s("OutboundLink")],1),t._v("方法。")]),t._v(" "),s("p",[t._v("该方法内部会执行"),s("code",[t._v("FunctionComponent")]),t._v("对应函数（即"),s("code",[t._v("fiber.type")]),t._v("）。")]),t._v(" "),s("blockquote",[s("p",[t._v("你可以在"),s("a",{attrs:{href:"https://github.com/acdlite/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactFiberHooks.new.js#L415",target:"_blank",rel:"noopener noreferrer"}},[t._v("这里 (opens new window)"),s("OutboundLink")],1),t._v("看到这段逻辑")])]),t._v(" "),s("p",[t._v("对于这两个"),s("code",[t._v("Hook")]),t._v("，他们的源码如下：")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("useState")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("initialState")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" dispatcher "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("resolveDispatcher")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" dispatcher"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("useState")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("initialState"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("useReducer")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("reducer"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" initialArg"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" init")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" dispatcher "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("resolveDispatcher")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" dispatcher"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("useReducer")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("reducer"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" initialArg"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" init"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[t._v("正如上一节"),s("a",{attrs:{href:"https://react.iamkasong.com/hooks/structure.html#dispatcher",target:"_blank",rel:"noopener noreferrer"}},[t._v("dispatcher"),s("OutboundLink")],1),t._v("所说，在不同场景下，同一个"),s("code",[t._v("Hook")]),t._v("会调用不同处理函数。")]),t._v(" "),s("p",[t._v("我们分别讲解"),s("code",[t._v("mount")]),t._v("与"),s("code",[t._v("update")]),t._v("两个场景。")]),t._v(" "),s("h3",{attrs:{id:"mount时"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#mount时"}},[t._v("#")]),t._v(" "),s("a",{attrs:{href:"https://react.iamkasong.com/hooks/usestate.html#mount%E6%97%B6",target:"_blank",rel:"noopener noreferrer"}},[t._v("#"),s("OutboundLink")],1),t._v("mount时")]),t._v(" "),s("p",[s("code",[t._v("mount")]),t._v("时，"),s("code",[t._v("useReducer")]),t._v("会调用"),s("a",{attrs:{href:"https://github.com/acdlite/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactFiberHooks.new.js#L638",target:"_blank",rel:"noopener noreferrer"}},[t._v("mountReducer (opens new window)"),s("OutboundLink")],1),t._v("，"),s("code",[t._v("useState")]),t._v("会调用"),s("a",{attrs:{href:"https://github.com/acdlite/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactFiberHooks.new.js#L1143",target:"_blank",rel:"noopener noreferrer"}},[t._v("mountState (opens new window)"),s("OutboundLink")],1),t._v("。")]),t._v(" "),s("p",[t._v("我们来简单对比这这两个方法：")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" mountState"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("S")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n  initialState"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("S")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("S")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("S")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" Dispatch"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("BasicStateAction"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("S")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 创建并返回当前的hook")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" hook "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("mountWorkInProgressHook")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...赋值初始state")]),t._v("\n\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 创建queue")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" queue "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("hook"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("queue "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    pending"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    dispatch"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    lastRenderedReducer"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" basicStateReducer"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    lastRenderedState"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("initialState"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" any"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...创建dispatch")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("hook"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("memoizedState"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" dispatch"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" mountReducer"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("S")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("I")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("A")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("reducer")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("S")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("A")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("S")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  initialArg"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("I")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  init"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token parameter"}},[s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("I")])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("S")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("S")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" Dispatch"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("A")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 创建并返回当前的hook")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" hook "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("mountWorkInProgressHook")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...赋值初始state")]),t._v("\n\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 创建queue")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" queue "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("hook"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("queue "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    pending"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    dispatch"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    lastRenderedReducer"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" reducer"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    lastRenderedState"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("initialState"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" any"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...创建dispatch")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("hook"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("memoizedState"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" dispatch"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[t._v("其中"),s("code",[t._v("mountWorkInProgressHook")]),t._v("方法会创建并返回对应"),s("code",[t._v("hook")]),t._v("，对应"),s("code",[t._v("极简Hooks实现")]),t._v("中"),s("code",[t._v("useState")]),t._v("方法的"),s("code",[t._v("isMount")]),t._v("逻辑部分。")]),t._v(" "),s("p",[t._v("可以看到，"),s("code",[t._v("mount")]),t._v("时这两个"),s("code",[t._v("Hook")]),t._v("的唯一区别为"),s("code",[t._v("queue")]),t._v("参数的"),s("code",[t._v("lastRenderedReducer")]),t._v("字段。")]),t._v(" "),s("p",[s("code",[t._v("queue")]),t._v("的数据结构如下：")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" queue "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("hook"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("queue "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 与极简实现中的同名字段意义相同，保存update对象")]),t._v("\n  pending"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 保存dispatchAction.bind()的值")]),t._v("\n  dispatch"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 上一次render时使用的reducer")]),t._v("\n  lastRenderedReducer"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" reducer"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 上一次render时的state")]),t._v("\n  lastRenderedState"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("initialState"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" any"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("p",[t._v("其中，"),s("code",[t._v("useReducer")]),t._v("的"),s("code",[t._v("lastRenderedReducer")]),t._v("为传入的"),s("code",[t._v("reducer")]),t._v("参数。"),s("code",[t._v("useState")]),t._v("的"),s("code",[t._v("lastRenderedReducer")]),t._v("为"),s("code",[t._v("basicStateReducer")]),t._v("。")]),t._v(" "),s("p",[s("code",[t._v("basicStateReducer")]),t._v("方法如下：")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" basicStateReducer"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("S")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("state"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("S")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" action"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" BasicStateAction"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("S")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("S")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("typeof")]),t._v(" action "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'function'")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("action")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("state"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" action"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[t._v("可见，"),s("code",[t._v("useState")]),t._v("即"),s("code",[t._v("reducer")]),t._v("参数为"),s("code",[t._v("basicStateReducer")]),t._v("的"),s("code",[t._v("useReducer")]),t._v("。")]),t._v(" "),s("p",[s("code",[t._v("mount")]),t._v("时的整体运行逻辑与"),s("code",[t._v("极简实现")]),t._v("的"),s("code",[t._v("isMount")]),t._v("逻辑类似，你可以对照着看。")]),t._v(" "),s("h3",{attrs:{id:"update时"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#update时"}},[t._v("#")]),t._v(" "),s("a",{attrs:{href:"https://react.iamkasong.com/hooks/usestate.html#update%E6%97%B6",target:"_blank",rel:"noopener noreferrer"}},[t._v("#"),s("OutboundLink")],1),t._v("update时")]),t._v(" "),s("p",[t._v("如果说"),s("code",[t._v("mount")]),t._v("时这两者还有区别，那"),s("code",[t._v("update")]),t._v("时，"),s("code",[t._v("useReducer")]),t._v("与"),s("code",[t._v("useState")]),t._v("调用的则是同一个函数"),s("a",{attrs:{href:"https://github.com/acdlite/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactFiberHooks.new.js#L665",target:"_blank",rel:"noopener noreferrer"}},[t._v("updateReducer (opens new window)"),s("OutboundLink")],1),t._v("。")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" updateReducer"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("S")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("I")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("A")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("reducer")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("S")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("A")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("S")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  initialArg"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("I")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  init"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token parameter"}},[s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("I")])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("S")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("S")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" Dispatch"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("A")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 获取当前hook")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" hook "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("updateWorkInProgressHook")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" queue "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" hook"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("queue"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  \n  queue"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("lastRenderedReducer "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" reducer"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...同update与updateQueue类似的更新逻辑")]),t._v("\n\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" dispatch"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Dispatch"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("A")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("queue"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("dispatch"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" any"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("hook"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("memoizedState"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" dispatch"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[t._v("整个流程可以概括为一句话：")]),t._v(" "),s("blockquote",[s("p",[t._v("找到对应的"),s("code",[t._v("hook")]),t._v("，根据"),s("code",[t._v("update")]),t._v("计算该"),s("code",[t._v("hook")]),t._v("的新"),s("code",[t._v("state")]),t._v("并返回。")])]),t._v(" "),s("p",[s("code",[t._v("mount")]),t._v("时获取当前"),s("code",[t._v("hook")]),t._v("使用的是"),s("code",[t._v("mountWorkInProgressHook")]),t._v("，而"),s("code",[t._v("update")]),t._v("时使用的是"),s("code",[t._v("updateWorkInProgressHook")]),t._v("，这里的原因是：")]),t._v(" "),s("ul",[s("li",[s("code",[t._v("mount")]),t._v("时可以确定是调用"),s("code",[t._v("ReactDOM.render")]),t._v("或相关初始化"),s("code",[t._v("API")]),t._v("产生的"),s("code",[t._v("更新")]),t._v("，只会执行一次。")]),t._v(" "),s("li",[s("code",[t._v("update")]),t._v("可能是在事件回调或副作用中触发的"),s("code",[t._v("更新")]),t._v("或者是"),s("code",[t._v("render阶段")]),t._v("触发的"),s("code",[t._v("更新")]),t._v("，为了避免组件无限循环"),s("code",[t._v("更新")]),t._v("，后者需要区别对待。")])]),t._v(" "),s("p",[t._v("举个"),s("code",[t._v("render阶段")]),t._v("触发的"),s("code",[t._v("更新")]),t._v("的例子：")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("App")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("num"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" updateNum"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("useState")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  \n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("updateNum")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("num "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("button onClick"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("updateNum")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("num")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" num "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("num"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("button"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("  \n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[t._v("在这个例子中，"),s("code",[t._v("App")]),t._v("调用时，代表已经进入"),s("code",[t._v("render阶段")]),t._v("执行"),s("code",[t._v("renderWithHooks")]),t._v("。")]),t._v(" "),s("p",[t._v("在"),s("code",[t._v("App")]),t._v("内部，调用"),s("code",[t._v("updateNum")]),t._v("会触发一次"),s("code",[t._v("更新")]),t._v("。如果不对这种情况下触发的更新作出限制，那么这次"),s("code",[t._v("更新")]),t._v("会开启一次新的"),s("code",[t._v("render阶段")]),t._v("，最终会无限循环更新。")]),t._v(" "),s("p",[t._v("基于这个原因，"),s("code",[t._v("React")]),t._v("用一个标记变量"),s("code",[t._v("didScheduleRenderPhaseUpdate")]),t._v("判断是否是"),s("code",[t._v("render阶段")]),t._v("触发的更新。")]),t._v(" "),s("p",[s("code",[t._v("updateWorkInProgressHook")]),t._v("方法也会区分这两种情况来获取对应"),s("code",[t._v("hook")]),t._v("。")]),t._v(" "),s("p",[t._v("获取对应"),s("code",[t._v("hook")]),t._v("，接下来会根据"),s("code",[t._v("hook")]),t._v("中保存的"),s("code",[t._v("state")]),t._v("计算新的"),s("code",[t._v("state")]),t._v("，这个步骤同"),s("a",{attrs:{href:"https://react.iamkasong.com/state/update.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("Update一节"),s("OutboundLink")],1),t._v("一致。")]),t._v(" "),s("h2",{attrs:{id:"调用阶段"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#调用阶段"}},[t._v("#")]),t._v(" "),s("a",{attrs:{href:"https://react.iamkasong.com/hooks/usestate.html#%E8%B0%83%E7%94%A8%E9%98%B6%E6%AE%B5",target:"_blank",rel:"noopener noreferrer"}},[t._v("#"),s("OutboundLink")],1),t._v("调用阶段")]),t._v(" "),s("p",[t._v("调用阶段会执行"),s("a",{attrs:{href:"https://github.com/acdlite/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactFiberHooks.new.js#L1662",target:"_blank",rel:"noopener noreferrer"}},[t._v("dispatchAction (opens new window)"),s("OutboundLink")],1),t._v("，此时该"),s("code",[t._v("FunctionComponent")]),t._v("对应的"),s("code",[t._v("fiber")]),t._v("以及"),s("code",[t._v("hook.queue")]),t._v("已经通过调用"),s("code",[t._v("bind")]),t._v("方法预先作为参数传入。")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("dispatchAction")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("fiber"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" queue"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" action")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...创建update")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" update "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    eventTime"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" eventTime"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    lane"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" lane"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    suspenseConfig"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" suspenseConfig"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    action"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" action"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    eagerReducer"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    eagerState"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    next"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" \n\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...将update加入queue.pending")]),t._v("\n  \n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" alternate "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" fiber"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("alternate"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("fiber "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" currentlyRenderingFiber$"),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v(" alternate "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!==")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" alternate "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" currentlyRenderingFiber$"),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// render阶段触发的更新")]),t._v("\n    didScheduleRenderPhaseUpdateDuringThisPass "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" didScheduleRenderPhaseUpdate "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("fiber"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("lanes "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" NoLanes "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("alternate "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v(" alternate"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("lanes "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" NoLanes"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...fiber的updateQueue为空，优化路径")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("scheduleUpdateOnFiber")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("fiber"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" lane"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" eventTime"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[t._v("整个过程可以概括为：")]),t._v(" "),s("blockquote",[s("p",[t._v("创建"),s("code",[t._v("update")]),t._v("，将"),s("code",[t._v("update")]),t._v("加入"),s("code",[t._v("queue.pending")]),t._v("中，并开启调度。")])]),t._v(" "),s("p",[t._v("这里值得注意的是"),s("code",[t._v("if...else...")]),t._v("逻辑，其中：")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("fiber "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" currentlyRenderingFiber$"),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v(" alternate "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!==")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" alternate "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" currentlyRenderingFiber$"),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),s("p",[s("code",[t._v("currentlyRenderingFiber")]),t._v("即"),s("code",[t._v("workInProgress")]),t._v("，"),s("code",[t._v("workInProgress")]),t._v("存在代表当前处于"),s("code",[t._v("render阶段")]),t._v("。")]),t._v(" "),s("p",[t._v("触发"),s("code",[t._v("更新")]),t._v("时通过"),s("code",[t._v("bind")]),t._v("预先保存的"),s("code",[t._v("fiber")]),t._v("与"),s("code",[t._v("workInProgress")]),t._v("全等，代表本次"),s("code",[t._v("更新")]),t._v("发生于"),s("code",[t._v("FunctionComponent")]),t._v("对应"),s("code",[t._v("fiber")]),t._v("的"),s("code",[t._v("render阶段")]),t._v("。")]),t._v(" "),s("p",[t._v("所以这是一个"),s("code",[t._v("render阶段")]),t._v("触发的"),s("code",[t._v("更新")]),t._v("，需要标记变量"),s("code",[t._v("didScheduleRenderPhaseUpdate")]),t._v("，后续单独处理。")]),t._v(" "),s("p",[t._v("再来关注：")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("fiber"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("lanes "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" NoLanes "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("alternate "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v(" alternate"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("lanes "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" NoLanes"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),s("p",[s("code",[t._v("fiber.lanes")]),t._v("保存"),s("code",[t._v("fiber")]),t._v("上存在的"),s("code",[t._v("update")]),t._v("的"),s("code",[t._v("优先级")]),t._v("。")]),t._v(" "),s("p",[s("code",[t._v("fiber.lanes === NoLanes")]),t._v("意味着"),s("code",[t._v("fiber")]),t._v("上不存在"),s("code",[t._v("update")]),t._v("。")]),t._v(" "),s("p",[t._v("我们已经知道，通过"),s("code",[t._v("update")]),t._v("计算"),s("code",[t._v("state")]),t._v("发生在"),s("code",[t._v("声明阶段")]),t._v("，这是因为该"),s("code",[t._v("hook")]),t._v("上可能存在多个不同"),s("code",[t._v("优先级")]),t._v("的"),s("code",[t._v("update")]),t._v("，最终"),s("code",[t._v("state")]),t._v("的值由多个"),s("code",[t._v("update")]),t._v("共同决定。")]),t._v(" "),s("p",[t._v("但是当"),s("code",[t._v("fiber")]),t._v("上不存在"),s("code",[t._v("update")]),t._v("，则"),s("code",[t._v("调用阶段")]),t._v("创建的"),s("code",[t._v("update")]),t._v("为该"),s("code",[t._v("hook")]),t._v("上第一个"),s("code",[t._v("update")]),t._v("，在"),s("code",[t._v("声明阶段")]),t._v("计算"),s("code",[t._v("state")]),t._v("时也只依赖于该"),s("code",[t._v("update")]),t._v("，完全不需要进入"),s("code",[t._v("声明阶段")]),t._v("再计算"),s("code",[t._v("state")]),t._v("。")]),t._v(" "),s("p",[t._v("这样做的好处是：如果计算出的"),s("code",[t._v("state")]),t._v("与该"),s("code",[t._v("hook")]),t._v("之前保存的"),s("code",[t._v("state")]),t._v("一致，那么完全不需要开启一次调度。即使计算出的"),s("code",[t._v("state")]),t._v("与该"),s("code",[t._v("hook")]),t._v("之前保存的"),s("code",[t._v("state")]),t._v("不一致，在"),s("code",[t._v("声明阶段")]),t._v("也可以直接使用"),s("code",[t._v("调用阶段")]),t._v("已经计算出的"),s("code",[t._v("state")]),t._v("。")]),t._v(" "),s("blockquote",[s("p",[t._v("你可以在"),s("a",{attrs:{href:"https://github.com/acdlite/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactFiberHooks.new.js#L1727",target:"_blank",rel:"noopener noreferrer"}},[t._v("这里 (opens new window)"),s("OutboundLink")],1),t._v("看到这段提前计算"),s("code",[t._v("state")]),t._v("的逻辑")])]),t._v(" "),s("h2",{attrs:{id:"小tip"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#小tip"}},[t._v("#")]),t._v(" "),s("a",{attrs:{href:"https://react.iamkasong.com/hooks/usestate.html#%E5%B0%8Ftip",target:"_blank",rel:"noopener noreferrer"}},[t._v("#"),s("OutboundLink")],1),t._v("小Tip")]),t._v(" "),s("p",[t._v("我们通常认为，"),s("code",[t._v("useReducer(reducer, initialState)")]),t._v("的传参为初始化参数，在以后的调用中都不可变。")]),t._v(" "),s("p",[t._v("但是在"),s("code",[t._v("updateReducer")]),t._v("方法中，可以看到"),s("code",[t._v("lastRenderedReducer")]),t._v("在每次调用时都会重新赋值。")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("updateReducer")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("reducer"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" initialArg"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" init")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...")]),t._v("\n\n  queue"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("lastRenderedReducer "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" reducer"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...")]),t._v("\n")])])]),s("p",[t._v("也就是说，"),s("code",[t._v("reducer")]),t._v("参数是随时可变的。")]),t._v(" "),s("details",{staticClass:"custom-block details",staticStyle:{display:"block",position:"relative","border-radius":"2px",margin:"1.6em 0px",padding:"1.6em","background-color":"rgb(238, 238, 238)"}},[s("summary",{staticStyle:{outline:"none",cursor:"pointer"}},[t._v("reducer可变Demo")])])])}),[],!1,null,null,null);a.default=n.exports}}]);