(window.webpackJsonp=window.webpackJsonp||[]).push([[45],{389:function(e,t,a){"use strict";a.r(t);var s=a(45),v=Object(s.a)({},(function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[a("h2",{attrs:{id:"几个关键节点"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#几个关键节点"}},[e._v("#")]),e._v(" 几个关键节点")]),e._v(" "),a("p",[e._v("在开始学习前，我们先了解源码中几个关键节点（即几个关键函数的调用）。通过这章的学习，我们会将这些关键节点的调用路径串起来。")]),e._v(" "),a("p",[e._v("先从我们所熟知的概念开始。")]),e._v(" "),a("h3",{attrs:{id:"render阶段的开始"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#render阶段的开始"}},[e._v("#")]),e._v(" render阶段的开始")]),e._v(" "),a("p",[e._v("我们在"),a("a",{attrs:{href:"https://react.iamkasong.com/process/reconciler.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("render阶段流程概览一节"),a("OutboundLink")],1),e._v("讲到，")]),e._v(" "),a("p",[a("code",[e._v("render阶段")]),e._v("开始于"),a("code",[e._v("performSyncWorkOnRoot")]),e._v("或"),a("code",[e._v("performConcurrentWorkOnRoot")]),e._v("方法的调用。这取决于本次更新是同步更新还是异步更新。")]),e._v(" "),a("h3",{attrs:{id:"commit阶段的开始"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#commit阶段的开始"}},[e._v("#")]),e._v(" commit阶段的开始")]),e._v(" "),a("p",[e._v("我们在"),a("a",{attrs:{href:"https://react.iamkasong.com/renderer/prepare.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("commit阶段流程概览一节"),a("OutboundLink")],1),e._v("讲到，")]),e._v(" "),a("p",[a("code",[e._v("commit阶段")]),e._v("开始于"),a("code",[e._v("commitRoot")]),e._v("方法的调用。其中"),a("code",[e._v("rootFiber")]),e._v("会作为传参。")]),e._v(" "),a("p",[e._v("我们已经知道，"),a("code",[e._v("render阶段")]),e._v("完成后会进入"),a("code",[e._v("commit阶段")]),e._v("。让我们继续补全从"),a("code",[e._v("触发状态更新")]),e._v("到"),a("code",[e._v("render阶段")]),e._v("的路径。")]),e._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[e._v("触发状态更新（根据场景调用不同方法）\n\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("|")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("|")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("v")]),e._v("\n\n    ？\n\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("|")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("|")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("v")]),e._v("\n\nrender阶段（"),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[e._v("`")]),e._v("performSyncWorkOnRoot"),a("span",{pre:!0,attrs:{class:"token variable"}},[e._v("`")])]),e._v(" 或 "),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[e._v("`")]),e._v("performConcurrentWorkOnRoot"),a("span",{pre:!0,attrs:{class:"token variable"}},[e._v("`")])]),e._v("）\n\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("|")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("|")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("v")]),e._v("\n\ncommit阶段（"),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[e._v("`")]),e._v("commitRoot"),a("span",{pre:!0,attrs:{class:"token variable"}},[e._v("`")])]),e._v("）\n")])])]),a("h3",{attrs:{id:"创建update对象"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#创建update对象"}},[e._v("#")]),e._v(" 创建Update对象")]),e._v(" "),a("p",[e._v("在"),a("code",[e._v("React")]),e._v("中，有如下方法可以触发状态更新（排除"),a("code",[e._v("SSR")]),e._v("相关）：")]),e._v(" "),a("ul",[a("li",[e._v("ReactDOM.render")]),e._v(" "),a("li",[e._v("this.setState")]),e._v(" "),a("li",[e._v("this.forceUpdate")]),e._v(" "),a("li",[e._v("useState")]),e._v(" "),a("li",[e._v("useReducer")])]),e._v(" "),a("p",[e._v("这些方法调用的场景各不相同，他们是如何接入同一套"),a("strong",[e._v("状态更新机制")]),e._v("呢？")]),e._v(" "),a("p",[e._v("答案是：每次"),a("code",[e._v("状态更新")]),e._v("都会创建一个保存"),a("strong",[e._v("更新状态相关内容")]),e._v("的对象，我们叫他"),a("code",[e._v("Update")]),e._v("。在"),a("code",[e._v("render阶段")]),e._v("的"),a("code",[e._v("beginWork")]),e._v("中会根据"),a("code",[e._v("Update")]),e._v("计算新的"),a("code",[e._v("state")]),e._v("。")]),e._v(" "),a("p",[e._v("我们会在下一节详细讲解"),a("code",[e._v("Update")]),e._v("。")]),e._v(" "),a("h3",{attrs:{id:"从fiber到root"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#从fiber到root"}},[e._v("#")]),e._v(" 从fiber到root")]),e._v(" "),a("p",[e._v("现在"),a("code",[e._v("触发状态更新的fiber")]),e._v("上已经包含"),a("code",[e._v("Update")]),e._v("对象。")]),e._v(" "),a("p",[e._v("我们知道，"),a("code",[e._v("render阶段")]),e._v("是从"),a("code",[e._v("rootFiber")]),e._v("开始向下遍历。那么如何从"),a("code",[e._v("触发状态更新的fiber")]),e._v("得到"),a("code",[e._v("rootFiber")]),e._v("呢？")]),e._v(" "),a("p",[e._v("答案是：调用"),a("code",[e._v("markUpdateLaneFromFiberToRoot")]),e._v("方法。")]),e._v(" "),a("blockquote",[a("p",[e._v("你可以从"),a("a",{attrs:{href:"https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactFiberWorkLoop.new.js#L636",target:"_blank",rel:"noopener noreferrer"}},[e._v("这里 (opens new window)"),a("OutboundLink")],1),e._v("看到"),a("code",[e._v("markUpdateLaneFromFiberToRoot")]),e._v("的源码")])]),e._v(" "),a("p",[e._v("该方法做的工作可以概括为：从"),a("code",[e._v("触发状态更新的fiber")]),e._v("一直向上遍历到"),a("code",[e._v("rootFiber")]),e._v("，并返回"),a("code",[e._v("rootFiber")]),e._v("。")]),e._v(" "),a("p",[e._v("由于不同更新优先级不尽相同，所以过程中还会更新遍历到的"),a("code",[e._v("fiber")]),e._v("的优先级。这对于我们当前属于超纲内容。")]),e._v(" "),a("h3",{attrs:{id:"调度更新"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#调度更新"}},[e._v("#")]),e._v(" 调度更新")]),e._v(" "),a("p",[e._v("现在我们拥有一个"),a("code",[e._v("rootFiber")]),e._v("，该"),a("code",[e._v("rootFiber")]),e._v("对应的"),a("code",[e._v("Fiber树")]),e._v("中某个"),a("code",[e._v("Fiber节点")]),e._v("包含一个"),a("code",[e._v("Update")]),e._v("。")]),e._v(" "),a("p",[e._v("接下来通知"),a("code",[e._v("Scheduler")]),e._v("根据"),a("strong",[e._v("更新")]),e._v("的优先级，决定以"),a("strong",[e._v("同步")]),e._v("还是"),a("strong",[e._v("异步")]),e._v("的方式调度本次更新。")]),e._v(" "),a("p",[e._v("这里调用的方法是"),a("code",[e._v("ensureRootIsScheduled")]),e._v("。")]),e._v(" "),a("p",[e._v("以下是"),a("code",[e._v("ensureRootIsScheduled")]),e._v("最核心的一段代码：")]),e._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("if")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("newCallbackPriority "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("===")]),e._v(" SyncLanePriority"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// 任务已经过期，需要同步执行render阶段")]),e._v("\n  newCallbackNode "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("scheduleSyncCallback")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("performSyncWorkOnRoot")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("bind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" root"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("else")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// 根据任务优先级异步执行render阶段")]),e._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("var")]),e._v(" schedulerPriorityLevel "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("lanePriorityToSchedulerPriority")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("\n    newCallbackPriority\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n  newCallbackNode "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("scheduleCallback")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("\n    schedulerPriorityLevel"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("performConcurrentWorkOnRoot")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("bind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" root"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n")])])]),a("blockquote",[a("p",[e._v("你可以从"),a("a",{attrs:{href:"https://github.com/facebook/react/blob/b6df4417c79c11cfb44f965fab55b573882b1d54/packages/react-reconciler/src/ReactFiberWorkLoop.new.js#L602",target:"_blank",rel:"noopener noreferrer"}},[e._v("这里 (opens new window)"),a("OutboundLink")],1),e._v("看到"),a("code",[e._v("ensureRootIsScheduled")]),e._v("的源码")])]),e._v(" "),a("p",[e._v("其中，"),a("code",[e._v("scheduleCallback")]),e._v("和"),a("code",[e._v("scheduleSyncCallback")]),e._v("会调用"),a("code",[e._v("Scheduler")]),e._v("提供的调度方法根据"),a("code",[e._v("优先级")]),e._v("调度回调函数执行。")]),e._v(" "),a("p",[e._v("可以看到，这里调度的回调函数为：")]),e._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[e._v("performSyncWorkOnRoot")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("bind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" root"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("performConcurrentWorkOnRoot")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("bind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" root"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n")])])]),a("p",[e._v("即"),a("code",[e._v("render阶段")]),e._v("的入口函数。")]),e._v(" "),a("p",[e._v("至此，"),a("code",[e._v("状态更新")]),e._v("就和我们所熟知的"),a("code",[e._v("render阶段")]),e._v("连接上了。")]),e._v(" "),a("h2",{attrs:{id:"总结"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[e._v("#")]),e._v(" 总结")]),e._v(" "),a("p",[e._v("让我们梳理下"),a("code",[e._v("状态更新")]),e._v("的整个调用路径的关键节点：")]),e._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[e._v("触发状态更新（根据场景调用不同方法）\n\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("|")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("|")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("v")]),e._v("\n\n创建Update对象（接下来三节详解）\n\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("|")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("|")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("v")]),e._v("\n\n从fiber到root（"),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[e._v("`")]),e._v("markUpdateLaneFromFiberToRoot"),a("span",{pre:!0,attrs:{class:"token variable"}},[e._v("`")])]),e._v("）\n\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("|")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("|")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("v")]),e._v("\n\n调度更新（"),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[e._v("`")]),e._v("ensureRootIsScheduled"),a("span",{pre:!0,attrs:{class:"token variable"}},[e._v("`")])]),e._v("）\n\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("|")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("|")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("v")]),e._v("\n\nrender阶段（"),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[e._v("`")]),e._v("performSyncWorkOnRoot"),a("span",{pre:!0,attrs:{class:"token variable"}},[e._v("`")])]),e._v(" 或 "),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[e._v("`")]),e._v("performConcurrentWorkOnRoot"),a("span",{pre:!0,attrs:{class:"token variable"}},[e._v("`")])]),e._v("）\n\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("|")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("|")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("v")]),e._v("\n\ncommit阶段（"),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[e._v("`")]),e._v("commitRoot"),a("span",{pre:!0,attrs:{class:"token variable"}},[e._v("`")])]),e._v("）\n")])])]),a("h2",{attrs:{id:""}},[a("a",{staticClass:"header-anchor",attrs:{href:"#"}},[e._v("#")])]),e._v(" "),a("p",[e._v("本节我们了解了"),a("strong",[e._v("状态更新")]),e._v("的整个流程。")]),e._v(" "),a("p",[e._v("在接下来三节中，我们会花大量篇幅讲解"),a("code",[e._v("Update")]),e._v("的工作机制，因为他是构成"),a("code",[e._v("React concurrent mode")]),e._v("的核心机制之一。")]),e._v(" "),a("p",[e._v("在深入源码前，让我们先建立"),a("code",[e._v("更新机制")]),e._v("的"),a("code",[e._v("心智模型")]),e._v("。")]),e._v(" "),a("p",[e._v("在后面两节讲解源码时，我们会将代码与"),a("code",[e._v("心智模型")]),e._v("联系上，方便你更好理解。")]),e._v(" "),a("h2",{attrs:{id:"同步更新的react"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#同步更新的react"}},[e._v("#")]),e._v(" 同步更新的React")]),e._v(" "),a("p",[e._v("我们可以将"),a("code",[e._v("更新机制")]),e._v("类比"),a("code",[e._v("代码版本控制")]),e._v("。")]),e._v(" "),a("p",[e._v("在没有"),a("code",[e._v("代码版本控制")]),e._v("前，我们在代码中逐步叠加功能。一切看起来井然有序，直到我们遇到了一个紧急线上bug（红色节点）。")]),e._v(" "),a("p",[a("img",{attrs:{src:"https://react.iamkasong.com/img/git1.png",alt:"流程1"}})]),e._v(" "),a("p",[e._v("为了修复这个bug，我们需要首先将之前的代码提交。")]),e._v(" "),a("p",[e._v("在"),a("code",[e._v("React")]),e._v("中，所有通过"),a("code",[e._v("ReactDOM.render")]),e._v("创建的应用（其他创建应用的方式参考"),a("a",{attrs:{href:"https://react.iamkasong.com/state/reactdom.html#react%E7%9A%84%E5%85%B6%E4%BB%96%E5%85%A5%E5%8F%A3%E5%87%BD%E6%95%B0",target:"_blank",rel:"noopener noreferrer"}},[e._v("ReactDOM.render一节"),a("OutboundLink")],1),e._v("）都是通过类似的方式"),a("code",[e._v("更新状态")]),e._v("。")]),e._v(" "),a("p",[e._v("即没有"),a("code",[e._v("优先级")]),e._v("概念，"),a("code",[e._v("高优更新")]),e._v("（红色节点）需要排在其他"),a("code",[e._v("更新")]),e._v("后面执行。")]),e._v(" "),a("h2",{attrs:{id:"并发更新的react"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#并发更新的react"}},[e._v("#")]),e._v(" "),a("a",{attrs:{href:"https://react.iamkasong.com/state/mental.html#%E5%B9%B6%E5%8F%91%E6%9B%B4%E6%96%B0%E7%9A%84react",target:"_blank",rel:"noopener noreferrer"}},[e._v("#"),a("OutboundLink")],1),e._v("并发更新的React")]),e._v(" "),a("p",[e._v("当有了"),a("code",[e._v("代码版本控制")]),e._v("，有紧急线上bug需要修复时，我们暂存当前分支的修改，在"),a("code",[e._v("master分支")]),e._v("修复bug并紧急上线。")]),e._v(" "),a("p",[a("img",{attrs:{src:"https://react.iamkasong.com/img/git2.png",alt:"流程2"}})]),e._v(" "),a("p",[e._v("bug修复上线后通过"),a("code",[e._v("git rebase")]),e._v("命令和"),a("code",[e._v("开发分支")]),e._v("连接上。"),a("code",[e._v("开发分支")]),e._v("基于"),a("code",[e._v("修复bug的版本")]),e._v("继续开发。")]),e._v(" "),a("p",[a("img",{attrs:{src:"https://react.iamkasong.com/img/git3.png",alt:"流程3"}})]),e._v(" "),a("p",[e._v("在"),a("code",[e._v("React")]),e._v("中，通过"),a("code",[e._v("ReactDOM.createBlockingRoot")]),e._v("和"),a("code",[e._v("ReactDOM.createRoot")]),e._v("创建的应用会采用"),a("code",[e._v("并发")]),e._v("的方式"),a("code",[e._v("更新状态")]),e._v("。")]),e._v(" "),a("p",[a("code",[e._v("高优更新")]),e._v("（红色节点）中断正在进行中的"),a("code",[e._v("低优更新")]),e._v("（蓝色节点），先完成"),a("code",[e._v("render - commit流程")]),e._v("。")]),e._v(" "),a("p",[e._v("待"),a("code",[e._v("高优更新")]),e._v("完成后，"),a("code",[e._v("低优更新")]),e._v("基于"),a("code",[e._v("高优更新")]),e._v("的结果"),a("code",[e._v("重新更新")]),e._v("。")]),e._v(" "),a("p",[e._v("接下来两节我们会从源码角度讲解这套"),a("code",[e._v("并发更新")]),e._v("是如何实现的。")]),e._v(" "),a("blockquote",[a("p",[e._v("你可以将"),a("code",[e._v("Update")]),e._v("类比"),a("code",[e._v("心智模型")]),e._v("中的一次"),a("code",[e._v("commit")]),e._v("。")])]),e._v(" "),a("h2",{attrs:{id:"update的分类"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#update的分类"}},[e._v("#")]),e._v(" Update的分类")]),e._v(" "),a("p",[e._v("我们先来了解"),a("code",[e._v("Update")]),e._v("的结构。")]),e._v(" "),a("p",[e._v("首先，我们将可以触发更新的方法所隶属的组件分类：")]),e._v(" "),a("ul",[a("li",[e._v("ReactDOM.render —— HostRoot")]),e._v(" "),a("li",[e._v("this.setState —— ClassComponent")]),e._v(" "),a("li",[e._v("this.forceUpdate —— ClassComponent")]),e._v(" "),a("li",[e._v("useState —— FunctionComponent")]),e._v(" "),a("li",[e._v("useReducer —— FunctionComponent")])]),e._v(" "),a("p",[e._v("可以看到，一共三种组件（"),a("code",[e._v("HostRoot")]),e._v(" | "),a("code",[e._v("ClassComponent")]),e._v(" | "),a("code",[e._v("FunctionComponent")]),e._v("）可以触发更新。")]),e._v(" "),a("p",[e._v("由于不同类型组件工作方式不同，所以存在两种不同结构的"),a("code",[e._v("Update")]),e._v("，其中"),a("code",[e._v("ClassComponent")]),e._v("与"),a("code",[e._v("HostRoot")]),e._v("共用一套"),a("code",[e._v("Update")]),e._v("结构，"),a("code",[e._v("FunctionComponent")]),e._v("单独使用一种"),a("code",[e._v("Update")]),e._v("结构。")]),e._v(" "),a("p",[e._v("虽然他们的结构不同，但是他们工作机制与工作流程大体相同。在本节我们介绍前一种"),a("code",[e._v("Update")]),e._v("，"),a("code",[e._v("FunctionComponent")]),e._v("对应的"),a("code",[e._v("Update")]),e._v("在"),a("code",[e._v("Hooks")]),e._v("章节介绍。")]),e._v(" "),a("h2",{attrs:{id:"update的结构"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#update的结构"}},[e._v("#")]),e._v(" Update的结构")]),e._v(" "),a("p",[a("code",[e._v("ClassComponent")]),e._v("与"),a("code",[e._v("HostRoot")]),e._v("（即"),a("code",[e._v("rootFiber.tag")]),e._v("对应类型）共用同一种"),a("code",[e._v("Update结构")]),e._v("。")]),e._v(" "),a("p",[e._v("对应的结构如下：")]),e._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("const")]),e._v(" update"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" Update"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("<")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n  eventTime"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n  lane"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n  suspenseConfig"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n  tag"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" UpdateState"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n  payload"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n  callback"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n\n  next"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n")])])]),a("blockquote",[a("p",[a("code",[e._v("Update")]),e._v("由"),a("code",[e._v("createUpdate")]),e._v("方法返回，你可以从"),a("a",{attrs:{href:"https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactUpdateQueue.old.js#L189",target:"_blank",rel:"noopener noreferrer"}},[e._v("这里 (opens new window)"),a("OutboundLink")],1),e._v("看到"),a("code",[e._v("createUpdate")]),e._v("的源码")])]),e._v(" "),a("p",[e._v("字段意义如下：")]),e._v(" "),a("ul",[a("li",[e._v("eventTime：任务时间，通过"),a("code",[e._v("performance.now()")]),e._v("获取的毫秒数。由于该字段在未来会重构，当前我们不需要理解他。")]),e._v(" "),a("li",[e._v("lane：优先级相关字段。当前还不需要掌握他，只需要知道不同"),a("code",[e._v("Update")]),e._v("优先级可能是不同的。")])]),e._v(" "),a("blockquote",[a("p",[e._v("你可以将"),a("code",[e._v("lane")]),e._v("类比"),a("code",[e._v("心智模型")]),e._v("中"),a("code",[e._v("需求的紧急程度")]),e._v("。")])]),e._v(" "),a("ul",[a("li",[e._v("suspenseConfig："),a("code",[e._v("Suspense")]),e._v("相关，暂不关注。")]),e._v(" "),a("li",[e._v("tag：更新的类型，包括"),a("code",[e._v("UpdateState")]),e._v(" | "),a("code",[e._v("ReplaceState")]),e._v(" | "),a("code",[e._v("ForceUpdate")]),e._v(" | "),a("code",[e._v("CaptureUpdate")]),e._v("。")]),e._v(" "),a("li",[e._v("payload：更新挂载的数据，不同类型组件挂载的数据不同。对于"),a("code",[e._v("ClassComponent")]),e._v("，"),a("code",[e._v("payload")]),e._v("为"),a("code",[e._v("this.setState")]),e._v("的第一个传参。对于"),a("code",[e._v("HostRoot")]),e._v("，"),a("code",[e._v("payload")]),e._v("为"),a("code",[e._v("ReactDOM.render")]),e._v("的第一个传参。")]),e._v(" "),a("li",[e._v("callback：更新的回调函数。即在"),a("a",{attrs:{href:"https://react.iamkasong.com/renderer/layout.html#commitlayouteffectonfiber",target:"_blank",rel:"noopener noreferrer"}},[e._v("commit 阶段的 layout 子阶段一节"),a("OutboundLink")],1),e._v("中提到的"),a("code",[e._v("回调函数")]),e._v("。")]),e._v(" "),a("li",[e._v("next：与其他"),a("code",[e._v("Update")]),e._v("连接形成链表。")])]),e._v(" "),a("h2",{attrs:{id:"update与fiber的联系"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#update与fiber的联系"}},[e._v("#")]),e._v(" Update与Fiber的联系")]),e._v(" "),a("p",[e._v("我们发现，"),a("code",[e._v("Update")]),e._v("存在一个连接其他"),a("code",[e._v("Update")]),e._v("形成链表的字段"),a("code",[e._v("next")]),e._v("。联系"),a("code",[e._v("React")]),e._v("中另一种以链表形式组成的结构"),a("code",[e._v("Fiber")]),e._v("，他们之间有什么关联么？")]),e._v(" "),a("p",[e._v("答案是肯定的。")]),e._v(" "),a("p",[e._v("从"),a("a",{attrs:{href:"https://react.iamkasong.com/process/doubleBuffer.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("双缓存机制一节"),a("OutboundLink")],1),e._v("我们知道，"),a("code",[e._v("Fiber节点")]),e._v("组成"),a("code",[e._v("Fiber树")]),e._v("，页面中最多同时存在两棵"),a("code",[e._v("Fiber树")]),e._v("：")]),e._v(" "),a("ul",[a("li",[e._v("代表当前页面状态的"),a("code",[e._v("current Fiber树")])]),e._v(" "),a("li",[e._v("代表正在"),a("code",[e._v("render阶段")]),e._v("的"),a("code",[e._v("workInProgress Fiber树")])])]),e._v(" "),a("p",[e._v("类似"),a("code",[e._v("Fiber节点")]),e._v("组成"),a("code",[e._v("Fiber树")]),e._v("，"),a("code",[e._v("Fiber节点")]),e._v("上的多个"),a("code",[e._v("Update")]),e._v("会组成链表并被包含在"),a("code",[e._v("fiber.updateQueue")]),e._v("中。")]),e._v(" "),a("p",[e._v("什么情况下一个Fiber节点会存在多个Update？")]),e._v(" "),a("p",[e._v("你可能疑惑为什么一个"),a("code",[e._v("Fiber节点")]),e._v("会存在多个"),a("code",[e._v("Update")]),e._v("。这其实是很常见的情况。")]),e._v(" "),a("p",[e._v("在这里介绍一种最简单的情况：")]),e._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[e._v("onClick")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("setState")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    a"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("1")]),e._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v("\n\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("setState")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    b"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("2")]),e._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n")])])]),a("p",[e._v("在一个"),a("code",[e._v("ClassComponent")]),e._v("中触发"),a("code",[e._v("this.onClick")]),e._v("方法，方法内部调用了两次"),a("code",[e._v("this.setState")]),e._v("。这会在该"),a("code",[e._v("fiber")]),e._v("中产生两个"),a("code",[e._v("Update")]),e._v("。")]),e._v(" "),a("p",[a("code",[e._v("Fiber节点")]),e._v("最多同时存在两个"),a("code",[e._v("updateQueue")]),e._v("：")]),e._v(" "),a("ul",[a("li",[a("code",[e._v("current fiber")]),e._v("保存的"),a("code",[e._v("updateQueue")]),e._v("即"),a("code",[e._v("current updateQueue")])]),e._v(" "),a("li",[a("code",[e._v("workInProgress fiber")]),e._v("保存的"),a("code",[e._v("updateQueue")]),e._v("即"),a("code",[e._v("workInProgress updateQueue")])])]),e._v(" "),a("p",[e._v("在"),a("code",[e._v("commit阶段")]),e._v("完成页面渲染后，"),a("code",[e._v("workInProgress Fiber树")]),e._v("变为"),a("code",[e._v("current Fiber树")]),e._v("，"),a("code",[e._v("workInProgress Fiber树")]),e._v("内"),a("code",[e._v("Fiber节点")]),e._v("的"),a("code",[e._v("updateQueue")]),e._v("就变成"),a("code",[e._v("current updateQueue")]),e._v("。")]),e._v(" "),a("h2",{attrs:{id:"updatequeue"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#updatequeue"}},[e._v("#")]),e._v(" updateQueue")]),e._v(" "),a("p",[a("code",[e._v("updateQueue")]),e._v("有三种类型，其中针对"),a("code",[e._v("HostComponent")]),e._v("的类型我们在"),a("a",{attrs:{href:"https://react.iamkasong.com/process/completeWork.html#update%E6%97%B6",target:"_blank",rel:"noopener noreferrer"}},[e._v("completeWork一节"),a("OutboundLink")],1),e._v("介绍过。")]),e._v(" "),a("p",[e._v("剩下两种类型和"),a("code",[e._v("Update")]),e._v("的两种类型对应。")]),e._v(" "),a("p",[a("code",[e._v("ClassComponent")]),e._v("与"),a("code",[e._v("HostRoot")]),e._v("使用的"),a("code",[e._v("UpdateQueue")]),e._v("结构如下：")]),e._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("const")]),e._v(" queue"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" UpdateQueue"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("<")]),e._v("State"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    baseState"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" fiber"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("memoizedState"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n    firstBaseUpdate"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n    lastBaseUpdate"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n    shared"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n      pending"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n    effects"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n")])])]),a("blockquote",[a("p",[a("code",[e._v("UpdateQueue")]),e._v("由"),a("code",[e._v("initializeUpdateQueue")]),e._v("方法返回，你可以从"),a("a",{attrs:{href:"https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactUpdateQueue.new.js#L157",target:"_blank",rel:"noopener noreferrer"}},[e._v("这里 (opens new window)"),a("OutboundLink")],1),e._v("看到"),a("code",[e._v("initializeUpdateQueue")]),e._v("的源码")])]),e._v(" "),a("p",[e._v("字段说明如下：")]),e._v(" "),a("ul",[a("li",[e._v("baseState：本次更新前该"),a("code",[e._v("Fiber节点")]),e._v("的"),a("code",[e._v("state")]),e._v("，"),a("code",[e._v("Update")]),e._v("基于该"),a("code",[e._v("state")]),e._v("计算更新后的"),a("code",[e._v("state")]),e._v("。")])]),e._v(" "),a("blockquote",[a("p",[e._v("你可以将"),a("code",[e._v("baseState")]),e._v("类比"),a("code",[e._v("心智模型")]),e._v("中的"),a("code",[e._v("master分支")]),e._v("。")])]),e._v(" "),a("ul",[a("li",[a("code",[e._v("firstBaseUpdate")]),e._v("与"),a("code",[e._v("lastBaseUpdate")]),e._v("：本次更新前该"),a("code",[e._v("Fiber节点")]),e._v("已保存的"),a("code",[e._v("Update")]),e._v("。以链表形式存在，链表头为"),a("code",[e._v("firstBaseUpdate")]),e._v("，链表尾为"),a("code",[e._v("lastBaseUpdate")]),e._v("。之所以在更新产生前该"),a("code",[e._v("Fiber节点")]),e._v("内就存在"),a("code",[e._v("Update")]),e._v("，是由于某些"),a("code",[e._v("Update")]),e._v("优先级较低所以在上次"),a("code",[e._v("render阶段")]),e._v("由"),a("code",[e._v("Update")]),e._v("计算"),a("code",[e._v("state")]),e._v("时被跳过。")])]),e._v(" "),a("blockquote",[a("p",[e._v("你可以将"),a("code",[e._v("baseUpdate")]),e._v("类比"),a("code",[e._v("心智模型")]),e._v("中执行"),a("code",[e._v("git rebase")]),e._v("基于的"),a("code",[e._v("commit")]),e._v("（节点D）。")])]),e._v(" "),a("ul",[a("li",[a("code",[e._v("shared.pending")]),e._v("：触发更新时，产生的"),a("code",[e._v("Update")]),e._v("会保存在"),a("code",[e._v("shared.pending")]),e._v("中形成单向环状链表。当由"),a("code",[e._v("Update")]),e._v("计算"),a("code",[e._v("state")]),e._v("时这个环会被剪开并连接在"),a("code",[e._v("lastBaseUpdate")]),e._v("后面。")])]),e._v(" "),a("blockquote",[a("p",[e._v("你可以将"),a("code",[e._v("shared.pending")]),e._v("类比"),a("code",[e._v("心智模型")]),e._v("中本次需要提交的"),a("code",[e._v("commit")]),e._v("（节点ABC）。")])]),e._v(" "),a("ul",[a("li",[e._v("effects：数组。保存"),a("code",[e._v("update.callback !== null")]),e._v("的"),a("code",[e._v("Update")]),e._v("。")])]),e._v(" "),a("h2",{attrs:{id:"例子"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#例子"}},[e._v("#")]),e._v(" 例子")]),e._v(" "),a("p",[a("code",[e._v("updateQueue")]),e._v("相关代码逻辑涉及到大量链表操作，比较难懂。在此我们举例对"),a("code",[e._v("updateQueue")]),e._v("的工作流程讲解下。")]),e._v(" "),a("p",[e._v("假设有一个"),a("code",[e._v("fiber")]),e._v("刚经历"),a("code",[e._v("commit阶段")]),e._v("完成渲染。")]),e._v(" "),a("p",[e._v("该"),a("code",[e._v("fiber")]),e._v("上有两个由于优先级过低所以在上次的"),a("code",[e._v("render阶段")]),e._v("并没有处理的"),a("code",[e._v("Update")]),e._v("。他们会成为下次更新的"),a("code",[e._v("baseUpdate")]),e._v("。")]),e._v(" "),a("p",[e._v("我们称其为"),a("code",[e._v("u1")]),e._v("和"),a("code",[e._v("u2")]),e._v("，其中"),a("code",[e._v("u1.next === u2")]),e._v("。")]),e._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[e._v("fiber"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("updateQueue"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("firstBaseUpdate "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("===")]),e._v(" u1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\nfiber"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("updateQueue"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("lastBaseUpdate "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("===")]),e._v(" u2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\nu1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("next "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("===")]),e._v(" u2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n")])])]),a("p",[e._v("我们用"),a("code",[e._v("--\x3e")]),e._v("表示链表的指向：")]),e._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[e._v("fiber"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("updateQueue"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("baseUpdate"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" u1 "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("--")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v(" u2\n")])])]),a("p",[e._v("现在我们在"),a("code",[e._v("fiber")]),e._v("上触发两次状态更新，这会先后产生两个新的"),a("code",[e._v("Update")]),e._v("，我们称为"),a("code",[e._v("u3")]),e._v("和"),a("code",[e._v("u4")]),e._v("。")]),e._v(" "),a("p",[e._v("每个 "),a("code",[e._v("update")]),e._v(" 都会通过 "),a("code",[e._v("enqueueUpdate")]),e._v(" 方法插入到 "),a("code",[e._v("updateQueue")]),e._v(" 队列上")]),e._v(" "),a("p",[e._v("当插入"),a("code",[e._v("u3")]),e._v("后：")]),e._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[e._v("fiber"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("updateQueue"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("shared"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("pending "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("===")]),e._v(" u3"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\nu3"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("next "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("===")]),e._v(" u3"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n")])])]),a("p",[a("code",[e._v("shared.pending")]),e._v("的环状链表，用图表示为：")]),e._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[e._v("fiber"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("updateQueue"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("shared"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("pending"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v("   u3 ─────┐ \n                                     "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("^")]),e._v("      "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("|")]),e._v("                                    \n                                     └──────┘\n")])])]),a("p",[e._v("接着插入"),a("code",[e._v("u4")]),e._v("之后：")]),e._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[e._v("fiber"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("updateQueue"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("shared"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("pending "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("===")]),e._v(" u4"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\nu4"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("next "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("===")]),e._v(" u3"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\nu3"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("next "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("===")]),e._v(" u4"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n")])])]),a("p",[a("code",[e._v("shared.pending")]),e._v("是环状链表，用图表示为：")]),e._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[e._v("fiber"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("updateQueue"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("shared"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("pending"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v("   u4 ──"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v(" u3\n                                     "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("^")]),e._v("      "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("|")]),e._v("                                    \n                                     └──────┘\n")])])]),a("p",[a("code",[e._v("shared.pending")]),e._v(" 会保证始终指向最后一个插入的"),a("code",[e._v("update")]),e._v("，你可以在"),a("a",{attrs:{href:"https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactUpdateQueue.new.js#L208",target:"_blank",rel:"noopener noreferrer"}},[e._v("这里 (opens new window)"),a("OutboundLink")],1),e._v("看到"),a("code",[e._v("enqueueUpdate")]),e._v("的源码")]),e._v(" "),a("p",[e._v("更新调度完成后进入"),a("code",[e._v("render阶段")]),e._v("。")]),e._v(" "),a("p",[e._v("此时"),a("code",[e._v("shared.pending")]),e._v("的环被剪开并连接在"),a("code",[e._v("updateQueue.lastBaseUpdate")]),e._v("后面：")]),e._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[e._v("fiber"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("updateQueue"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("baseUpdate"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" u1 "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("--")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v(" u2 "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("--")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v(" u3 "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("--")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v(" u4\n")])])]),a("p",[e._v("接下来遍历"),a("code",[e._v("updateQueue.baseUpdate")]),e._v("链表，以"),a("code",[e._v("fiber.updateQueue.baseState")]),e._v("为"),a("code",[e._v("初始state")]),e._v("，依次与遍历到的每个"),a("code",[e._v("Update")]),e._v("计算并产生新的"),a("code",[e._v("state")]),e._v("（该操作类比"),a("code",[e._v("Array.prototype.reduce")]),e._v("）。")]),e._v(" "),a("p",[e._v("在遍历时如果有优先级低的"),a("code",[e._v("Update")]),e._v("会被跳过。")]),e._v(" "),a("p",[e._v("当遍历完成后获得的"),a("code",[e._v("state")]),e._v("，就是该"),a("code",[e._v("Fiber节点")]),e._v("在本次更新的"),a("code",[e._v("state")]),e._v("（源码中叫做"),a("code",[e._v("memoizedState")]),e._v("）。")]),e._v(" "),a("blockquote",[a("p",[a("code",[e._v("render阶段")]),e._v("的"),a("code",[e._v("Update操作")]),e._v("由"),a("code",[e._v("processUpdateQueue")]),e._v("完成，你可以从"),a("a",{attrs:{href:"https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactUpdateQueue.new.js#L405",target:"_blank",rel:"noopener noreferrer"}},[e._v("这里 (opens new window)"),a("OutboundLink")],1),e._v("看到"),a("code",[e._v("processUpdateQueue")]),e._v("的源码")])]),e._v(" "),a("p",[a("code",[e._v("state")]),e._v("的变化在"),a("code",[e._v("render阶段")]),e._v("产生与上次更新不同的"),a("code",[e._v("JSX")]),e._v("对象，通过"),a("code",[e._v("Diff算法")]),e._v("产生"),a("code",[e._v("effectTag")]),e._v("，在"),a("code",[e._v("commit阶段")]),e._v("渲染在页面上。")]),e._v(" "),a("p",[e._v("渲染完成后"),a("code",[e._v("workInProgress Fiber树")]),e._v("变为"),a("code",[e._v("current Fiber树")]),e._v("，整个更新流程结束。")])])}),[],!1,null,null,null);t.default=v.exports}}]);