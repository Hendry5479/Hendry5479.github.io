<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>事件原理 | 英俊的大亨亨</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="heng.png">
    <meta name="description" content="记录下有趣岁月的点点滴滴">
    
    <link rel="preload" href="/assets/css/0.styles.e4d8b86b.css" as="style"><link rel="preload" href="/assets/js/app.b51e4ccd.js" as="script"><link rel="preload" href="/assets/js/2.7229199a.js" as="script"><link rel="preload" href="/assets/js/56.3a62759d.js" as="script"><link rel="prefetch" href="/assets/js/10.00f8a9d8.js"><link rel="prefetch" href="/assets/js/100.78dfd44a.js"><link rel="prefetch" href="/assets/js/101.cdae98a0.js"><link rel="prefetch" href="/assets/js/102.6a3dd9e0.js"><link rel="prefetch" href="/assets/js/103.cfed07a2.js"><link rel="prefetch" href="/assets/js/104.a16a4843.js"><link rel="prefetch" href="/assets/js/105.9cd1add0.js"><link rel="prefetch" href="/assets/js/106.546c1ad8.js"><link rel="prefetch" href="/assets/js/107.04b38bf9.js"><link rel="prefetch" href="/assets/js/108.31a22b61.js"><link rel="prefetch" href="/assets/js/109.1f2a1840.js"><link rel="prefetch" href="/assets/js/11.e2689dc6.js"><link rel="prefetch" href="/assets/js/110.9dc2f13b.js"><link rel="prefetch" href="/assets/js/111.35cf70f8.js"><link rel="prefetch" href="/assets/js/112.39a6579b.js"><link rel="prefetch" href="/assets/js/113.cbfc279d.js"><link rel="prefetch" href="/assets/js/114.878470a2.js"><link rel="prefetch" href="/assets/js/115.86dc4d8e.js"><link rel="prefetch" href="/assets/js/116.d2e05b2c.js"><link rel="prefetch" href="/assets/js/117.7525671d.js"><link rel="prefetch" href="/assets/js/118.a5c04c6d.js"><link rel="prefetch" href="/assets/js/119.613a81e1.js"><link rel="prefetch" href="/assets/js/12.0b7aaea4.js"><link rel="prefetch" href="/assets/js/120.ec6d3159.js"><link rel="prefetch" href="/assets/js/121.6705f783.js"><link rel="prefetch" href="/assets/js/122.7b3fe034.js"><link rel="prefetch" href="/assets/js/123.9336f454.js"><link rel="prefetch" href="/assets/js/124.dca9fc87.js"><link rel="prefetch" href="/assets/js/125.338aa4d8.js"><link rel="prefetch" href="/assets/js/126.a731a9eb.js"><link rel="prefetch" href="/assets/js/127.da74dd90.js"><link rel="prefetch" href="/assets/js/128.3d5e86f2.js"><link rel="prefetch" href="/assets/js/129.ee43b65c.js"><link rel="prefetch" href="/assets/js/13.31064a46.js"><link rel="prefetch" href="/assets/js/130.8a273d75.js"><link rel="prefetch" href="/assets/js/131.a89df4ac.js"><link rel="prefetch" href="/assets/js/132.0daac28c.js"><link rel="prefetch" href="/assets/js/133.b1f23c92.js"><link rel="prefetch" href="/assets/js/134.78621a9c.js"><link rel="prefetch" href="/assets/js/135.f0884a8b.js"><link rel="prefetch" href="/assets/js/136.45114430.js"><link rel="prefetch" href="/assets/js/137.eb295fce.js"><link rel="prefetch" href="/assets/js/138.cc7dc8d3.js"><link rel="prefetch" href="/assets/js/139.c9b1aad6.js"><link rel="prefetch" href="/assets/js/14.0be4ee49.js"><link rel="prefetch" href="/assets/js/15.685fab30.js"><link rel="prefetch" href="/assets/js/16.97f8b16a.js"><link rel="prefetch" href="/assets/js/17.9c7bebeb.js"><link rel="prefetch" href="/assets/js/18.965d9e47.js"><link rel="prefetch" href="/assets/js/19.3d59a8e1.js"><link rel="prefetch" href="/assets/js/20.1573d510.js"><link rel="prefetch" href="/assets/js/21.f46234dd.js"><link rel="prefetch" href="/assets/js/22.6c16fd38.js"><link rel="prefetch" href="/assets/js/23.50a2a38a.js"><link rel="prefetch" href="/assets/js/24.8aff8273.js"><link rel="prefetch" href="/assets/js/25.35a7c496.js"><link rel="prefetch" href="/assets/js/26.af233874.js"><link rel="prefetch" href="/assets/js/27.a3a96a5a.js"><link rel="prefetch" href="/assets/js/28.a1d49602.js"><link rel="prefetch" href="/assets/js/29.174b7d7d.js"><link rel="prefetch" href="/assets/js/3.6038f64c.js"><link rel="prefetch" href="/assets/js/30.a4115d32.js"><link rel="prefetch" href="/assets/js/31.1522875a.js"><link rel="prefetch" href="/assets/js/32.35da527d.js"><link rel="prefetch" href="/assets/js/33.814d63e8.js"><link rel="prefetch" href="/assets/js/34.615b49c1.js"><link rel="prefetch" href="/assets/js/35.856ab789.js"><link rel="prefetch" href="/assets/js/36.2987bc62.js"><link rel="prefetch" href="/assets/js/37.084d12aa.js"><link rel="prefetch" href="/assets/js/38.088f3091.js"><link rel="prefetch" href="/assets/js/39.4ea066d5.js"><link rel="prefetch" href="/assets/js/4.c610d016.js"><link rel="prefetch" href="/assets/js/40.97850ba9.js"><link rel="prefetch" href="/assets/js/41.8b8ae086.js"><link rel="prefetch" href="/assets/js/42.8ae2cac3.js"><link rel="prefetch" href="/assets/js/43.f8a28187.js"><link rel="prefetch" href="/assets/js/44.5160f68a.js"><link rel="prefetch" href="/assets/js/45.6d4b7130.js"><link rel="prefetch" href="/assets/js/46.44693348.js"><link rel="prefetch" href="/assets/js/47.eb0ac18a.js"><link rel="prefetch" href="/assets/js/48.ce1c6335.js"><link rel="prefetch" href="/assets/js/49.7ec1b16a.js"><link rel="prefetch" href="/assets/js/5.216dfe20.js"><link rel="prefetch" href="/assets/js/50.1f503aa4.js"><link rel="prefetch" href="/assets/js/51.47971163.js"><link rel="prefetch" href="/assets/js/52.e5f681d7.js"><link rel="prefetch" href="/assets/js/53.df89fbb7.js"><link rel="prefetch" href="/assets/js/54.a140a8dd.js"><link rel="prefetch" href="/assets/js/55.5809711e.js"><link rel="prefetch" href="/assets/js/57.c9bd4339.js"><link rel="prefetch" href="/assets/js/58.acb475d1.js"><link rel="prefetch" href="/assets/js/59.61cf3322.js"><link rel="prefetch" href="/assets/js/6.73a8f323.js"><link rel="prefetch" href="/assets/js/60.aa39146e.js"><link rel="prefetch" href="/assets/js/61.f62972b8.js"><link rel="prefetch" href="/assets/js/62.79fc1ddc.js"><link rel="prefetch" href="/assets/js/63.808c750c.js"><link rel="prefetch" href="/assets/js/64.4e99e2e1.js"><link rel="prefetch" href="/assets/js/65.f112caec.js"><link rel="prefetch" href="/assets/js/66.422cc6c9.js"><link rel="prefetch" href="/assets/js/67.f504a803.js"><link rel="prefetch" href="/assets/js/68.f8e84a65.js"><link rel="prefetch" href="/assets/js/69.af07ae00.js"><link rel="prefetch" href="/assets/js/7.a6e60d89.js"><link rel="prefetch" href="/assets/js/70.9b212396.js"><link rel="prefetch" href="/assets/js/71.049b7d3e.js"><link rel="prefetch" href="/assets/js/72.b508f834.js"><link rel="prefetch" href="/assets/js/73.52a25a21.js"><link rel="prefetch" href="/assets/js/74.68de4c01.js"><link rel="prefetch" href="/assets/js/75.c0d8e99a.js"><link rel="prefetch" href="/assets/js/76.672b246e.js"><link rel="prefetch" href="/assets/js/77.36d886e3.js"><link rel="prefetch" href="/assets/js/78.079ebfd8.js"><link rel="prefetch" href="/assets/js/79.d3d3e8ea.js"><link rel="prefetch" href="/assets/js/8.a72c567f.js"><link rel="prefetch" href="/assets/js/80.c690c3d9.js"><link rel="prefetch" href="/assets/js/81.c012b7d5.js"><link rel="prefetch" href="/assets/js/82.47ffa460.js"><link rel="prefetch" href="/assets/js/83.2ba84114.js"><link rel="prefetch" href="/assets/js/84.dc0bf5a8.js"><link rel="prefetch" href="/assets/js/85.d968ae8b.js"><link rel="prefetch" href="/assets/js/86.91000a3b.js"><link rel="prefetch" href="/assets/js/87.6e885c71.js"><link rel="prefetch" href="/assets/js/88.99dd2b79.js"><link rel="prefetch" href="/assets/js/89.601c57ea.js"><link rel="prefetch" href="/assets/js/9.c59ba06b.js"><link rel="prefetch" href="/assets/js/90.89ee0da5.js"><link rel="prefetch" href="/assets/js/91.854de449.js"><link rel="prefetch" href="/assets/js/92.7a25d006.js"><link rel="prefetch" href="/assets/js/93.17f89281.js"><link rel="prefetch" href="/assets/js/94.0f6749b9.js"><link rel="prefetch" href="/assets/js/95.41ef6f4a.js"><link rel="prefetch" href="/assets/js/96.12427920.js"><link rel="prefetch" href="/assets/js/97.53036963.js"><link rel="prefetch" href="/assets/js/98.43d8f870.js"><link rel="prefetch" href="/assets/js/99.4ab32fce.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e4d8b86b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/heng.png" alt="英俊的大亨亨" class="logo"> <span class="site-name can-hide">英俊的大亨亨</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Language Menu" class="dropdown-title"><span class="title">js</span> <span class="arrow down"></span></button> <button type="button" aria-label="Language Menu" class="mobile-dropdown-title"><span class="title">js</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/js/js-基础.html" class="nav-link">
  基础
</a></li><li class="dropdown-item"><!----> <a href="/js/js-数组.html" class="nav-link">
  数组
</a></li><li class="dropdown-item"><!----> <a href="/js/js-异步.html" class="nav-link">
  异步
</a></li><li class="dropdown-item"><!----> <a href="/js/js-es6.html" class="nav-link">
  es6
</a></li><li class="dropdown-item"><!----> <a href="/js/js-v8引擎.html" class="nav-link">
  v8
</a></li><li class="dropdown-item"><!----> <a href="/手写代码/1.js基础.html" class="nav-link">
  手写
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Language Menu" class="dropdown-title"><span class="title">前端基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="Language Menu" class="mobile-dropdown-title"><span class="title">前端基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          前端基础
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/react/process.html" class="nav-link">
  
</a></li></ul></li><li class="dropdown-item"><!----> <a href="/html.html" class="nav-link">
  html
</a></li><li class="dropdown-item"><!----> <a href="/css.html" class="nav-link">
  css
</a></li><li class="dropdown-item"><!----> <a href="/node.html" class="nav-link">
  node
</a></li><li class="dropdown-item"><!----> <a href="/webpack.html" class="nav-link">
  webpack
</a></li><li class="dropdown-item"><!----> <a href="/webpack.html" class="nav-link">
  小程序
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="leetcode" class="dropdown-title"><span class="title">leetcode</span> <span class="arrow down"></span></button> <button type="button" aria-label="leetcode" class="mobile-dropdown-title"><span class="title">leetcode</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/代码随想录/1.数组.html" class="nav-link">
  1.数组
</a></li><li class="dropdown-item"><!----> <a href="/代码随想录/10.动态规划/1.基础.html" class="nav-link">
  10.动态规划
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Language Menu" class="dropdown-title"><span class="title">react源码</span> <span class="arrow down"></span></button> <button type="button" aria-label="Language Menu" class="mobile-dropdown-title"><span class="title">react源码</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/react源码/理念.html" class="nav-link">
  1.理念
</a></li><li class="dropdown-item"><!----> <a href="/react源码/3.render.html" class="nav-link">
  3.render
</a></li><li class="dropdown-item"><!----> <a href="/react源码/4.commit.html" class="nav-link">
  4.commit
</a></li><li class="dropdown-item"><!----> <a href="/react源码/5.状态更新.html" class="nav-link">
  5.状态更新
</a></li><li class="dropdown-item"><!----> <a href="/react源码/6.diff.html" class="nav-link">
  6.diff
</a></li><li class="dropdown-item"><!----> <a href="/react/7.实现hooks.html" class="nav-link">
  7.实现hooks
</a></li><li class="dropdown-item"><!----> <a href="/react/8.concurrentMode.html" class="nav-link">
  8.concurrentMode
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Language Menu" class="dropdown-title"><span class="title">webpack</span> <span class="arrow down"></span></button> <button type="button" aria-label="Language Menu" class="mobile-dropdown-title"><span class="title">webpack</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/webpack/1.配置.html" class="nav-link">
  1.配置
</a></li><li class="dropdown-item"><!----> <a href="/webpack/2.loader.html" class="nav-link">
  2.loader
</a></li><li class="dropdown-item"><!----> <a href="/webpack/3.plugin.html" class="nav-link">
  3.plugin
</a></li><li class="dropdown-item"><!----> <a href="/webpack/4.模块化原理.html" class="nav-link">
  4.模块化原理
</a></li><li class="dropdown-item"><!----> <a href="/webpack/5.babel.html" class="nav-link">
  5.babel
</a></li><li class="dropdown-item"><!----> <a href="/webpack/6.HMR.html" class="nav-link">
  6.HMR
</a></li><li class="dropdown-item"><!----> <a href="/webpack/7.环境分离.html" class="nav-link">
  7.环境分离
</a></li><li class="dropdown-item"><!----> <a href="/webpack/8.tree_shaking.html" class="nav-link">
  8.tree_shaking
</a></li><li class="dropdown-item"><!----> <a href="/webpack/9,源码.html" class="nav-link">
  9.源码
</a></li><li class="dropdown-item"><!----> <a href="/webpack/11.自定义loader.html" class="nav-link">
  11.自定义loader
</a></li><li class="dropdown-item"><!----> <a href="/webpack/12.自定义plugin.html" class="nav-link">
  12.自定义plugin
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Language Menu" class="dropdown-title"><span class="title">前端设计模式</span> <span class="arrow down"></span></button> <button type="button" aria-label="Language Menu" class="mobile-dropdown-title"><span class="title">前端设计模式</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/设计模式/创建型.html" class="nav-link">
  创建型
</a></li><li class="dropdown-item"><!----> <a href="/设计模式/结构型.html" class="nav-link">
  结构型
</a></li><li class="dropdown-item"><!----> <a href="/设计模式/行为型.html" class="nav-link">
  行为型
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Language Menu" class="dropdown-title"><span class="title">angular</span> <span class="arrow down"></span></button> <button type="button" aria-label="Language Menu" class="mobile-dropdown-title"><span class="title">angular</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/react/react%E8%BF%9B%E9%98%B6%E5%AE%9E%E8%B7%B5%E6%8C%87%E5%8D%97/.html" class="nav-link">
  angular性能调优
</a></li><li class="dropdown-item"><!----> <a href="/设计模式/结构型.html" class="nav-link">
  angular源码理解
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Language Menu" class="dropdown-title"><span class="title">健身</span> <span class="arrow down"></span></button> <button type="button" aria-label="Language Menu" class="mobile-dropdown-title"><span class="title">健身</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/react/react%E8%BF%9B%E9%98%B6%E5%AE%9E%E8%B7%B5%E6%8C%87%E5%8D%97/.html" class="nav-link">
  angular性能调优
</a></li><li class="dropdown-item"><!----> <a href="/设计模式/结构型.html" class="nav-link">
  angular源码理解
</a></li></ul></div></div><div class="nav-item"><a href="/me.html" class="nav-link">
  关于我
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Language Menu" class="dropdown-title"><span class="title">js</span> <span class="arrow down"></span></button> <button type="button" aria-label="Language Menu" class="mobile-dropdown-title"><span class="title">js</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/js/js-基础.html" class="nav-link">
  基础
</a></li><li class="dropdown-item"><!----> <a href="/js/js-数组.html" class="nav-link">
  数组
</a></li><li class="dropdown-item"><!----> <a href="/js/js-异步.html" class="nav-link">
  异步
</a></li><li class="dropdown-item"><!----> <a href="/js/js-es6.html" class="nav-link">
  es6
</a></li><li class="dropdown-item"><!----> <a href="/js/js-v8引擎.html" class="nav-link">
  v8
</a></li><li class="dropdown-item"><!----> <a href="/手写代码/1.js基础.html" class="nav-link">
  手写
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Language Menu" class="dropdown-title"><span class="title">前端基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="Language Menu" class="mobile-dropdown-title"><span class="title">前端基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          前端基础
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/react/process.html" class="nav-link">
  
</a></li></ul></li><li class="dropdown-item"><!----> <a href="/html.html" class="nav-link">
  html
</a></li><li class="dropdown-item"><!----> <a href="/css.html" class="nav-link">
  css
</a></li><li class="dropdown-item"><!----> <a href="/node.html" class="nav-link">
  node
</a></li><li class="dropdown-item"><!----> <a href="/webpack.html" class="nav-link">
  webpack
</a></li><li class="dropdown-item"><!----> <a href="/webpack.html" class="nav-link">
  小程序
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="leetcode" class="dropdown-title"><span class="title">leetcode</span> <span class="arrow down"></span></button> <button type="button" aria-label="leetcode" class="mobile-dropdown-title"><span class="title">leetcode</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/代码随想录/1.数组.html" class="nav-link">
  1.数组
</a></li><li class="dropdown-item"><!----> <a href="/代码随想录/10.动态规划/1.基础.html" class="nav-link">
  10.动态规划
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Language Menu" class="dropdown-title"><span class="title">react源码</span> <span class="arrow down"></span></button> <button type="button" aria-label="Language Menu" class="mobile-dropdown-title"><span class="title">react源码</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/react源码/理念.html" class="nav-link">
  1.理念
</a></li><li class="dropdown-item"><!----> <a href="/react源码/3.render.html" class="nav-link">
  3.render
</a></li><li class="dropdown-item"><!----> <a href="/react源码/4.commit.html" class="nav-link">
  4.commit
</a></li><li class="dropdown-item"><!----> <a href="/react源码/5.状态更新.html" class="nav-link">
  5.状态更新
</a></li><li class="dropdown-item"><!----> <a href="/react源码/6.diff.html" class="nav-link">
  6.diff
</a></li><li class="dropdown-item"><!----> <a href="/react/7.实现hooks.html" class="nav-link">
  7.实现hooks
</a></li><li class="dropdown-item"><!----> <a href="/react/8.concurrentMode.html" class="nav-link">
  8.concurrentMode
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Language Menu" class="dropdown-title"><span class="title">webpack</span> <span class="arrow down"></span></button> <button type="button" aria-label="Language Menu" class="mobile-dropdown-title"><span class="title">webpack</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/webpack/1.配置.html" class="nav-link">
  1.配置
</a></li><li class="dropdown-item"><!----> <a href="/webpack/2.loader.html" class="nav-link">
  2.loader
</a></li><li class="dropdown-item"><!----> <a href="/webpack/3.plugin.html" class="nav-link">
  3.plugin
</a></li><li class="dropdown-item"><!----> <a href="/webpack/4.模块化原理.html" class="nav-link">
  4.模块化原理
</a></li><li class="dropdown-item"><!----> <a href="/webpack/5.babel.html" class="nav-link">
  5.babel
</a></li><li class="dropdown-item"><!----> <a href="/webpack/6.HMR.html" class="nav-link">
  6.HMR
</a></li><li class="dropdown-item"><!----> <a href="/webpack/7.环境分离.html" class="nav-link">
  7.环境分离
</a></li><li class="dropdown-item"><!----> <a href="/webpack/8.tree_shaking.html" class="nav-link">
  8.tree_shaking
</a></li><li class="dropdown-item"><!----> <a href="/webpack/9,源码.html" class="nav-link">
  9.源码
</a></li><li class="dropdown-item"><!----> <a href="/webpack/11.自定义loader.html" class="nav-link">
  11.自定义loader
</a></li><li class="dropdown-item"><!----> <a href="/webpack/12.自定义plugin.html" class="nav-link">
  12.自定义plugin
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Language Menu" class="dropdown-title"><span class="title">前端设计模式</span> <span class="arrow down"></span></button> <button type="button" aria-label="Language Menu" class="mobile-dropdown-title"><span class="title">前端设计模式</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/设计模式/创建型.html" class="nav-link">
  创建型
</a></li><li class="dropdown-item"><!----> <a href="/设计模式/结构型.html" class="nav-link">
  结构型
</a></li><li class="dropdown-item"><!----> <a href="/设计模式/行为型.html" class="nav-link">
  行为型
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Language Menu" class="dropdown-title"><span class="title">angular</span> <span class="arrow down"></span></button> <button type="button" aria-label="Language Menu" class="mobile-dropdown-title"><span class="title">angular</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/react/react%E8%BF%9B%E9%98%B6%E5%AE%9E%E8%B7%B5%E6%8C%87%E5%8D%97/.html" class="nav-link">
  angular性能调优
</a></li><li class="dropdown-item"><!----> <a href="/设计模式/结构型.html" class="nav-link">
  angular源码理解
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Language Menu" class="dropdown-title"><span class="title">健身</span> <span class="arrow down"></span></button> <button type="button" aria-label="Language Menu" class="mobile-dropdown-title"><span class="title">健身</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/react/react%E8%BF%9B%E9%98%B6%E5%AE%9E%E8%B7%B5%E6%8C%87%E5%8D%97/.html" class="nav-link">
  angular性能调优
</a></li><li class="dropdown-item"><!----> <a href="/设计模式/结构型.html" class="nav-link">
  angular源码理解
</a></li></ul></div></div><div class="nav-item"><a href="/me.html" class="nav-link">
  关于我
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>react进阶实践指南</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/react/react进阶实践指南/fiber.html" class="sidebar-link">fiber保存的信息</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/react/react进阶实践指南/v18.html" class="sidebar-link">transition</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/react/react进阶实践指南/v18.html#意义" class="sidebar-link">意义</a></li><li class="sidebar-sub-header"><a href="/react/react进阶实践指南/v18.html#starttransition" class="sidebar-link">startTransition</a></li><li class="sidebar-sub-header"><a href="/react/react进阶实践指南/v18.html#usetransition" class="sidebar-link">useTransition</a></li><li class="sidebar-sub-header"><a href="/react/react进阶实践指南/v18.html#usedeferredvalue" class="sidebar-link">useDeferredValue</a></li></ul></li><li><a href="/react/react进阶实践指南/优化篇.html" class="sidebar-link">渲染控制</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/react/react进阶实践指南/优化篇.html#渲染的理解" class="sidebar-link">渲染的理解</a></li><li class="sidebar-sub-header"><a href="/react/react进阶实践指南/优化篇.html#控制render" class="sidebar-link">控制render</a></li><li class="sidebar-sub-header"><a href="/react/react进阶实践指南/优化篇.html#对render的思考" class="sidebar-link">对render的思考</a></li><li class="sidebar-sub-header"><a href="/react/react进阶实践指南/优化篇.html#二-懒加载和异步渲染" class="sidebar-link">二 懒加载和异步渲染</a></li><li class="sidebar-sub-header"><a href="/react/react进阶实践指南/优化篇.html#三-渲染错误边界" class="sidebar-link">三 渲染错误边界</a></li><li class="sidebar-sub-header"><a href="/react/react进阶实践指南/优化篇.html#四-从diff-children看key的合理使用" class="sidebar-link">四 从diff children看key的合理使用</a></li><li class="sidebar-sub-header"><a href="/react/react进阶实践指南/优化篇.html#时间分片" class="sidebar-link">时间分片</a></li><li class="sidebar-sub-header"><a href="/react/react进阶实践指南/优化篇.html#虚拟列表" class="sidebar-link">虚拟列表</a></li></ul></li><li><a href="/react/react进阶实践指南/原理篇.html" class="active sidebar-link">事件原理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/react/react进阶实践指南/原理篇.html#独特的事件处理" class="sidebar-link">独特的事件处理</a></li><li class="sidebar-sub-header"><a href="/react/react进阶实践指南/原理篇.html#事件合成" class="sidebar-link">事件合成</a></li><li class="sidebar-sub-header"><a href="/react/react进阶实践指南/原理篇.html#事件绑定" class="sidebar-link">事件绑定</a></li><li class="sidebar-sub-header"><a href="/react/react进阶实践指南/原理篇.html#事件触发" class="sidebar-link">事件触发</a></li><li class="sidebar-sub-header"><a href="/react/react进阶实践指南/原理篇.html#异步调度" class="sidebar-link">异步调度</a></li><li class="sidebar-sub-header"><a href="/react/react进阶实践指南/原理篇.html#异步调度原理" class="sidebar-link">异步调度原理</a></li><li class="sidebar-sub-header"><a href="/react/react进阶实践指南/原理篇.html#背景" class="sidebar-link">背景</a></li><li class="sidebar-sub-header"><a href="/react/react进阶实践指南/原理篇.html#二-fiber认识" class="sidebar-link">二 fiber认识</a></li><li class="sidebar-sub-header"><a href="/react/react进阶实践指南/原理篇.html#三-fiber更新机制" class="sidebar-link">三 fiber更新机制</a></li><li class="sidebar-sub-header"><a href="/react/react进阶实践指南/原理篇.html#四-两大阶段-render和commit" class="sidebar-link">四 两大阶段：render和commit</a></li><li class="sidebar-sub-header"><a href="/react/react进阶实践指南/原理篇.html#二-hooks与fiber-workinprogress" class="sidebar-link">二 hooks与fiber（workInProgress）</a></li><li class="sidebar-sub-header"><a href="/react/react进阶实践指南/原理篇.html#三-状态派发" class="sidebar-link">三 状态派发</a></li><li class="sidebar-sub-header"><a href="/react/react进阶实践指南/原理篇.html#四-处理副作用" class="sidebar-link">四 处理副作用</a></li><li class="sidebar-sub-header"><a href="/react/react进阶实践指南/原理篇.html#五-状态获取与状态缓存" class="sidebar-link">五 状态获取与状态缓存</a></li><li class="sidebar-sub-header"><a href="/react/react进阶实践指南/原理篇.html#六-总结" class="sidebar-link">六 总结</a></li></ul></li><li><a href="/react/react进阶实践指南/原理篇2.html" class="sidebar-link">context原理</a></li><li><a href="/react/react进阶实践指南/基础篇.html" class="sidebar-link">jsx</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/react/react进阶实践指南/基础篇.html#一、常用元素被react处理成什么" class="sidebar-link">一、常用元素被React处理成什么</a></li><li class="sidebar-sub-header"><a href="/react/react进阶实践指南/基础篇.html#二、可控性render" class="sidebar-link">二、可控性render</a></li><li class="sidebar-sub-header"><a href="/react/react进阶实践指南/基础篇.html#三、babel解析jsx" class="sidebar-link">三、Babel解析JSX</a></li><li class="sidebar-sub-header"><a href="/react/react进阶实践指南/基础篇.html#二、函数组件" class="sidebar-link">二、函数组件</a></li><li class="sidebar-sub-header"><a href="/react/react进阶实践指南/基础篇.html#三、5种组件通信方式" class="sidebar-link">三、5种组件通信方式</a></li><li class="sidebar-sub-header"><a href="/react/react进阶实践指南/基础篇.html#四、组件强化" class="sidebar-link">四、组件强化</a></li><li class="sidebar-sub-header"><a href="/react/react进阶实践指南/基础篇.html#一、类组件setstate" class="sidebar-link">一、类组件setState</a></li><li class="sidebar-sub-header"><a href="/react/react进阶实践指南/基础篇.html#二、函数组件的usestate" class="sidebar-link">二、函数组件的useState</a></li><li class="sidebar-sub-header"><a href="/react/react进阶实践指南/基础篇.html#一、监听props" class="sidebar-link">一、监听props</a></li><li class="sidebar-sub-header"><a href="/react/react进阶实践指南/基础篇.html#二、props-children模式" class="sidebar-link">二、props + children模式</a></li><li class="sidebar-sub-header"><a href="/react/react进阶实践指南/基础篇.html#三、操作props" class="sidebar-link">三、操作props</a></li><li class="sidebar-sub-header"><a href="/react/react进阶实践指南/基础篇.html#类组件生命周期" class="sidebar-link">类组件生命周期</a></li><li class="sidebar-sub-header"><a href="/react/react进阶实践指南/基础篇.html#各个生命周期能做些什么" class="sidebar-link">各个生命周期能做些什么</a></li><li class="sidebar-sub-header"><a href="/react/react进阶实践指南/基础篇.html#函数组件生命周期替代方案" class="sidebar-link">函数组件生命周期替代方案</a></li><li class="sidebar-sub-header"><a href="/react/react进阶实践指南/基础篇.html#ref的基本概念和使用" class="sidebar-link">ref的基本概念和使用</a></li><li class="sidebar-sub-header"><a href="/react/react进阶实践指南/基础篇.html#ref原理" class="sidebar-link">ref原理</a></li><li class="sidebar-sub-header"><a href="/react/react进阶实践指南/基础篇.html#基本使用" class="sidebar-link">基本使用</a></li><li class="sidebar-sub-header"><a href="/react/react进阶实践指南/基础篇.html#高阶组件类型" class="sidebar-link">高阶组件类型</a></li><li class="sidebar-sub-header"><a href="/react/react进阶实践指南/基础篇.html#高阶组件如何编写" class="sidebar-link">高阶组件如何编写</a></li><li class="sidebar-sub-header"><a href="/react/react进阶实践指南/基础篇.html#高阶组件注意事项" class="sidebar-link">高阶组件注意事项</a></li><li class="sidebar-sub-header"><a href="/react/react进阶实践指南/基础篇.html#进阶实践-权限拦截" class="sidebar-link">进阶实践 权限拦截</a></li></ul></li><li><a href="/react/react进阶实践指南/实践篇.html" class="sidebar-link">实现mini-router</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/react/react进阶实践指南/实践篇.html#二-设计思路" class="sidebar-link">二 设计思路</a></li></ul></li><li><a href="/react/react进阶实践指南/源码目录.html" class="sidebar-link">/react/react进阶实践指南/源码目录.html</a></li><li><a href="/react/react进阶实践指南/生态篇.html" class="sidebar-link">react-router</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/react/react进阶实践指南/生态篇.html#一-前言" class="sidebar-link">一 前言</a></li><li class="sidebar-sub-header"><a href="/react/react进阶实践指南/生态篇.html#二-路由原理" class="sidebar-link">二 路由原理</a></li><li class="sidebar-sub-header"><a href="/react/react进阶实践指南/生态篇.html#三-react-router-基本构成" class="sidebar-link">三 React-Router 基本构成</a></li><li class="sidebar-sub-header"><a href="/react/react进阶实践指南/生态篇.html#四-路由使用指南" class="sidebar-link">四 路由使用指南</a></li><li class="sidebar-sub-header"><a href="/react/react进阶实践指南/生态篇.html#五-实践一权限路由封装" class="sidebar-link">五 实践一权限路由封装</a></li><li class="sidebar-sub-header"><a href="/react/react进阶实践指南/生态篇.html#一-前言-2" class="sidebar-link">一 前言</a></li><li class="sidebar-sub-header"><a href="/react/react进阶实践指南/生态篇.html#二-react-redux用法" class="sidebar-link">二 React-Redux用法</a></li><li class="sidebar-sub-header"><a href="/react/react进阶实践指南/生态篇.html#三-react-redux原理" class="sidebar-link">三 React-Redux原理</a></li><li class="sidebar-sub-header"><a href="/react/react进阶实践指南/生态篇.html#四-实现异步" class="sidebar-link">四 实现异步</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="事件原理"><a href="#事件原理" class="header-anchor">#</a> 事件原理</h1> <h2 id="独特的事件处理"><a href="#独特的事件处理" class="header-anchor">#</a> 独特的事件处理</h2> <h3 id="冒泡阶段和捕获阶段"><a href="#冒泡阶段和捕获阶段" class="header-anchor">#</a> 冒泡阶段和捕获阶段</h3> <ul><li>冒泡阶段： 默认会在模拟冒泡阶段执行</li> <li>捕获阶段： 带上Capture 后缀</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span> handleClick  <span class="token punctuation">}</span> onClickCapture<span class="token operator">=</span><span class="token punctuation">{</span> handleClickCapture <span class="token punctuation">}</span>  <span class="token operator">&gt;</span>点击<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
</code></pre></div><h3 id="阻止冒泡"><a href="#阻止冒泡" class="header-anchor">#</a> 阻止冒泡</h3> <p>e.stopPropagation()，父元素的click事件将不再触发</p> <h3 id="阻止默认行为"><a href="#阻止默认行为" class="header-anchor">#</a> 阻止默认行为</h3> <p><strong>原生事件：</strong> <code>e.preventDefault()</code> 和 <code>return false</code> ， <strong>return false 在react失去作用</strong></p> <p>React应用的 <code>e.preventDefault()</code>并非是原生事件的 preventDefault</p> <p>由于 React 事件源 e 也是独立组建的，所以 preventDefault 也是单独处理的</p> <h2 id="事件合成"><a href="#事件合成" class="header-anchor">#</a> 事件合成</h2> <p>react事件系统 = 事件合成系统 + 渲染中事件收集和注册 + 事件触发和执行</p> <p><strong>为什么要有事件机制？</strong></p> <p>fiber生成时可能dom还未挂载，因此不能直接绑定到真实DOM</p> <p>方便控制事件优先级、兼容浏览器</p> <p><strong>事件机制的特点</strong></p> <p>顶层注册：一个统一的事件处理函数</p> <p>事件收集：触发事件时构造合成事件，收集执行函数</p> <p>统一触发：完成收集后，逐一执行，共享一个合成事件对象</p> <p><strong>事件注册</strong></p> <p>rND存储原生与合成事件的映射，prop是判断是否为事件的重要依据</p> <p>绑定时根据rND在root上通过addEventListener绑定原生事件，根据事件名识别是捕获还是冒泡阶段</p> <h3 id="事件合成概念"><a href="#事件合成概念" class="header-anchor">#</a> 事件合成概念</h3> <p>事件绑定在root容器，17之前是document，17改成了app，适应微前端</p> <p>元素绑定的是合成事件，如onClick = click, onChange = blur + change + focus</p> <h3 id="事件插件机制"><a href="#事件插件机制" class="header-anchor">#</a> 事件插件机制</h3> <p>onClick 和 onChange ，会有不同的事件插件 SimpleEventPlugin ，ChangeEventPlugin 处理</p> <p><strong>registrationNameModules</strong>：事件和插件的映射，事件用了哪些插件模块</p> <p><strong>registrationNameDependencies：</strong> 合成事件和原生事件的映射，事件依赖哪些原生事件</p> <h2 id="事件绑定"><a href="#事件绑定" class="header-anchor">#</a> 事件绑定</h2> <p>事件绑定后保存在fiber的memoizedProps中</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token operator">&lt;</span>input onChange<span class="token operator">=</span><span class="token punctuation">{</span><span class="token function">change</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token comment">// 对应fiber</span>
memoizedProps<span class="token operator">=</span><span class="token punctuation">{</span>
  onChange<span class="token operator">:</span> change
<span class="token punctuation">}</span>
</code></pre></div><p>react在diff props的时候发现合成事件，就会查询Deps映射表，注册原生事件</p> <p>在root容器绑定的事件也不是处理函数，而是<strong>dispatchEvent</strong></p> <p>事件执行时，首先执行dispatchEvent</p> <p>react有一个统一的流程去做<strong>事件代理，</strong> <strong>批量更新</strong>等逻辑</p> <h2 id="事件触发"><a href="#事件触发" class="header-anchor">#</a> 事件触发</h2> <p><strong>一、批量更新</strong></p> <p>dispatchEvent执行，传入真实的dom元素，寻找对应的fiber，然后批量更新</p> <p><strong>fiber statenode指向真实dom</strong>，dom在初始化时通过reactFiber指针指向fiber</p> <p><strong>二、合成事件源</strong></p> <p>使用插件来合成事件源，包含preventDefault等方法</p> <p><strong>三、事件执行队列</strong></p> <p>从目标fiber向上遍历，收集事件直至app顶部，形成执行队列，依次执行</p> <p>冒泡事件放在队尾，捕获事件放在队头</p> <h3 id="react如何模拟阻止事件冒泡"><a href="#react如何模拟阻止事件冒泡" class="header-anchor">#</a> React如何模拟阻止事件冒泡</h3> <p>执行事件时，事件源有状态证明事件的是否冒泡</p> <p>下次遍历时就会跳出循环</p> <h1 id="调度scheduler和时间片"><a href="#调度scheduler和时间片" class="header-anchor">#</a> 调度scheduler和时间片</h1> <h2 id="异步调度"><a href="#异步调度" class="header-anchor">#</a> 异步调度</h2> <h3 id="为什么采用异步调度"><a href="#为什么采用异步调度" class="header-anchor">#</a> 为什么采用异步调度？</h3> <h3 id="时间分片"><a href="#时间分片" class="header-anchor">#</a> 时间分片</h3> <p>一帧的处理顺序：处理事件、执行js、调用requestAnimation、layout、paint、空闲</p> <p>requestIdleCallback：查询空闲时间</p> <p>react通过类似requestIdleCallback向浏览器查询空闲时间</p> <p>使用setTimeout模拟requestIdleCallback会有延时，因此选择messageChannel</p> <p>ensureRootIsScheduled</p> <p>正常走performSyncWork，异步更新走performConcurrentWork</p> <p>异步更新会调用shouldYield，浏览器没空闲事件就yield出去，有空闲时间再返回继续遍历，实现可中断</p> <p>两种更新都会调用scheduleCallback，只是异步更新多了超时处理的概念</p> <h3 id="模拟requestidlecallback"><a href="#模拟requestidlecallback" class="header-anchor">#</a> 模拟requestIdleCallback</h3> <p><strong>setTimeout(fn, 0)</strong></p> <p><strong>MessageChannel</strong></p> <h2 id="异步调度原理"><a href="#异步调度原理" class="header-anchor">#</a> 异步调度原理</h2> <h3 id="schedulecallback"><a href="#schedulecallback" class="header-anchor">#</a> scheduleCallback</h3> <p><strong>scheduleCallback 到底做了些什么呢？</strong></p> <h3 id="requesthosttimeout"><a href="#requesthosttimeout" class="header-anchor">#</a> requestHostTimeout</h3> <h3 id="handletimeout"><a href="#handletimeout" class="header-anchor">#</a> handleTimeout</h3> <h3 id="advancetimers"><a href="#advancetimers" class="header-anchor">#</a> advanceTimers</h3> <h3 id="flushwork和workloop"><a href="#flushwork和workloop" class="header-anchor">#</a> flushWork和workloop</h3> <h3 id="shouldyield-中止-workloop"><a href="#shouldyield-中止-workloop" class="header-anchor">#</a> shouldYield 中止 workloop</h3> <h3 id="调和-异步调度-流程总图"><a href="#调和-异步调度-流程总图" class="header-anchor">#</a> 调和 + 异步调度 流程总图</h3> <h1 id="调和与fiber"><a href="#调和与fiber" class="header-anchor">#</a> 调和与fiber</h1> <h2 id="背景"><a href="#背景" class="header-anchor">#</a> 背景</h2> <h3 id="fiber"><a href="#fiber" class="header-anchor">#</a> fiber</h3> <p>React重构 fiber 架构目的就是解决大型 React 应用卡顿</p> <h3 id="为什么要用fiber"><a href="#为什么要用fiber" class="header-anchor">#</a> 为什么要用fiber</h3> <p>从递归遍历虚拟dom 到 可中断遍历 fiber</p> <p>react15的递归遍历虚拟dom，从根部开始递归遍历更新，一旦开始就无法中断，项目层级复杂，递归时间长，页面卡顿</p> <p>react16引入fiber，更新的过程叫做reconcile，每个fiber作为最小单元进行处理，fiber有个属性expirationTime，v17叫做lane，一旦其超过浏览器调度的空闲时间，就会中断更新，把控制器交给浏览器渲染。</p> <p>当浏览器重新空闲时，scheduler会恢复中断的fiber，继续执行</p> <h2 id="二-fiber认识"><a href="#二-fiber认识" class="header-anchor">#</a> 二 fiber认识</h2> <h3 id="element、fiber、dom的关系"><a href="#element、fiber、dom的关系" class="header-anchor">#</a> element、fiber、dom的关系</h3> <p>element是代码层级的fiber表现，保存props、children等信息</p> <p>dom是浏览器的表现</p> <p>fiber是代码和浏览器之间的桥梁，element和fiber一一对应，element变化都通过fiber做一层reconcile。然后再根据fiber形成新的dom，实现更新渲染</p> <h3 id="fiber保存的信息"><a href="#fiber保存的信息" class="header-anchor">#</a> fiber保存的信息</h3> <blockquote><p>react-reconciler/src/ReactFiber.js</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">FiberNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

  <span class="token keyword">this</span><span class="token punctuation">.</span>tag <span class="token operator">=</span> tag<span class="token punctuation">;</span>                  <span class="token comment">// fiber 标签 证明是什么类型fiber。</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>key <span class="token operator">=</span> key<span class="token punctuation">;</span>                  <span class="token comment">// key调和子节点时候用到。 </span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>                <span class="token comment">// dom元素是对应的元素类型，比如div，组件指向组件对应的类或者函数。  </span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>stateNode <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>           <span class="token comment">// 指向对应的真实dom元素，类组件指向组件实例，可以被ref获取。</span>
 
  <span class="token keyword">this</span><span class="token punctuation">.</span>return <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>              <span class="token comment">// 指向父级fiber</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>child <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>               <span class="token comment">// 指向子级fiber</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>sibling <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>             <span class="token comment">// 指向兄弟fiber </span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                  <span class="token comment">// 索引</span>

  <span class="token keyword">this</span><span class="token punctuation">.</span>ref <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>                 <span class="token comment">// ref指向，ref函数，或者ref对象。</span>

  <span class="token keyword">this</span><span class="token punctuation">.</span>pendingProps <span class="token operator">=</span> pendingProps<span class="token punctuation">;</span><span class="token comment">// 在一次更新中，代表element创建</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>memoizedProps <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>       <span class="token comment">// 记录上一次更新完毕后的props</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>updateQueue <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>         <span class="token comment">// 类组件存放setState更新队列，函数组件存放</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>memoizedState <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>       <span class="token comment">// 类组件保存state信息，函数组件保存hooks信息，dom元素为null</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>dependencies <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token comment">// context或是时间的依赖项</span>

  <span class="token keyword">this</span><span class="token punctuation">.</span>mode <span class="token operator">=</span> mode<span class="token punctuation">;</span>                <span class="token comment">//描述fiber树的模式，比如 ConcurrentMode 模式</span>

  <span class="token keyword">this</span><span class="token punctuation">.</span>effectTag <span class="token operator">=</span> NoEffect<span class="token punctuation">;</span>       <span class="token comment">// effect标签，用于收集effectList</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>nextEffect <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>          <span class="token comment">// 指向下一个effect</span>

  <span class="token keyword">this</span><span class="token punctuation">.</span>firstEffect <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>         <span class="token comment">// 第一个effect</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>lastEffect <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>          <span class="token comment">// 最后一个effect</span>

  <span class="token keyword">this</span><span class="token punctuation">.</span>expirationTime <span class="token operator">=</span> NoWork<span class="token punctuation">;</span>    <span class="token comment">// 通过不同过期时间，判断任务是否过期， 在v17版本用lane表示。</span>

  <span class="token keyword">this</span><span class="token punctuation">.</span>alternate <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>           <span class="token comment">//双缓存树，指向缓存的fiber。更新阶段，两颗树互相交替。</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="fiber之间的连接关系"><a href="#fiber之间的连接关系" class="header-anchor">#</a> fiber之间的连接关系</h3> <p>通过child、sibling、return连接</p> <h2 id="三-fiber更新机制"><a href="#三-fiber更新机制" class="header-anchor">#</a> 三 fiber更新机制</h2> <h3 id="_1-初始化"><a href="#_1-初始化" class="header-anchor">#</a> 1 初始化</h3> <h4 id="第一步-创建fiberroot和rootfiber"><a href="#第一步-创建fiberroot和rootfiber" class="header-anchor">#</a> 第一步：创建fiberRoot和rootFiber</h4> <p>fiberRoot：应用根节点</p> <p>rootFiber：通过ReactDOM.render()渲染的根fiber</p> <p>第一次挂载时，将fiberRoot和rootFiber关联</p> <blockquote><p>react-reconciler/src/ReactFiberRoot.js</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">createFiberRoot</span><span class="token punctuation">(</span><span class="token parameter">containerInfo<span class="token punctuation">,</span>tag</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">/* 创建一个root */</span>
    <span class="token keyword">const</span> root <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FiberRootNode</span><span class="token punctuation">(</span>containerInfo<span class="token punctuation">,</span>tag<span class="token punctuation">)</span>
    <span class="token keyword">const</span> rootFiber <span class="token operator">=</span> <span class="token function">createHostRootFiber</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span><span class="token punctuation">;</span>
    root<span class="token punctuation">.</span>current <span class="token operator">=</span> rootFiber
    <span class="token keyword">return</span> root
<span class="token punctuation">}</span>
</code></pre></div><h4 id="第二步-workinprogress和current"><a href="#第二步-workinprogress和current" class="header-anchor">#</a> 第二步：workInProgress和current</h4> <p>rootFiber的渲染过程，首先复用current树的alternate作为workInProgress</p> <p>初始化时没有alternate，则创建一个fiber作为workInProgress，并将current和workInProgress关联起来</p> <div class="language-js extra-class"><pre class="language-js"><code>currentFiber<span class="token punctuation">.</span>alternate <span class="token operator">=</span> workInProgressFiber
workInProgressFiber<span class="token punctuation">.</span>alternate <span class="token operator">=</span> currentFiber
</code></pre></div><h4 id="第三步-深度调和子节点-渲染视图"><a href="#第三步-深度调和子节点-渲染视图" class="header-anchor">#</a> 第三步：深度调和子节点，渲染视图</h4> <p>然后，在workInProgress树上完成遍历构建</p> <p>将workInProgress和current互换，即fiberRoot的current指针切换，完成初始化</p> <h3 id="_2-更新"><a href="#_2-更新" class="header-anchor">#</a> 2 更新</h3> <p>更新时，会重新构建workInProgress树，复用current树的alternate，作为新的workInProgress</p> <p>workInProgress树根据current树创建剩余的子节点，并建立alternate关系</p> <p>然后进行更新</p> <h3 id="双缓冲树"><a href="#双缓冲树" class="header-anchor">#</a> 双缓冲树</h3> <p>在内存中构建并直接替换的技术叫做<strong>双缓存</strong></p> <p>防止状态丢失，加快DOM节点的更新</p> <h2 id="四-两大阶段-render和commit"><a href="#四-两大阶段-render和commit" class="header-anchor">#</a> 四 两大阶段：render和commit</h2> <p>整个 fiber 的遍历开始 —— workLoop</p> <p>work的理解：理解成一次更新任务</p> <h3 id="_1-render阶段"><a href="#_1-render阶段" class="header-anchor">#</a> 1 render阶段</h3> <blockquote><p>react-reconciler/src/ReactFiberWorkLoop.js</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">workLoop</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>workInProgress <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      workInProgress <span class="token operator">=</span> <span class="token function">performUnitOfWork</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在调和过程中，每一个发生更新的 fiber 都会作为一次 workInProgress</p> <p>workLoop 就是执行每一个单元的调度器</p> <p>performUnitOfWork 包括两个阶段 beginWork 和 completeWork</p> <blockquote><p>react-reconciler/src/ReactFiberWorkLoop.js</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">performUnitOfWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    next <span class="token operator">=</span> <span class="token function">beginWork</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> unitOfWork<span class="token punctuation">,</span> renderExpirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>next <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       next <span class="token operator">=</span> <span class="token function">completeUnitOfWork</span><span class="token punctuation">(</span>unitOfWork<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>beginWork：根据child向下调和，期间会执行函数组件，实例类组件，diff 调和子节点，打不同effectTag</p> <p>completeUnitOfWork：向上归并，有sibling则返回，否则返回return，直到rootFiber。期间形成effectList。对DOM元素进行事件收集，处理style，className</p> <h4 id="向下调和beginwork"><a href="#向下调和beginwork" class="header-anchor">#</a> 向下调和beginWork</h4> <blockquote><p>react-reconciler/src/ReactFiberBeginWork.js</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">beginWork</span><span class="token punctuation">(</span><span class="token parameter">current<span class="token punctuation">,</span>workInProgress</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

    <span class="token keyword">switch</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">.</span>tag<span class="token punctuation">)</span><span class="token punctuation">{</span>
       <span class="token keyword">case</span> IndeterminateComponent<span class="token operator">:</span><span class="token punctuation">{</span><span class="token comment">// 初始化的时候不知道是函数组件还是类组件 </span>
           <span class="token comment">//....</span>
       <span class="token punctuation">}</span>
       <span class="token keyword">case</span> FunctionComponent<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token comment">//对应函数组件</span>
           <span class="token comment">//....</span>
       <span class="token punctuation">}</span>
       <span class="token keyword">case</span> ClassComponent<span class="token operator">:</span><span class="token punctuation">{</span>  <span class="token comment">//类组件</span>
           <span class="token comment">//...</span>
       <span class="token punctuation">}</span>
       <span class="token keyword">case</span> HostComponent<span class="token operator">:</span><span class="token punctuation">{</span>
           <span class="token comment">//...  </span>
       <span class="token punctuation">}</span>
       <span class="token operator">...</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>对于组件，执行部分生命周期钩子，执行render，得到最新的children</p> <p>向下调和children，复用oldFiber（diff流程）</p> <p>打effectTag，元素增删改</p> <p><strong>reconcileChildren</strong></p> <blockquote><p>react-reconciler/src/ReactFiberBeginWork.js</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">reconcileChildren</span><span class="token punctuation">(</span><span class="token parameter">current<span class="token punctuation">,</span>workInProgress</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>current <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token comment">/* 初始化子代fiber  */</span>
        workInProgress<span class="token punctuation">.</span>child <span class="token operator">=</span> <span class="token function">mountChildFibers</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">,</span>nextChildren<span class="token punctuation">,</span>renderExpirationTime<span class="token punctuation">)</span>
   <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>  <span class="token comment">/* 更新流程，diff children将在这里进行。 */</span>
        workInProgress<span class="token punctuation">.</span>child <span class="token operator">=</span> <span class="token function">reconcileChildFibers</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">,</span>current<span class="token punctuation">.</span>child<span class="token punctuation">,</span>nextChildren<span class="token punctuation">,</span>renderExpirationTime<span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="向上归并-completeunitofwork"><a href="#向上归并-completeunitofwork" class="header-anchor">#</a> 向上归并 completeUnitOfWork</h4> <p>将effectTag的fiber保存到effectList的单向链表中，commit阶段只需要更新effectList即可</p> <p>处理组件的context，如果是元素标签初始化，会创建插入真实DOM，触发diffProperties处理props。</p> <h4 id="调和顺序"><a href="#调和顺序" class="header-anchor">#</a> 调和顺序</h4> <h3 id="_2-commit阶段"><a href="#_2-commit阶段" class="header-anchor">#</a> 2 commit阶段</h3> <p>处理生命周期钩子，componentDidMount，useEffect，useLayoutEffect</p> <p>增删改节点</p> <p>处理ref</p> <h4 id="_1-before-mutation"><a href="#_1-before-mutation" class="header-anchor">#</a> ① Before mutation</h4> <blockquote><p>react-reconciler/src/ReactFiberWorkLoop.js</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">commitBeforeMutationEffects</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>nextEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> effectTag <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>effectTag<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>effectTag <span class="token operator">&amp;</span> Snapshot<span class="token punctuation">)</span> <span class="token operator">!==</span> NoEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> current <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>
      <span class="token comment">// 调用getSnapshotBeforeUpdates</span>
      <span class="token function">commitBeforeMutationEffectOnFiber</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>effectTag <span class="token operator">&amp;</span> Passive<span class="token punctuation">)</span> <span class="token operator">!==</span> NoEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token function">scheduleCallback</span><span class="token punctuation">(</span>NormalPriority<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token function">flushPassiveEffects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    nextEffect <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>nextEffect<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>获取DOM快照的最佳时期，getSnapShotBeforeUpdate</p> <p>异步调用useEffect（采用异步是为了防止同步执行阻塞渲染）</p> <h4 id="_2-mutation"><a href="#_2-mutation" class="header-anchor">#</a> ② Mutation</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">commitMutationEffects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>nextEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>effectTag <span class="token operator">&amp;</span> Ref<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">/* 置空Ref */</span>
            <span class="token keyword">const</span> current <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">commitDetachRef</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>primaryEffectTag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> Placement<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment">//  新增元素</span>
            <span class="token keyword">case</span> Update<span class="token operator">:</span><span class="token punctuation">{</span><span class="token punctuation">}</span>     <span class="token comment">//  更新元素</span>
            <span class="token keyword">case</span> Deletion<span class="token operator">:</span><span class="token punctuation">{</span><span class="token punctuation">}</span>   <span class="token comment">//  删除元素</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>置空ref</p> <p>进行真实的DOM操作</p> <h4 id="_3-layout"><a href="#_3-layout" class="header-anchor">#</a> ③ Layout</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">commitLayoutEffects</span><span class="token punctuation">(</span><span class="token parameter">root</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
     <span class="token keyword">while</span> <span class="token punctuation">(</span>nextEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> effectTag <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>effectTag<span class="token punctuation">;</span>
          <span class="token function">commitLayoutEffectOnFiber</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span>current<span class="token punctuation">,</span>nextEffect<span class="token punctuation">,</span>committedExpirationTime<span class="token punctuation">)</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>effectTag <span class="token operator">&amp;</span> Ref<span class="token punctuation">)</span> <span class="token punctuation">{</span>
             <span class="token function">commitAttachRef</span><span class="token punctuation">(</span>nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
     <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>commitLayoutEffectOnFiber会执行生命周期钩子，setState的callback，useLayoutEffect</p> <p>重新赋值ref</p> <p>commit阶段的主要任务就是执行effectList，更新DOM，执行生命周期，更新ref</p> <h3 id="_3-调和-异步调度-流程总图"><a href="#_3-调和-异步调度-流程总图" class="header-anchor">#</a> 3 调和 + 异步调度 流程总图</h3> <h1 id="hooks"><a href="#hooks" class="header-anchor">#</a> Hooks</h1> <h2 id="二-hooks与fiber-workinprogress"><a href="#二-hooks与fiber-workinprogress" class="header-anchor">#</a> 二 hooks与fiber（workInProgress）</h2> <p>类组件的状态比如 state ，context ，props 本质上是存在类组件对应的 fiber 上</p> <p>hooks必然与fiber有本质关联，是组件与fiber之间的桥梁</p> <p>hooks 对象主要以三种处理策略存在 React 中</p> <p><strong>ContextOnlyDispatcher</strong>：提示contexOnlyDispatcher 报错形态。防止开发者在函数组件外部调用 hooks ，抛出异常。</p> <p><strong>HooksDispatcherOnMount</strong>：函数组件初始化 mount ，初次建立其 hooks 与 fiber 之间的关系。</p> <p><strong>HooksDispatcherOnUpdate</strong>：函数组件更新，hooks 去获取或者更新维护状态</p> <p>里面都是一个个的hooks。。。</p> <h3 id="函数组件触发"><a href="#函数组件触发" class="header-anchor">#</a> 函数组件触发</h3> <p>函数组件的触发是在 renderWithHooks 方法</p> <p>给ReactCurrentDispatcher的current属性赋值变换的过程，赋予不同的hooks对象</p> <p>React 如何监控 hooks 是否在函数组件内部调用？通过赋予 current 不同的 hooks 对象</p> <blockquote><p>react-reconciler/src/ReactFiberHooks.js</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> currentlyRenderingFiber
<span class="token keyword">function</span> <span class="token function">renderWithHooks</span><span class="token punctuation">(</span><span class="token parameter">current<span class="token punctuation">,</span>workInProgress<span class="token punctuation">,</span>Component<span class="token punctuation">,</span>props</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 初始化, 清空状态，赋予current值</span>
    currentlyRenderingFiber <span class="token operator">=</span> workInProgress<span class="token punctuation">;</span> <span class="token comment">// 提供给hooks读取fiber信息</span>
    workInProgress<span class="token punctuation">.</span>memoizedState <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">/* 用于存放hooks列表，链表连接*/</span>
    workInProgress<span class="token punctuation">.</span>updateQueue <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>    <span class="token comment">/* 存放effect list ，存放每个 useEffect/useLayoutEffect 产生的副作用组成的链表，在 commit 阶段更新这些副作用*/</span>
    ReactCurrentDispatcher<span class="token punctuation">.</span>current <span class="token operator">=</span>  current <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">||</span> current<span class="token punctuation">.</span>memoizedState <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">?</span> HooksDispatcherOnMount <span class="token operator">:</span> HooksDispatcherOnUpdate <span class="token comment">/* 判断是初始化组件还是更新组件 */</span>

    <span class="token comment">// 执行组件，执行完成后赋予current常规状态</span>
    <span class="token keyword">let</span> children <span class="token operator">=</span> <span class="token function">Component</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span> secondArg<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* 执行真正函数组件，所有的hooks将依次执行。 */</span>
    ReactCurrentDispatcher<span class="token punctuation">.</span>current <span class="token operator">=</span> ContextOnlyDispatcher<span class="token punctuation">;</span> <span class="token comment">/* 将hooks变成第一种，防止hooks在函数组件外部调用，调用直接报错。 */</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="hooks初始化-hooks-如何和-fiber-建立起关系"><a href="#hooks初始化-hooks-如何和-fiber-建立起关系" class="header-anchor">#</a> hooks初始化- hooks 如何和 fiber 建立起关系</h3> <p>hooks初始化执行mountWorkInProgressHook</p> <blockquote><p>react-reconciler/src/ReactFiberHooks.js</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">mountWorkInProgressHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> hook <span class="token operator">=</span> <span class="token punctuation">{</span>  memoizedState<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> baseState<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> baseQueue<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>queue<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> next<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token comment">// memoizedState存储hooks链表</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>workInProgressHook <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// This is the first hook in the list</span>
    currentlyRenderingFiber<span class="token punctuation">.</span>memoizedState <span class="token operator">=</span> workInProgressHook <span class="token operator">=</span> hook<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>  <span class="token comment">// 有多个 hooks，Append to the end of the list</span>
    workInProgressHook <span class="token operator">=</span> workInProgressHook<span class="token punctuation">.</span>next <span class="token operator">=</span> hook<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> workInProgressHook<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="hooks更新"><a href="#hooks更新" class="header-anchor">#</a> hooks更新</h3> <p>取出workInProgress的alternate（current）的hooks，复制一份，形成新链表</p> <p>为什么hooks不能放在if语句中，因为在更新的过程中会产生复用hooks的状态和当前hooks不一致的问题，react无法正确调用hooks</p> <p>这让 React 能够在多次的 <code>useState</code> 和 <code>useEffect</code> 调用之间保持 hook 状态正确的原因</p> <h2 id="三-状态派发"><a href="#三-状态派发" class="header-anchor">#</a> 三 状态派发</h2> <p>useState 和 useReducer 原理大同小异，本质触发更新的函数都是 dispatchAction</p> <p>useState的本质原理</p> <blockquote><p>react-reconciler/src/ReactFiberHooks.js</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">mountState</span><span class="token punctuation">(</span><span class="token parameter">initialState</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> hook <span class="token operator">=</span> <span class="token function">mountWorkInProgressHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> initialState <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>initialState <span class="token operator">=</span> <span class="token function">initialState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span> <span class="token comment">// 如果 useState 第一个参数为函数，执行函数得到初始化state</span>
    hook<span class="token punctuation">.</span>memoizedState <span class="token operator">=</span> hook<span class="token punctuation">.</span>baseState <span class="token operator">=</span> initialState<span class="token punctuation">;</span>
    <span class="token keyword">const</span> queue <span class="token operator">=</span> <span class="token punctuation">(</span>hook<span class="token punctuation">.</span>queue <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 负责记录更新的各种状态。</span>
    <span class="token keyword">const</span> dispatch <span class="token operator">=</span> <span class="token punctuation">(</span>queue<span class="token punctuation">.</span>dispatch <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">dispatchAction</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>  <span class="token keyword">null</span><span class="token punctuation">,</span>currentlyRenderingFiber<span class="token punctuation">,</span>queue<span class="token punctuation">,</span> <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// dispatchAction 为更新调度的主要函数 </span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span>hook<span class="token punctuation">.</span>memoizedState<span class="token punctuation">,</span> dispatch<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>state保存在hooks的memoizedState中，每个useState都会创建一个queue，保存更新的信息</p> <p>useState会创建一个更新函数，<strong>更新state的函数本质是dispatchAction</strong></p> <p>把memoizedState dispatch返回给开发者</p> <p>接下来重点研究一下 <code>dispatchAction</code> ，底层是怎么处理更新逻辑的。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">dispatchAction</span><span class="token punctuation">(</span><span class="token parameter">fiber<span class="token punctuation">,</span> queue<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">/* 第一步：创建一个 update */</span>
    <span class="token keyword">const</span> update <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
    <span class="token keyword">const</span> pending <span class="token operator">=</span> queue<span class="token punctuation">.</span>pending<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pending <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">/* 第一个待更新任务 */</span>
        update<span class="token punctuation">.</span>next <span class="token operator">=</span> update<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>  <span class="token comment">/* 已经有带更新任务 */</span>
       update<span class="token punctuation">.</span>next <span class="token operator">=</span> pending<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
       pending<span class="token punctuation">.</span>next <span class="token operator">=</span> update<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> fiber <span class="token operator">===</span> currentlyRenderingFiber <span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">/* 说明当前fiber正在发生调和渲染更新，那么不需要更新 */</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
       <span class="token keyword">if</span><span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>expirationTime <span class="token operator">===</span> NoWork <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>alternate <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">||</span> alternate<span class="token punctuation">.</span>expirationTime <span class="token operator">===</span> NoWork<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">const</span> lastRenderedReducer <span class="token operator">=</span> queue<span class="token punctuation">.</span>lastRenderedReducer<span class="token punctuation">;</span>
            <span class="token keyword">const</span> currentState <span class="token operator">=</span> queue<span class="token punctuation">.</span>lastRenderedState<span class="token punctuation">;</span>                 <span class="token comment">/* 上一次的state */</span>
            <span class="token keyword">const</span> eagerState <span class="token operator">=</span> <span class="token function">lastRenderedReducer</span><span class="token punctuation">(</span>currentState<span class="token punctuation">,</span> action<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* 这一次新的state */</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">is</span><span class="token punctuation">(</span>eagerState<span class="token punctuation">,</span> currentState<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                           <span class="token comment">/* 如果每一个都改变相同的state，那么组件不更新 */</span>
               <span class="token keyword">return</span> 
            <span class="token punctuation">}</span>
       <span class="token punctuation">}</span>
       <span class="token function">scheduleUpdateOnFiber</span><span class="token punctuation">(</span>fiber<span class="token punctuation">,</span> expirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">/* 发起调度更新 */</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>创建update，放入pending队列</p> <p>如果当前fiber正在更新，则不需要更新</p> <p>如果fiber没有在更新，则对比前后state，相同则退出，不相同则发起更新调度任务</p> <p><strong>这就解释了，为什么函数组件 useState 改变相同的值，组件不更新了。</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">updateReducer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 第一步把待更新的pending队列取出来。合并到 baseQueue</span>
    <span class="token keyword">const</span> first <span class="token operator">=</span> baseQueue<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
    <span class="token keyword">let</span> update <span class="token operator">=</span> first<span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
        <span class="token comment">/* 得到新的 state */</span>
        newState <span class="token operator">=</span> <span class="token function">reducer</span><span class="token punctuation">(</span>newState<span class="token punctuation">,</span> action<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>update <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> update <span class="token operator">!==</span> first<span class="token punctuation">)</span><span class="token punctuation">;</span>
     hook<span class="token punctuation">.</span>memoizedState <span class="token operator">=</span> newState<span class="token punctuation">;</span>
     <span class="token keyword">return</span> <span class="token punctuation">[</span>hook<span class="token punctuation">.</span>memoizedState<span class="token punctuation">,</span> dispatch<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>把待更新的pendingQueue合并到baseQueue，循环更新</p> <h2 id="四-处理副作用"><a href="#四-处理副作用" class="header-anchor">#</a> 四 处理副作用</h2> <h3 id="初始化"><a href="#初始化" class="header-anchor">#</a> 初始化</h3> <h3 id="更新"><a href="#更新" class="header-anchor">#</a> 更新</h3> <h3 id="不同的effect"><a href="#不同的effect" class="header-anchor">#</a> 不同的effect</h3> <h2 id="五-状态获取与状态缓存"><a href="#五-状态获取与状态缓存" class="header-anchor">#</a> 五 状态获取与状态缓存</h2> <h3 id="_1-对于-ref-处理"><a href="#_1-对于-ref-处理" class="header-anchor">#</a> 1 对于 ref 处理</h3> <h3 id="_2-对于usememo的处理"><a href="#_2-对于usememo的处理" class="header-anchor">#</a> 2 对于useMemo的处理</h3> <h2 id="六-总结"><a href="#六-总结" class="header-anchor">#</a> 六 总结</h2></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/react/react进阶实践指南/优化篇.html" class="prev">
        渲染控制
      </a></span> <span class="next"><a href="/react/react进阶实践指南/原理篇2.html">
        context原理
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.b51e4ccd.js" defer></script><script src="/assets/js/2.7229199a.js" defer></script><script src="/assets/js/56.3a62759d.js" defer></script>
  </body>
</html>
