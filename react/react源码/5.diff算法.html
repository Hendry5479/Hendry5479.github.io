<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>英俊的大亨亨</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="heng.png">
    <meta name="description" content="记录下有趣岁月的点点滴滴">
    
    <link rel="preload" href="/assets/css/0.styles.e4d8b86b.css" as="style"><link rel="preload" href="/assets/js/app.b51e4ccd.js" as="script"><link rel="preload" href="/assets/js/2.7229199a.js" as="script"><link rel="preload" href="/assets/js/44.5160f68a.js" as="script"><link rel="prefetch" href="/assets/js/10.00f8a9d8.js"><link rel="prefetch" href="/assets/js/100.78dfd44a.js"><link rel="prefetch" href="/assets/js/101.cdae98a0.js"><link rel="prefetch" href="/assets/js/102.6a3dd9e0.js"><link rel="prefetch" href="/assets/js/103.cfed07a2.js"><link rel="prefetch" href="/assets/js/104.a16a4843.js"><link rel="prefetch" href="/assets/js/105.9cd1add0.js"><link rel="prefetch" href="/assets/js/106.546c1ad8.js"><link rel="prefetch" href="/assets/js/107.04b38bf9.js"><link rel="prefetch" href="/assets/js/108.31a22b61.js"><link rel="prefetch" href="/assets/js/109.1f2a1840.js"><link rel="prefetch" href="/assets/js/11.e2689dc6.js"><link rel="prefetch" href="/assets/js/110.9dc2f13b.js"><link rel="prefetch" href="/assets/js/111.35cf70f8.js"><link rel="prefetch" href="/assets/js/112.39a6579b.js"><link rel="prefetch" href="/assets/js/113.cbfc279d.js"><link rel="prefetch" href="/assets/js/114.878470a2.js"><link rel="prefetch" href="/assets/js/115.86dc4d8e.js"><link rel="prefetch" href="/assets/js/116.d2e05b2c.js"><link rel="prefetch" href="/assets/js/117.7525671d.js"><link rel="prefetch" href="/assets/js/118.a5c04c6d.js"><link rel="prefetch" href="/assets/js/119.613a81e1.js"><link rel="prefetch" href="/assets/js/12.0b7aaea4.js"><link rel="prefetch" href="/assets/js/120.ec6d3159.js"><link rel="prefetch" href="/assets/js/121.6705f783.js"><link rel="prefetch" href="/assets/js/122.7b3fe034.js"><link rel="prefetch" href="/assets/js/123.9336f454.js"><link rel="prefetch" href="/assets/js/124.dca9fc87.js"><link rel="prefetch" href="/assets/js/125.338aa4d8.js"><link rel="prefetch" href="/assets/js/126.a731a9eb.js"><link rel="prefetch" href="/assets/js/127.da74dd90.js"><link rel="prefetch" href="/assets/js/128.3d5e86f2.js"><link rel="prefetch" href="/assets/js/129.ee43b65c.js"><link rel="prefetch" href="/assets/js/13.31064a46.js"><link rel="prefetch" href="/assets/js/130.8a273d75.js"><link rel="prefetch" href="/assets/js/131.a89df4ac.js"><link rel="prefetch" href="/assets/js/132.0daac28c.js"><link rel="prefetch" href="/assets/js/133.b1f23c92.js"><link rel="prefetch" href="/assets/js/134.78621a9c.js"><link rel="prefetch" href="/assets/js/135.f0884a8b.js"><link rel="prefetch" href="/assets/js/136.45114430.js"><link rel="prefetch" href="/assets/js/137.eb295fce.js"><link rel="prefetch" href="/assets/js/138.cc7dc8d3.js"><link rel="prefetch" href="/assets/js/139.c9b1aad6.js"><link rel="prefetch" href="/assets/js/14.0be4ee49.js"><link rel="prefetch" href="/assets/js/15.685fab30.js"><link rel="prefetch" href="/assets/js/16.97f8b16a.js"><link rel="prefetch" href="/assets/js/17.9c7bebeb.js"><link rel="prefetch" href="/assets/js/18.965d9e47.js"><link rel="prefetch" href="/assets/js/19.3d59a8e1.js"><link rel="prefetch" href="/assets/js/20.1573d510.js"><link rel="prefetch" href="/assets/js/21.f46234dd.js"><link rel="prefetch" href="/assets/js/22.6c16fd38.js"><link rel="prefetch" href="/assets/js/23.50a2a38a.js"><link rel="prefetch" href="/assets/js/24.8aff8273.js"><link rel="prefetch" href="/assets/js/25.35a7c496.js"><link rel="prefetch" href="/assets/js/26.af233874.js"><link rel="prefetch" href="/assets/js/27.a3a96a5a.js"><link rel="prefetch" href="/assets/js/28.a1d49602.js"><link rel="prefetch" href="/assets/js/29.174b7d7d.js"><link rel="prefetch" href="/assets/js/3.6038f64c.js"><link rel="prefetch" href="/assets/js/30.a4115d32.js"><link rel="prefetch" href="/assets/js/31.1522875a.js"><link rel="prefetch" href="/assets/js/32.35da527d.js"><link rel="prefetch" href="/assets/js/33.814d63e8.js"><link rel="prefetch" href="/assets/js/34.615b49c1.js"><link rel="prefetch" href="/assets/js/35.856ab789.js"><link rel="prefetch" href="/assets/js/36.2987bc62.js"><link rel="prefetch" href="/assets/js/37.084d12aa.js"><link rel="prefetch" href="/assets/js/38.088f3091.js"><link rel="prefetch" href="/assets/js/39.4ea066d5.js"><link rel="prefetch" href="/assets/js/4.c610d016.js"><link rel="prefetch" href="/assets/js/40.97850ba9.js"><link rel="prefetch" href="/assets/js/41.8b8ae086.js"><link rel="prefetch" href="/assets/js/42.8ae2cac3.js"><link rel="prefetch" href="/assets/js/43.f8a28187.js"><link rel="prefetch" href="/assets/js/45.6d4b7130.js"><link rel="prefetch" href="/assets/js/46.44693348.js"><link rel="prefetch" href="/assets/js/47.eb0ac18a.js"><link rel="prefetch" href="/assets/js/48.ce1c6335.js"><link rel="prefetch" href="/assets/js/49.7ec1b16a.js"><link rel="prefetch" href="/assets/js/5.216dfe20.js"><link rel="prefetch" href="/assets/js/50.1f503aa4.js"><link rel="prefetch" href="/assets/js/51.47971163.js"><link rel="prefetch" href="/assets/js/52.e5f681d7.js"><link rel="prefetch" href="/assets/js/53.df89fbb7.js"><link rel="prefetch" href="/assets/js/54.a140a8dd.js"><link rel="prefetch" href="/assets/js/55.5809711e.js"><link rel="prefetch" href="/assets/js/56.3a62759d.js"><link rel="prefetch" href="/assets/js/57.c9bd4339.js"><link rel="prefetch" href="/assets/js/58.acb475d1.js"><link rel="prefetch" href="/assets/js/59.61cf3322.js"><link rel="prefetch" href="/assets/js/6.73a8f323.js"><link rel="prefetch" href="/assets/js/60.aa39146e.js"><link rel="prefetch" href="/assets/js/61.f62972b8.js"><link rel="prefetch" href="/assets/js/62.79fc1ddc.js"><link rel="prefetch" href="/assets/js/63.808c750c.js"><link rel="prefetch" href="/assets/js/64.4e99e2e1.js"><link rel="prefetch" href="/assets/js/65.f112caec.js"><link rel="prefetch" href="/assets/js/66.422cc6c9.js"><link rel="prefetch" href="/assets/js/67.f504a803.js"><link rel="prefetch" href="/assets/js/68.f8e84a65.js"><link rel="prefetch" href="/assets/js/69.af07ae00.js"><link rel="prefetch" href="/assets/js/7.a6e60d89.js"><link rel="prefetch" href="/assets/js/70.9b212396.js"><link rel="prefetch" href="/assets/js/71.049b7d3e.js"><link rel="prefetch" href="/assets/js/72.b508f834.js"><link rel="prefetch" href="/assets/js/73.52a25a21.js"><link rel="prefetch" href="/assets/js/74.68de4c01.js"><link rel="prefetch" href="/assets/js/75.c0d8e99a.js"><link rel="prefetch" href="/assets/js/76.672b246e.js"><link rel="prefetch" href="/assets/js/77.36d886e3.js"><link rel="prefetch" href="/assets/js/78.079ebfd8.js"><link rel="prefetch" href="/assets/js/79.d3d3e8ea.js"><link rel="prefetch" href="/assets/js/8.a72c567f.js"><link rel="prefetch" href="/assets/js/80.c690c3d9.js"><link rel="prefetch" href="/assets/js/81.c012b7d5.js"><link rel="prefetch" href="/assets/js/82.47ffa460.js"><link rel="prefetch" href="/assets/js/83.2ba84114.js"><link rel="prefetch" href="/assets/js/84.dc0bf5a8.js"><link rel="prefetch" href="/assets/js/85.d968ae8b.js"><link rel="prefetch" href="/assets/js/86.91000a3b.js"><link rel="prefetch" href="/assets/js/87.6e885c71.js"><link rel="prefetch" href="/assets/js/88.99dd2b79.js"><link rel="prefetch" href="/assets/js/89.601c57ea.js"><link rel="prefetch" href="/assets/js/9.c59ba06b.js"><link rel="prefetch" href="/assets/js/90.89ee0da5.js"><link rel="prefetch" href="/assets/js/91.854de449.js"><link rel="prefetch" href="/assets/js/92.7a25d006.js"><link rel="prefetch" href="/assets/js/93.17f89281.js"><link rel="prefetch" href="/assets/js/94.0f6749b9.js"><link rel="prefetch" href="/assets/js/95.41ef6f4a.js"><link rel="prefetch" href="/assets/js/96.12427920.js"><link rel="prefetch" href="/assets/js/97.53036963.js"><link rel="prefetch" href="/assets/js/98.43d8f870.js"><link rel="prefetch" href="/assets/js/99.4ab32fce.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e4d8b86b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/heng.png" alt="英俊的大亨亨" class="logo"> <span class="site-name can-hide">英俊的大亨亨</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Language Menu" class="dropdown-title"><span class="title">js</span> <span class="arrow down"></span></button> <button type="button" aria-label="Language Menu" class="mobile-dropdown-title"><span class="title">js</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/js/js-基础.html" class="nav-link">
  基础
</a></li><li class="dropdown-item"><!----> <a href="/js/js-数组.html" class="nav-link">
  数组
</a></li><li class="dropdown-item"><!----> <a href="/js/js-异步.html" class="nav-link">
  异步
</a></li><li class="dropdown-item"><!----> <a href="/js/js-es6.html" class="nav-link">
  es6
</a></li><li class="dropdown-item"><!----> <a href="/js/js-v8引擎.html" class="nav-link">
  v8
</a></li><li class="dropdown-item"><!----> <a href="/手写代码/1.js基础.html" class="nav-link">
  手写
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Language Menu" class="dropdown-title"><span class="title">前端基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="Language Menu" class="mobile-dropdown-title"><span class="title">前端基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          前端基础
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/react/process.html" class="nav-link">
  
</a></li></ul></li><li class="dropdown-item"><!----> <a href="/html.html" class="nav-link">
  html
</a></li><li class="dropdown-item"><!----> <a href="/css.html" class="nav-link">
  css
</a></li><li class="dropdown-item"><!----> <a href="/node.html" class="nav-link">
  node
</a></li><li class="dropdown-item"><!----> <a href="/webpack.html" class="nav-link">
  webpack
</a></li><li class="dropdown-item"><!----> <a href="/webpack.html" class="nav-link">
  小程序
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="leetcode" class="dropdown-title"><span class="title">leetcode</span> <span class="arrow down"></span></button> <button type="button" aria-label="leetcode" class="mobile-dropdown-title"><span class="title">leetcode</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/代码随想录/1.数组.html" class="nav-link">
  1.数组
</a></li><li class="dropdown-item"><!----> <a href="/代码随想录/10.动态规划/1.基础.html" class="nav-link">
  10.动态规划
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Language Menu" class="dropdown-title"><span class="title">react源码</span> <span class="arrow down"></span></button> <button type="button" aria-label="Language Menu" class="mobile-dropdown-title"><span class="title">react源码</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/react源码/理念.html" class="nav-link">
  1.理念
</a></li><li class="dropdown-item"><!----> <a href="/react源码/3.render.html" class="nav-link">
  3.render
</a></li><li class="dropdown-item"><!----> <a href="/react源码/4.commit.html" class="nav-link">
  4.commit
</a></li><li class="dropdown-item"><!----> <a href="/react源码/5.状态更新.html" class="nav-link">
  5.状态更新
</a></li><li class="dropdown-item"><!----> <a href="/react源码/6.diff.html" class="nav-link">
  6.diff
</a></li><li class="dropdown-item"><!----> <a href="/react/7.实现hooks.html" class="nav-link">
  7.实现hooks
</a></li><li class="dropdown-item"><!----> <a href="/react/8.concurrentMode.html" class="nav-link">
  8.concurrentMode
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Language Menu" class="dropdown-title"><span class="title">webpack</span> <span class="arrow down"></span></button> <button type="button" aria-label="Language Menu" class="mobile-dropdown-title"><span class="title">webpack</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/webpack/1.配置.html" class="nav-link">
  1.配置
</a></li><li class="dropdown-item"><!----> <a href="/webpack/2.loader.html" class="nav-link">
  2.loader
</a></li><li class="dropdown-item"><!----> <a href="/webpack/3.plugin.html" class="nav-link">
  3.plugin
</a></li><li class="dropdown-item"><!----> <a href="/webpack/4.模块化原理.html" class="nav-link">
  4.模块化原理
</a></li><li class="dropdown-item"><!----> <a href="/webpack/5.babel.html" class="nav-link">
  5.babel
</a></li><li class="dropdown-item"><!----> <a href="/webpack/6.HMR.html" class="nav-link">
  6.HMR
</a></li><li class="dropdown-item"><!----> <a href="/webpack/7.环境分离.html" class="nav-link">
  7.环境分离
</a></li><li class="dropdown-item"><!----> <a href="/webpack/8.tree_shaking.html" class="nav-link">
  8.tree_shaking
</a></li><li class="dropdown-item"><!----> <a href="/webpack/9,源码.html" class="nav-link">
  9.源码
</a></li><li class="dropdown-item"><!----> <a href="/webpack/11.自定义loader.html" class="nav-link">
  11.自定义loader
</a></li><li class="dropdown-item"><!----> <a href="/webpack/12.自定义plugin.html" class="nav-link">
  12.自定义plugin
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Language Menu" class="dropdown-title"><span class="title">前端设计模式</span> <span class="arrow down"></span></button> <button type="button" aria-label="Language Menu" class="mobile-dropdown-title"><span class="title">前端设计模式</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/设计模式/创建型.html" class="nav-link">
  创建型
</a></li><li class="dropdown-item"><!----> <a href="/设计模式/结构型.html" class="nav-link">
  结构型
</a></li><li class="dropdown-item"><!----> <a href="/设计模式/行为型.html" class="nav-link">
  行为型
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Language Menu" class="dropdown-title"><span class="title">angular</span> <span class="arrow down"></span></button> <button type="button" aria-label="Language Menu" class="mobile-dropdown-title"><span class="title">angular</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/react/react%E6%BA%90%E7%A0%81/.html" class="nav-link">
  angular性能调优
</a></li><li class="dropdown-item"><!----> <a href="/设计模式/结构型.html" class="nav-link">
  angular源码理解
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Language Menu" class="dropdown-title"><span class="title">健身</span> <span class="arrow down"></span></button> <button type="button" aria-label="Language Menu" class="mobile-dropdown-title"><span class="title">健身</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/react/react%E6%BA%90%E7%A0%81/.html" class="nav-link">
  angular性能调优
</a></li><li class="dropdown-item"><!----> <a href="/设计模式/结构型.html" class="nav-link">
  angular源码理解
</a></li></ul></div></div><div class="nav-item"><a href="/me.html" class="nav-link">
  关于我
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Language Menu" class="dropdown-title"><span class="title">js</span> <span class="arrow down"></span></button> <button type="button" aria-label="Language Menu" class="mobile-dropdown-title"><span class="title">js</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/js/js-基础.html" class="nav-link">
  基础
</a></li><li class="dropdown-item"><!----> <a href="/js/js-数组.html" class="nav-link">
  数组
</a></li><li class="dropdown-item"><!----> <a href="/js/js-异步.html" class="nav-link">
  异步
</a></li><li class="dropdown-item"><!----> <a href="/js/js-es6.html" class="nav-link">
  es6
</a></li><li class="dropdown-item"><!----> <a href="/js/js-v8引擎.html" class="nav-link">
  v8
</a></li><li class="dropdown-item"><!----> <a href="/手写代码/1.js基础.html" class="nav-link">
  手写
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Language Menu" class="dropdown-title"><span class="title">前端基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="Language Menu" class="mobile-dropdown-title"><span class="title">前端基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          前端基础
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/react/process.html" class="nav-link">
  
</a></li></ul></li><li class="dropdown-item"><!----> <a href="/html.html" class="nav-link">
  html
</a></li><li class="dropdown-item"><!----> <a href="/css.html" class="nav-link">
  css
</a></li><li class="dropdown-item"><!----> <a href="/node.html" class="nav-link">
  node
</a></li><li class="dropdown-item"><!----> <a href="/webpack.html" class="nav-link">
  webpack
</a></li><li class="dropdown-item"><!----> <a href="/webpack.html" class="nav-link">
  小程序
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="leetcode" class="dropdown-title"><span class="title">leetcode</span> <span class="arrow down"></span></button> <button type="button" aria-label="leetcode" class="mobile-dropdown-title"><span class="title">leetcode</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/代码随想录/1.数组.html" class="nav-link">
  1.数组
</a></li><li class="dropdown-item"><!----> <a href="/代码随想录/10.动态规划/1.基础.html" class="nav-link">
  10.动态规划
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Language Menu" class="dropdown-title"><span class="title">react源码</span> <span class="arrow down"></span></button> <button type="button" aria-label="Language Menu" class="mobile-dropdown-title"><span class="title">react源码</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/react源码/理念.html" class="nav-link">
  1.理念
</a></li><li class="dropdown-item"><!----> <a href="/react源码/3.render.html" class="nav-link">
  3.render
</a></li><li class="dropdown-item"><!----> <a href="/react源码/4.commit.html" class="nav-link">
  4.commit
</a></li><li class="dropdown-item"><!----> <a href="/react源码/5.状态更新.html" class="nav-link">
  5.状态更新
</a></li><li class="dropdown-item"><!----> <a href="/react源码/6.diff.html" class="nav-link">
  6.diff
</a></li><li class="dropdown-item"><!----> <a href="/react/7.实现hooks.html" class="nav-link">
  7.实现hooks
</a></li><li class="dropdown-item"><!----> <a href="/react/8.concurrentMode.html" class="nav-link">
  8.concurrentMode
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Language Menu" class="dropdown-title"><span class="title">webpack</span> <span class="arrow down"></span></button> <button type="button" aria-label="Language Menu" class="mobile-dropdown-title"><span class="title">webpack</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/webpack/1.配置.html" class="nav-link">
  1.配置
</a></li><li class="dropdown-item"><!----> <a href="/webpack/2.loader.html" class="nav-link">
  2.loader
</a></li><li class="dropdown-item"><!----> <a href="/webpack/3.plugin.html" class="nav-link">
  3.plugin
</a></li><li class="dropdown-item"><!----> <a href="/webpack/4.模块化原理.html" class="nav-link">
  4.模块化原理
</a></li><li class="dropdown-item"><!----> <a href="/webpack/5.babel.html" class="nav-link">
  5.babel
</a></li><li class="dropdown-item"><!----> <a href="/webpack/6.HMR.html" class="nav-link">
  6.HMR
</a></li><li class="dropdown-item"><!----> <a href="/webpack/7.环境分离.html" class="nav-link">
  7.环境分离
</a></li><li class="dropdown-item"><!----> <a href="/webpack/8.tree_shaking.html" class="nav-link">
  8.tree_shaking
</a></li><li class="dropdown-item"><!----> <a href="/webpack/9,源码.html" class="nav-link">
  9.源码
</a></li><li class="dropdown-item"><!----> <a href="/webpack/11.自定义loader.html" class="nav-link">
  11.自定义loader
</a></li><li class="dropdown-item"><!----> <a href="/webpack/12.自定义plugin.html" class="nav-link">
  12.自定义plugin
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Language Menu" class="dropdown-title"><span class="title">前端设计模式</span> <span class="arrow down"></span></button> <button type="button" aria-label="Language Menu" class="mobile-dropdown-title"><span class="title">前端设计模式</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/设计模式/创建型.html" class="nav-link">
  创建型
</a></li><li class="dropdown-item"><!----> <a href="/设计模式/结构型.html" class="nav-link">
  结构型
</a></li><li class="dropdown-item"><!----> <a href="/设计模式/行为型.html" class="nav-link">
  行为型
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Language Menu" class="dropdown-title"><span class="title">angular</span> <span class="arrow down"></span></button> <button type="button" aria-label="Language Menu" class="mobile-dropdown-title"><span class="title">angular</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/react/react%E6%BA%90%E7%A0%81/.html" class="nav-link">
  angular性能调优
</a></li><li class="dropdown-item"><!----> <a href="/设计模式/结构型.html" class="nav-link">
  angular源码理解
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Language Menu" class="dropdown-title"><span class="title">健身</span> <span class="arrow down"></span></button> <button type="button" aria-label="Language Menu" class="mobile-dropdown-title"><span class="title">健身</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/react/react%E6%BA%90%E7%A0%81/.html" class="nav-link">
  angular性能调优
</a></li><li class="dropdown-item"><!----> <a href="/设计模式/结构型.html" class="nav-link">
  angular源码理解
</a></li></ul></div></div><div class="nav-item"><a href="/me.html" class="nav-link">
  关于我
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>react源码</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/react/react源码/1.理念篇.html" class="sidebar-link">理念篇</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/react/react源码/1.理念篇.html#_1-react16架构" class="sidebar-link">1. React16架构</a></li><li class="sidebar-sub-header"><a href="/react/react源码/1.理念篇.html#_2-fiber结构" class="sidebar-link">2. Fiber结构</a></li><li class="sidebar-sub-header"><a href="/react/react源码/1.理念篇.html#_3-双缓存fiber树" class="sidebar-link">3. 双缓存Fiber树</a></li></ul></li><li><a href="/react/react源码/3.render.html" class="sidebar-link">Reconcile（render阶段）</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/react/react源码/3.render.html#递-阶段" class="sidebar-link">“递”阶段</a></li><li class="sidebar-sub-header"><a href="/react/react源码/3.render.html#归-阶段" class="sidebar-link">“归”阶段</a></li><li class="sidebar-sub-header"><a href="/react/react源码/3.render.html#update时" class="sidebar-link">update时</a></li><li class="sidebar-sub-header"><a href="/react/react源码/3.render.html#mount时" class="sidebar-link">mount时</a></li><li class="sidebar-sub-header"><a href="/react/react源码/3.render.html#reconcilechildren" class="sidebar-link">reconcileChildren</a></li><li class="sidebar-sub-header"><a href="/react/react源码/3.render.html#effecttag" class="sidebar-link">effectTag</a></li><li class="sidebar-sub-header"><a href="/react/react源码/3.render.html#流程概览" class="sidebar-link">流程概览</a></li><li class="sidebar-sub-header"><a href="/react/react源码/3.render.html#处理hostcomponent" class="sidebar-link">处理HostComponent</a></li><li class="sidebar-sub-header"><a href="/react/react源码/3.render.html#update时-2" class="sidebar-link">update时</a></li><li class="sidebar-sub-header"><a href="/react/react源码/3.render.html#mount时-2" class="sidebar-link">mount时</a></li><li class="sidebar-sub-header"><a href="/react/react源码/3.render.html#effectlist" class="sidebar-link">effectList</a></li><li class="sidebar-sub-header"><a href="/react/react源码/3.render.html#流程结尾" class="sidebar-link">流程结尾</a></li></ul></li><li><a href="/react/react源码/4.commit.html" class="sidebar-link">/react/react源码/4.commit.html</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/react/react源码/4.commit.html#before-mutation之前" class="sidebar-link">before mutation之前</a></li><li class="sidebar-sub-header"><a href="/react/react源码/4.commit.html#layout之后" class="sidebar-link">layout之后</a></li><li class="sidebar-sub-header"><a href="/react/react源码/4.commit.html#beforemutation" class="sidebar-link">beforeMutation</a></li><li class="sidebar-sub-header"><a href="/react/react源码/4.commit.html#commitbeforemutationeffects" class="sidebar-link">commitBeforeMutationEffects</a></li><li class="sidebar-sub-header"><a href="/react/react源码/4.commit.html#调用getsnapshotbeforeupdate" class="sidebar-link">调用getSnapshotBeforeUpdate</a></li><li class="sidebar-sub-header"><a href="/react/react源码/4.commit.html#调度useeffect" class="sidebar-link">调度useEffect</a></li><li class="sidebar-sub-header"><a href="/react/react源码/4.commit.html#总结" class="sidebar-link">总结</a></li><li class="sidebar-sub-header"><a href="/react/react源码/4.commit.html#概览" class="sidebar-link">概览</a></li><li class="sidebar-sub-header"><a href="/react/react源码/4.commit.html#commitmutationeffects" class="sidebar-link">commitMutationEffects</a></li><li class="sidebar-sub-header"><a href="/react/react源码/4.commit.html#placement-effect" class="sidebar-link">Placement effect</a></li><li class="sidebar-sub-header"><a href="/react/react源码/4.commit.html#update-effect" class="sidebar-link">Update effect</a></li><li class="sidebar-sub-header"><a href="/react/react源码/4.commit.html#deletion-effect" class="sidebar-link">Deletion effect</a></li><li class="sidebar-sub-header"><a href="/react/react源码/4.commit.html#总结-2" class="sidebar-link">总结</a></li><li class="sidebar-sub-header"><a href="/react/react源码/4.commit.html#概览-2" class="sidebar-link">概览</a></li><li class="sidebar-sub-header"><a href="/react/react源码/4.commit.html#commitlayouteffects" class="sidebar-link">commitLayoutEffects</a></li><li class="sidebar-sub-header"><a href="/react/react源码/4.commit.html#commitlayouteffectonfiber" class="sidebar-link">commitLayoutEffectOnFiber</a></li><li class="sidebar-sub-header"><a href="/react/react源码/4.commit.html#commitattachref" class="sidebar-link">commitAttachRef</a></li><li class="sidebar-sub-header"><a href="/react/react源码/4.commit.html#current-fiber树切换" class="sidebar-link">current Fiber树切换</a></li><li class="sidebar-sub-header"><a href="/react/react源码/4.commit.html#总结-3" class="sidebar-link">总结</a></li></ul></li><li><a href="/react/react源码/5.diff算法.html" class="active sidebar-link">/react/react源码/5.diff算法.html</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/react/react源码/5.diff算法.html#diff的瓶颈以及react如何应对" class="sidebar-link">Diff的瓶颈以及React如何应对</a></li><li class="sidebar-sub-header"><a href="/react/react源码/5.diff算法.html#diff是如何实现的" class="sidebar-link">Diff是如何实现的</a></li><li class="sidebar-sub-header"><a href="/react/react源码/5.diff算法.html#练习题" class="sidebar-link">[#](https://react.iamkasong.com/diff/one.html#练习题)练习题</a></li><li class="sidebar-sub-header"><a href="/react/react源码/5.diff算法.html#概览" class="sidebar-link">[#](https://react.iamkasong.com/diff/multi.html#概览)概览</a></li><li class="sidebar-sub-header"><a href="/react/react源码/5.diff算法.html#diff的思路" class="sidebar-link">[#](https://react.iamkasong.com/diff/multi.html#diff的思路)Diff的思路</a></li><li class="sidebar-sub-header"><a href="/react/react源码/5.diff算法.html#第一轮遍历" class="sidebar-link">[#](https://react.iamkasong.com/diff/multi.html#第一轮遍历)第一轮遍历</a></li><li class="sidebar-sub-header"><a href="/react/react源码/5.diff算法.html#第二轮遍历" class="sidebar-link">[#](https://react.iamkasong.com/diff/multi.html#第二轮遍历)第二轮遍历</a></li><li class="sidebar-sub-header"><a href="/react/react源码/5.diff算法.html#处理移动的节点" class="sidebar-link">[#](https://react.iamkasong.com/diff/multi.html#处理移动的节点)处理移动的节点</a></li><li class="sidebar-sub-header"><a href="/react/react源码/5.diff算法.html#标记节点是否移动" class="sidebar-link">[#](https://react.iamkasong.com/diff/multi.html#标记节点是否移动)标记节点是否移动</a></li><li class="sidebar-sub-header"><a href="/react/react源码/5.diff算法.html#demo1" class="sidebar-link">[#](https://react.iamkasong.com/diff/multi.html#demo1)Demo1</a></li><li class="sidebar-sub-header"><a href="/react/react源码/5.diff算法.html#demo2" class="sidebar-link">[#](https://react.iamkasong.com/diff/multi.html#demo2)Demo2</a></li></ul></li><li><a href="/react/react源码/6.1.状态更新.html" class="sidebar-link">几个关键节点</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/react/react源码/6.1.状态更新.html#几个关键节点" class="sidebar-link">几个关键节点</a></li><li class="sidebar-sub-header"><a href="/react/react源码/6.1.状态更新.html#总结" class="sidebar-link">总结</a></li><li class="sidebar-sub-header"><a href="/react/react源码/6.1.状态更新.html#" class="sidebar-link"></a></li><li class="sidebar-sub-header"><a href="/react/react源码/6.1.状态更新.html#同步更新的react" class="sidebar-link">同步更新的React</a></li><li class="sidebar-sub-header"><a href="/react/react源码/6.1.状态更新.html#并发更新的react" class="sidebar-link">[#](https://react.iamkasong.com/state/mental.html#并发更新的react)并发更新的React</a></li><li class="sidebar-sub-header"><a href="/react/react源码/6.1.状态更新.html#update的分类" class="sidebar-link">Update的分类</a></li><li class="sidebar-sub-header"><a href="/react/react源码/6.1.状态更新.html#update的结构" class="sidebar-link">Update的结构</a></li><li class="sidebar-sub-header"><a href="/react/react源码/6.1.状态更新.html#update与fiber的联系" class="sidebar-link">Update与Fiber的联系</a></li><li class="sidebar-sub-header"><a href="/react/react源码/6.1.状态更新.html#updatequeue" class="sidebar-link">updateQueue</a></li><li class="sidebar-sub-header"><a href="/react/react源码/6.1.状态更新.html#例子" class="sidebar-link">例子</a></li></ul></li><li><a href="/react/react源码/6.2.优先级.html" class="sidebar-link">什么是优先级</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/react/react源码/6.2.优先级.html#什么是优先级" class="sidebar-link">什么是优先级</a></li><li class="sidebar-sub-header"><a href="/react/react源码/6.2.优先级.html#如何调度优先级" class="sidebar-link">[#](https://react.iamkasong.com/state/priority.html#如何调度优先级)如何调度优先级</a></li><li class="sidebar-sub-header"><a href="/react/react源码/6.2.优先级.html#例子" class="sidebar-link">[#](https://react.iamkasong.com/state/priority.html#例子)例子</a></li><li class="sidebar-sub-header"><a href="/react/react源码/6.2.优先级.html#如何保证状态正确" class="sidebar-link">[#](https://react.iamkasong.com/state/priority.html#如何保证状态正确)如何保证状态正确</a></li><li class="sidebar-sub-header"><a href="/react/react源码/6.2.优先级.html#创建fiber" class="sidebar-link">[#](https://react.iamkasong.com/state/reactdom.html#创建fiber)创建fiber</a></li><li class="sidebar-sub-header"><a href="/react/react源码/6.2.优先级.html#创建update" class="sidebar-link">[#](https://react.iamkasong.com/state/reactdom.html#创建update)创建update</a></li><li class="sidebar-sub-header"><a href="/react/react源码/6.2.优先级.html#流程概览" class="sidebar-link">[#](https://react.iamkasong.com/state/reactdom.html#流程概览)流程概览</a></li><li class="sidebar-sub-header"><a href="/react/react源码/6.2.优先级.html#react的其他入口函数" class="sidebar-link">[#](https://react.iamkasong.com/state/reactdom.html#react的其他入口函数)React的其他入口函数</a></li><li class="sidebar-sub-header"><a href="/react/react源码/6.2.优先级.html#流程概览-2" class="sidebar-link">[#](https://react.iamkasong.com/state/setstate.html#流程概览)流程概览</a></li><li class="sidebar-sub-header"><a href="/react/react源码/6.2.优先级.html#this-forceupdate" class="sidebar-link">[#](https://react.iamkasong.com/state/setstate.html#this-forceupdate)this.forceUpdate</a></li><li class="sidebar-sub-header"><a href="/react/react源码/6.2.优先级.html#总结" class="sidebar-link">[#](https://react.iamkasong.com/state/setstate.html#总结)总结</a></li></ul></li><li><a href="/react/react源码/7.1.实现hooks.html" class="sidebar-link">/react/react源码/7.1.实现hooks.html</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/react/react源码/7.1.实现hooks.html#从logo聊起" class="sidebar-link">[#](https://react.iamkasong.com/hooks/prepare.html#从logo聊起)从LOGO聊起</a></li><li class="sidebar-sub-header"><a href="/react/react源码/7.1.实现hooks.html#总结" class="sidebar-link">[#](https://react.iamkasong.com/hooks/prepare.html#总结)总结</a></li><li class="sidebar-sub-header"><a href="/react/react源码/7.1.实现hooks.html#工作原理" class="sidebar-link">工作原理</a></li><li class="sidebar-sub-header"><a href="/react/react源码/7.1.实现hooks.html#更新是什么" class="sidebar-link">更新是什么</a></li><li class="sidebar-sub-header"><a href="/react/react源码/7.1.实现hooks.html#update数据结构" class="sidebar-link">update数据结构</a></li><li class="sidebar-sub-header"><a href="/react/react源码/7.1.实现hooks.html#状态如何保存" class="sidebar-link">状态如何保存</a></li><li class="sidebar-sub-header"><a href="/react/react源码/7.1.实现hooks.html#hook数据结构" class="sidebar-link">Hook数据结构</a></li><li class="sidebar-sub-header"><a href="/react/react源码/7.1.实现hooks.html#模拟react调度更新流程" class="sidebar-link">模拟React调度更新流程</a></li><li class="sidebar-sub-header"><a href="/react/react源码/7.1.实现hooks.html#计算state" class="sidebar-link">计算state</a></li><li class="sidebar-sub-header"><a href="/react/react源码/7.1.实现hooks.html#对触发事件进行抽象" class="sidebar-link">对触发事件进行抽象</a></li><li class="sidebar-sub-header"><a href="/react/react源码/7.1.实现hooks.html#在线demo" class="sidebar-link">在线Demo</a></li><li class="sidebar-sub-header"><a href="/react/react源码/7.1.实现hooks.html#与react的区别" class="sidebar-link">与React的区别</a></li></ul></li><li><a href="/react/react源码/7.2.useState和useReducer.html" class="sidebar-link">dispatcher</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/react/react源码/7.2.useState和useReducer.html#dispatcher" class="sidebar-link">dispatcher</a></li><li class="sidebar-sub-header"><a href="/react/react源码/7.2.useState和useReducer.html#一个dispatcher使用场景" class="sidebar-link">[#](https://react.iamkasong.com/hooks/structure.html#一个dispatcher使用场景)一个dispatcher使用场景</a></li><li class="sidebar-sub-header"><a href="/react/react源码/7.2.useState和useReducer.html#hook的数据结构" class="sidebar-link">[#](https://react.iamkasong.com/hooks/structure.html#hook的数据结构)Hook的数据结构</a></li><li class="sidebar-sub-header"><a href="/react/react源码/7.2.useState和useReducer.html#memoizedstate" class="sidebar-link">[#](https://react.iamkasong.com/hooks/structure.html#memoizedstate)memoizedState</a></li><li class="sidebar-sub-header"><a href="/react/react源码/7.2.useState和useReducer.html#流程概览" class="sidebar-link">[#](https://react.iamkasong.com/hooks/usestate.html#流程概览)流程概览</a></li><li class="sidebar-sub-header"><a href="/react/react源码/7.2.useState和useReducer.html#声明阶段" class="sidebar-link">[#](https://react.iamkasong.com/hooks/usestate.html#声明阶段)声明阶段</a></li><li class="sidebar-sub-header"><a href="/react/react源码/7.2.useState和useReducer.html#调用阶段" class="sidebar-link">[#](https://react.iamkasong.com/hooks/usestate.html#调用阶段)调用阶段</a></li><li class="sidebar-sub-header"><a href="/react/react源码/7.2.useState和useReducer.html#小tip" class="sidebar-link">[#](https://react.iamkasong.com/hooks/usestate.html#小tip)小Tip</a></li></ul></li><li><a href="/react/react源码/7.3.useEffect.html" class="sidebar-link">/react/react源码/7.3.useEffect.html</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/react/react源码/7.3.useEffect.html#flushpassiveeffectsimpl" class="sidebar-link">[#](https://react.iamkasong.com/hooks/useeffect.html#flushpassiveeffectsimpl)flushPassiveEffectsImpl</a></li><li class="sidebar-sub-header"><a href="/react/react源码/7.3.useEffect.html#阶段一-销毁函数的执行" class="sidebar-link">[#](https://react.iamkasong.com/hooks/useeffect.html#阶段一-销毁函数的执行)阶段一：销毁函数的执行</a></li><li class="sidebar-sub-header"><a href="/react/react源码/7.3.useEffect.html#阶段二-回调函数的执行" class="sidebar-link">[#](https://react.iamkasong.com/hooks/useeffect.html#阶段二-回调函数的执行)阶段二：回调函数的执行</a></li></ul></li><li><a href="/react/react源码/7.4.useRef和useMemo.html" class="sidebar-link">/react/react源码/7.4.useRef和useMemo.html</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/react/react源码/7.4.useRef和useMemo.html#useref" class="sidebar-link">[#](https://react.iamkasong.com/hooks/useref.html#useref)useRef</a></li><li class="sidebar-sub-header"><a href="/react/react源码/7.4.useRef和useMemo.html#ref的工作流程" class="sidebar-link">[#](https://react.iamkasong.com/hooks/useref.html#ref的工作流程)ref的工作流程</a></li><li class="sidebar-sub-header"><a href="/react/react源码/7.4.useRef和useMemo.html#render阶段" class="sidebar-link">[#](https://react.iamkasong.com/hooks/useref.html#render阶段)render阶段</a></li><li class="sidebar-sub-header"><a href="/react/react源码/7.4.useRef和useMemo.html#commit阶段" class="sidebar-link">[#](https://react.iamkasong.com/hooks/useref.html#commit阶段)commit阶段</a></li><li class="sidebar-sub-header"><a href="/react/react源码/7.4.useRef和useMemo.html#总结" class="sidebar-link">[#](https://react.iamkasong.com/hooks/useref.html#总结)总结</a></li><li class="sidebar-sub-header"><a href="/react/react源码/7.4.useRef和useMemo.html#mount" class="sidebar-link">mount</a></li><li class="sidebar-sub-header"><a href="/react/react源码/7.4.useRef和useMemo.html#update" class="sidebar-link">[#](https://react.iamkasong.com/hooks/usememo.html#update)update</a></li></ul></li><li><a href="/react/react源码/源码.html" class="sidebar-link">1. 理念篇</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/react/react源码/源码.html#_1-1-react的设计理念" class="sidebar-link">1.1 React的设计理念</a></li><li class="sidebar-sub-header"><a href="/react/react源码/源码.html#_1-2-架构演进" class="sidebar-link">1.2 架构演进</a></li><li class="sidebar-sub-header"><a href="/react/react源码/源码.html#_1-3-fiber架构的工作原理" class="sidebar-link">1.3 Fiber架构的工作原理</a></li><li class="sidebar-sub-header"><a href="/react/react源码/源码.html#_1-4-文件目录" class="sidebar-link">1.4 文件目录</a></li><li class="sidebar-sub-header"><a href="/react/react源码/源码.html#render" class="sidebar-link">render</a></li><li class="sidebar-sub-header"><a href="/react/react源码/源码.html#commit" class="sidebar-link">commit</a></li><li class="sidebar-sub-header"><a href="/react/react源码/源码.html#diff算法" class="sidebar-link">Diff算法</a></li><li class="sidebar-sub-header"><a href="/react/react源码/源码.html#状态更新" class="sidebar-link">状态更新</a></li><li class="sidebar-sub-header"><a href="/react/react源码/源码.html#生命周期" class="sidebar-link">生命周期</a></li><li class="sidebar-sub-header"><a href="/react/react源码/源码.html#hooks" class="sidebar-link">Hooks</a></li><li class="sidebar-sub-header"><a href="/react/react源码/源码.html#异步调度" class="sidebar-link">异步调度</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p>对于<code>update</code>的组件，他会将当前组件与该组件在上次更新时对应的Fiber节点比较（也就是俗称的Diff算法），将比较的结果生成新Fiber节点。</p> <p>为了防止概念混淆，这里再强调下</p> <p>一个<code>DOM节点</code>在某一时刻最多会有4个节点和他相关。</p> <ol><li><code>current Fiber</code>。如果该<code>DOM节点</code>已在页面中，<code>current Fiber</code>代表该<code>DOM节点</code>对应的<code>Fiber节点</code>。</li> <li><code>workInProgress Fiber</code>。如果该<code>DOM节点</code>将在本次更新中渲染到页面中，<code>workInProgress Fiber</code>代表该<code>DOM节点</code>对应的<code>Fiber节点</code>。</li> <li><code>DOM节点</code>本身。</li> <li><code>JSX对象</code>。即<code>ClassComponent</code>的<code>render</code>方法的返回结果，或<code>FunctionComponent</code>的调用结果。<code>JSX对象</code>中包含描述<code>DOM节点</code>的信息。</li></ol> <p><code>Diff算法</code>的本质是对比1和4，生成2。</p> <h2 id="diff的瓶颈以及react如何应对"><a href="#diff的瓶颈以及react如何应对" class="header-anchor">#</a> Diff的瓶颈以及React如何应对</h2> <p>由于<code>Diff</code>操作本身也会带来性能损耗，React文档中提到，即使在最前沿的算法中，将前后两棵树完全比对的算法的复杂程度为 O(n 3 )，其中<code>n</code>是树中元素的数量。</p> <p>如果在<code>React</code>中使用了该算法，那么展示1000个元素所需要执行的计算量将在十亿的量级范围。这个开销实在是太过高昂。</p> <p>为了降低算法复杂度，<code>React</code>的<code>diff</code>会预设三个限制：</p> <ol><li>只对同级元素进行<code>Diff</code>。如果一个<code>DOM节点</code>在前后两次更新中跨越了层级，那么<code>React</code>不会尝试复用他。</li> <li>两个不同类型的元素会产生出不同的树。如果元素由<code>div</code>变为<code>p</code>，React会销毁<code>div</code>及其子孙节点，并新建<code>p</code>及其子孙节点。</li> <li>开发者可以通过 <code>key prop</code>来暗示哪些子元素在不同的渲染下能保持稳定。考虑如下例子：</li></ol> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token comment">// 更新前</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ka<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">ka</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>song<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">song</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">// 更新后</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>song<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">song</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ka<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">ka</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>如果没有<code>key</code>，<code>React</code>会认为<code>div</code>的第一个子节点由<code>p</code>变为<code>h3</code>，第二个子节点由<code>h3</code>变为<code>p</code>。这符合限制2的设定，会销毁并新建。</p> <p>但是当我们用<code>key</code>指明了节点前后对应关系后，<code>React</code>知道<code>key === &quot;ka&quot;</code>的<code>p</code>在更新后还存在，所以<code>DOM节点</code>可以复用，只是需要交换下顺序。</p> <p>这就是<code>React</code>为了应对算法性能瓶颈做出的三条限制。</p> <h2 id="diff是如何实现的"><a href="#diff是如何实现的" class="header-anchor">#</a> Diff是如何实现的</h2> <p>我们从<code>Diff</code>的入口函数<code>reconcileChildFibers</code>出发，该函数会根据<code>newChild</code>（即<code>JSX对象</code>）类型调用不同的处理函数。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 根据newChild类型选择不同diff函数处理</span>
<span class="token keyword">function</span> <span class="token function">reconcileChildFibers</span><span class="token punctuation">(</span>
  <span class="token parameter">returnFiber<span class="token operator">:</span> Fiber<span class="token punctuation">,</span>
  currentFirstChild<span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  newChild<span class="token operator">:</span> any<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span><span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token punctuation">{</span>

  <span class="token keyword">const</span> isObject <span class="token operator">=</span> <span class="token keyword">typeof</span> newChild <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> newChild <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>isObject<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// object类型，可能是 REACT_ELEMENT_TYPE 或 REACT_PORTAL_TYPE</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>newChild<span class="token punctuation">.</span>$$<span class="token keyword">typeof</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> <span class="token constant">REACT_ELEMENT_TYPE</span><span class="token operator">:</span>
        <span class="token comment">// 调用 reconcileSingleElement 处理</span>
      <span class="token comment">// // ...省略其他case</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> newChild <span class="token operator">===</span> <span class="token string">'string'</span> <span class="token operator">||</span> <span class="token keyword">typeof</span> newChild <span class="token operator">===</span> <span class="token string">'number'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 调用 reconcileSingleTextNode 处理</span>
    <span class="token comment">// ...省略</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isArray</span><span class="token punctuation">(</span>newChild<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 调用 reconcileChildrenArray 处理</span>
    <span class="token comment">// ...省略</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 一些其他情况调用处理函数</span>
  <span class="token comment">// ...省略</span>

  <span class="token comment">// 以上都没有命中，删除节点</span>
  <span class="token keyword">return</span> <span class="token function">deleteRemainingChildren</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> currentFirstChild<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我们可以从同级的节点数量将Diff分为两类：</p> <ol><li>当<code>newChild</code>类型为<code>object</code>、<code>number</code>、<code>string</code>，代表同级只有一个节点</li> <li>当<code>newChild</code>类型为<code>Array</code>，同级有多个节点</li></ol> <p>在接下来两节我们会分别讨论这两类节点的<code>Diff</code>。</p> <p>对于单个节点，我们以类型<code>object</code>为例，会进入<code>reconcileSingleElement</code></p> <blockquote><p>你可以从<a href="https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactChildFiber.new.js#L1141" target="_blank" rel="noopener noreferrer">这里 (opens new window)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>看到<code>reconcileSingleElement</code>源码</p></blockquote> <div class="language-javascript extra-class"><pre class="language-javascript"><code>  <span class="token keyword">const</span> isObject <span class="token operator">=</span> <span class="token keyword">typeof</span> newChild <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> newChild <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>isObject<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 对象类型，可能是 REACT_ELEMENT_TYPE 或 REACT_PORTAL_TYPE</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>newChild<span class="token punctuation">.</span>$$<span class="token keyword">typeof</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> <span class="token constant">REACT_ELEMENT_TYPE</span><span class="token operator">:</span>
        <span class="token comment">// 调用 reconcileSingleElement 处理</span>
      <span class="token comment">// ...其他case</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>这个函数会做如下事情：</p> <p><img src="https://react.iamkasong.com/img/diff.png" alt="diff"></p> <p>让我们看看第二步<strong>判断DOM节点是否可以复用</strong>是如何实现的。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">reconcileSingleElement</span><span class="token punctuation">(</span>
  <span class="token parameter">returnFiber<span class="token operator">:</span> Fiber<span class="token punctuation">,</span>
  currentFirstChild<span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  element<span class="token operator">:</span> ReactElement</span>
<span class="token punctuation">)</span><span class="token operator">:</span> Fiber <span class="token punctuation">{</span>
  <span class="token keyword">const</span> key <span class="token operator">=</span> element<span class="token punctuation">.</span>key<span class="token punctuation">;</span>
  <span class="token keyword">let</span> child <span class="token operator">=</span> currentFirstChild<span class="token punctuation">;</span>
  
  <span class="token comment">// 首先判断是否存在对应DOM节点</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>child <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 上一次更新存在DOM节点，接下来判断是否可复用</span>

    <span class="token comment">// 首先比较key是否相同</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>child<span class="token punctuation">.</span>key <span class="token operator">===</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>

      <span class="token comment">// key相同，接下来比较type是否相同</span>

      <span class="token keyword">switch</span> <span class="token punctuation">(</span>child<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...省略case</span>
        
        <span class="token keyword">default</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>child<span class="token punctuation">.</span>elementType <span class="token operator">===</span> element<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// type相同则表示可以复用</span>
            <span class="token comment">// 返回复用的fiber</span>
            <span class="token keyword">return</span> existing<span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          
          <span class="token comment">// type不同则跳出switch</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 代码执行到这里代表：key相同但是type不同</span>
      <span class="token comment">// 将该fiber及其兄弟fiber标记为删除</span>
      <span class="token function">deleteRemainingChildren</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> child<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// key不同，将该fiber标记为删除</span>
      <span class="token function">deleteChild</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> child<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    child <span class="token operator">=</span> child<span class="token punctuation">.</span>sibling<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 创建新Fiber，并返回 ...省略</span>
<span class="token punctuation">}</span>
</code></pre></div><p>还记得我们刚才提到的，React预设的限制么，</p> <p>从代码可以看出，React通过先判断<code>key</code>是否相同，如果<code>key</code>相同则判断<code>type</code>是否相同，只有都相同时一个<code>DOM节点</code>才能复用。</p> <p>这里有个细节需要关注下：</p> <ul><li>当<code>child !== null</code>且<code>key相同</code>且<code>type不同</code>时执行<code>deleteRemainingChildren</code>将<code>child</code>及其兄弟<code>fiber</code>都标记删除。</li> <li>当<code>child !== null</code>且<code>key不同</code>时仅将<code>child</code>标记删除。</li></ul> <p>考虑如下例子：</p> <p>当前页面有3个<code>li</code>，我们要全部删除，再插入一个<code>p</code>。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 当前页面显示的</span>
ul <span class="token operator">&gt;</span> li <span class="token operator">*</span> <span class="token number">3</span>

<span class="token comment">// 这次需要更新的</span>
ul <span class="token operator">&gt;</span> p
</code></pre></div><p>由于本次更新时只有一个<code>p</code>，属于单一节点的<code>Diff</code>，会走上面介绍的代码逻辑。</p> <p>在<code>reconcileSingleElement</code>中遍历之前的3个<code>fiber</code>（对应的<code>DOM</code>为3个<code>li</code>），寻找本次更新的<code>p</code>是否可以复用之前的3个<code>fiber</code>中某个的<code>DOM</code>。</p> <p>当<code>key相同</code>且<code>type不同</code>时，代表我们已经找到本次更新的<code>p</code>对应的上次的<code>fiber</code>，但是<code>p</code>与<code>li</code> <code>type</code>不同，不能复用。既然唯一的可能性已经不能复用，则剩下的<code>fiber</code>都没有机会了，所以都需要标记删除。</p> <p>当<code>key不同</code>时只代表遍历到的该<code>fiber</code>不能被<code>p</code>复用，后面还有兄弟<code>fiber</code>还没有遍历到。所以仅仅标记该<code>fiber</code>删除。</p> <h2 id="练习题"><a href="#练习题" class="header-anchor">#</a> <a href="https://react.iamkasong.com/diff/one.html#%E7%BB%83%E4%B9%A0%E9%A2%98" target="_blank" rel="noopener noreferrer">#<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>练习题</h2> <p>让我们来做几道习题巩固下吧：</p> <p>请判断如下<code>JSX对象</code>对应的<code>DOM</code>元素是否可以复用：</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token comment">// 习题1 更新前</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">ka song</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">// 更新后</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">ka song</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">// 习题2 更新前</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>xxx<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">ka song</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">// 更新后</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ooo<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">ka song</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">// 习题3 更新前</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>xxx<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">ka song</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">// 更新后</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ooo<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">ka song</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">// 习题4 更新前</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>xxx<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">ka song</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">// 更新后</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>xxx<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">xiao bei</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>。</p> <p>。</p> <p>。</p> <p>。</p> <p>公布答案：</p> <p>习题1: 未设置<code>key prop</code>默认 <code>key = null;</code>，所以更新前后key相同，都为<code>null</code>，但是更新前<code>type</code>为<code>div</code>，更新后为<code>p</code>，<code>type</code>改变则不能复用。</p> <p>习题2: 更新前后<code>key</code>改变，不需要再判断<code>type</code>，不能复用。</p> <p>习题3: 更新前后<code>key</code>改变，不需要再判断<code>type</code>，不能复用。</p> <p>习题4: 更新前后<code>key</code>与<code>type</code>都未改变，可以复用。<code>children</code>变化，<code>DOM</code>的子元素需要更新。</p> <p>你是不是都答对了呢。</p> <p>上一节我们介绍了单一节点的<code>Diff</code>，现在考虑我们有一个<code>FunctionComponent</code>：</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">function</span> <span class="token function">List</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>0<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">0</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>1<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">1</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>2<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">2</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>3<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">3</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>他的返回值<code>JSX对象</code>的<code>children</code>属性不是单一节点，而是包含四个对象的数组</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  $$<span class="token keyword">typeof</span><span class="token operator">:</span> <span class="token function">Symbol</span><span class="token punctuation">(</span>react<span class="token punctuation">.</span>element<span class="token punctuation">)</span><span class="token punctuation">,</span>
  key<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  props<span class="token operator">:</span> <span class="token punctuation">{</span>
    children<span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>$$<span class="token keyword">typeof</span><span class="token operator">:</span> <span class="token function">Symbol</span><span class="token punctuation">(</span>react<span class="token punctuation">.</span>element<span class="token punctuation">)</span><span class="token punctuation">,</span> type<span class="token operator">:</span> <span class="token string">&quot;li&quot;</span><span class="token punctuation">,</span> key<span class="token operator">:</span> <span class="token string">&quot;0&quot;</span><span class="token punctuation">,</span> ref<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> props<span class="token operator">:</span> <span class="token punctuation">{</span>…<span class="token punctuation">}</span><span class="token punctuation">,</span> …<span class="token punctuation">}</span>
      <span class="token punctuation">{</span>$$<span class="token keyword">typeof</span><span class="token operator">:</span> <span class="token function">Symbol</span><span class="token punctuation">(</span>react<span class="token punctuation">.</span>element<span class="token punctuation">)</span><span class="token punctuation">,</span> type<span class="token operator">:</span> <span class="token string">&quot;li&quot;</span><span class="token punctuation">,</span> key<span class="token operator">:</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span> ref<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> props<span class="token operator">:</span> <span class="token punctuation">{</span>…<span class="token punctuation">}</span><span class="token punctuation">,</span> …<span class="token punctuation">}</span>
      <span class="token punctuation">{</span>$$<span class="token keyword">typeof</span><span class="token operator">:</span> <span class="token function">Symbol</span><span class="token punctuation">(</span>react<span class="token punctuation">.</span>element<span class="token punctuation">)</span><span class="token punctuation">,</span> type<span class="token operator">:</span> <span class="token string">&quot;li&quot;</span><span class="token punctuation">,</span> key<span class="token operator">:</span> <span class="token string">&quot;2&quot;</span><span class="token punctuation">,</span> ref<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> props<span class="token operator">:</span> <span class="token punctuation">{</span>…<span class="token punctuation">}</span><span class="token punctuation">,</span> …<span class="token punctuation">}</span>
      <span class="token punctuation">{</span>$$<span class="token keyword">typeof</span><span class="token operator">:</span> <span class="token function">Symbol</span><span class="token punctuation">(</span>react<span class="token punctuation">.</span>element<span class="token punctuation">)</span><span class="token punctuation">,</span> type<span class="token operator">:</span> <span class="token string">&quot;li&quot;</span><span class="token punctuation">,</span> key<span class="token operator">:</span> <span class="token string">&quot;3&quot;</span><span class="token punctuation">,</span> ref<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> props<span class="token operator">:</span> <span class="token punctuation">{</span>…<span class="token punctuation">}</span><span class="token punctuation">,</span> …<span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  ref<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  type<span class="token operator">:</span> <span class="token string">&quot;ul&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这种情况下，<code>reconcileChildFibers</code>的<code>newChild</code>参数类型为<code>Array</code>，在<code>reconcileChildFibers</code>函数内部对应如下情况：</p> <blockquote><p>你可以在<a href="https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactChildFiber.new.js#L1352" target="_blank" rel="noopener noreferrer">这里 (opens new window)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>看到这段源码逻辑</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isArray</span><span class="token punctuation">(</span>newChild<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 调用 reconcileChildrenArray 处理</span>
    <span class="token comment">// ...省略</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>这一节我们来看看，如何处理同级多个节点的<code>Diff</code>。</p> <h2 id="概览"><a href="#概览" class="header-anchor">#</a> <a href="https://react.iamkasong.com/diff/multi.html#%E6%A6%82%E8%A7%88" target="_blank" rel="noopener noreferrer">#<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>概览</h2> <p>首先归纳下我们需要处理的情况：</p> <p>我们以<strong>之前</strong>代表更新前的<code>JSX对象</code>，<strong>之后</strong>代表更新后的<code>JSX对象</code></p> <h3 id="情况1-节点更新"><a href="#情况1-节点更新" class="header-anchor">#</a> <a href="https://react.iamkasong.com/diff/multi.html#%E6%83%85%E5%86%B51-%E8%8A%82%E7%82%B9%E6%9B%B4%E6%96%B0" target="_blank" rel="noopener noreferrer">#<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>情况1：节点更新</h3> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token comment">// 之前</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>0<span class="token punctuation">&quot;</span></span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>before<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">0</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>1<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">1</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">

// 之后 情况1 —— 节点属性变化
</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>0<span class="token punctuation">&quot;</span></span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>after<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">0</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>1<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">1</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">

// 之后 情况2 —— 节点类型更新
</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>0<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">0</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>1<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">1</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
</span></code></pre></div><h3 id="情况2-节点新增或减少"><a href="#情况2-节点新增或减少" class="header-anchor">#</a> <a href="https://react.iamkasong.com/diff/multi.html#%E6%83%85%E5%86%B52-%E8%8A%82%E7%82%B9%E6%96%B0%E5%A2%9E%E6%88%96%E5%87%8F%E5%B0%91" target="_blank" rel="noopener noreferrer">#<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>情况2：节点新增或减少</h3> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token comment">// 之前</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>0<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">0</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>1<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">1</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">

// 之后 情况1 —— 新增节点
</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>0<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">0</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>1<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">1</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>2<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">2</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">

// 之后 情况2 —— 删除节点
</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>1<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">1</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
</span></code></pre></div><h3 id="情况3-节点位置变化"><a href="#情况3-节点位置变化" class="header-anchor">#</a> <a href="https://react.iamkasong.com/diff/multi.html#%E6%83%85%E5%86%B53-%E8%8A%82%E7%82%B9%E4%BD%8D%E7%BD%AE%E5%8F%98%E5%8C%96" target="_blank" rel="noopener noreferrer">#<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>情况3：节点位置变化</h3> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token comment">// 之前</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>0<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">0</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>1<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">1</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">

// 之后
</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>1<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">1</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>0<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">0</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
</span></code></pre></div><p>同级多个节点的<code>Diff</code>，一定属于以上三种情况中的一种或多种。</p> <h2 id="diff的思路"><a href="#diff的思路" class="header-anchor">#</a> <a href="https://react.iamkasong.com/diff/multi.html#diff%E7%9A%84%E6%80%9D%E8%B7%AF" target="_blank" rel="noopener noreferrer">#<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>Diff的思路</h2> <p>该如何设计算法呢？如果让我设计一个<code>Diff算法</code>，我首先想到的方案是：</p> <ol><li>判断当前节点的更新属于哪种情况</li> <li>如果是<code>新增</code>，执行新增逻辑</li> <li>如果是<code>删除</code>，执行删除逻辑</li> <li>如果是<code>更新</code>，执行更新逻辑</li></ol> <p>按这个方案，其实有个隐含的前提——<strong>不同操作的优先级是相同的</strong></p> <p>但是<code>React团队</code>发现，在日常开发中，相较于<code>新增</code>和<code>删除</code>，<code>更新</code>组件发生的频率更高。所以<code>Diff</code>会优先判断当前节点是否属于<code>更新</code>。</p> <p>注意</p> <p>在我们做数组相关的算法题时，经常使用<strong>双指针</strong>从数组头和尾同时遍历以提高效率，但是这里却不行。</p> <p>虽然本次更新的<code>JSX对象</code> <code>newChildren</code>为数组形式，但是和<code>newChildren</code>中每个组件进行比较的是<code>current fiber</code>，同级的<code>Fiber节点</code>是由<code>sibling</code>指针链接形成的单链表，即不支持双指针遍历。</p> <p>即 <code>newChildren[0]</code>与<code>fiber</code>比较，<code>newChildren[1]</code>与<code>fiber.sibling</code>比较。</p> <p>所以无法使用<strong>双指针</strong>优化。</p> <p>基于以上原因，<code>Diff算法</code>的整体逻辑会经历两轮遍历：</p> <p>第一轮遍历：处理<code>更新</code>的节点。</p> <p>第二轮遍历：处理剩下的不属于<code>更新</code>的节点。</p> <h2 id="第一轮遍历"><a href="#第一轮遍历" class="header-anchor">#</a> <a href="https://react.iamkasong.com/diff/multi.html#%E7%AC%AC%E4%B8%80%E8%BD%AE%E9%81%8D%E5%8E%86" target="_blank" rel="noopener noreferrer">#<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>第一轮遍历</h2> <p>第一轮遍历步骤如下：</p> <ol><li><code>let i = 0</code>，遍历<code>newChildren</code>，将<code>newChildren[i]</code>与<code>oldFiber</code>比较，判断<code>DOM节点</code>是否可复用。</li> <li>如果可复用，<code>i++</code>，继续比较<code>newChildren[i]</code>与<code>oldFiber.sibling</code>，可以复用则继续遍历。</li> <li>如果不可复用，分两种情况：</li></ol> <ul><li><code>key</code>不同导致不可复用，立即跳出整个遍历，<strong>第一轮遍历结束。</strong></li> <li><code>key</code>相同<code>type</code>不同导致不可复用，会将<code>oldFiber</code>标记为<code>DELETION</code>，并继续遍历</li></ul> <ol><li>如果<code>newChildren</code>遍历完（即<code>i === newChildren.length - 1</code>）或者<code>oldFiber</code>遍历完（即<code>oldFiber.sibling === null</code>），跳出遍历，<strong>第一轮遍历结束。</strong></li></ol> <blockquote><p>你可以从<a href="https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactChildFiber.new.js#L818" target="_blank" rel="noopener noreferrer">这里 (opens new window)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>看到这轮遍历的源码</p></blockquote> <p>当遍历结束后，会有两种结果：</p> <h3 id="步骤3跳出的遍历"><a href="#步骤3跳出的遍历" class="header-anchor">#</a> <a href="https://react.iamkasong.com/diff/multi.html#%E6%AD%A5%E9%AA%A43%E8%B7%B3%E5%87%BA%E7%9A%84%E9%81%8D%E5%8E%86" target="_blank" rel="noopener noreferrer">#<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>步骤3跳出的遍历</h3> <p>此时<code>newChildren</code>没有遍历完，<code>oldFiber</code>也没有遍历完。</p> <p>举个例子，考虑如下代码：</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token comment">// 之前</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>0<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">0</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>1<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">1</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>2<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">2</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
            
<span class="token comment">// 之后</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>0<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">0</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>2<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">1</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>1<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">2</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>第一个节点可复用，遍历到<code>key === 2</code>的节点发现<code>key</code>改变，不可复用，跳出遍历，等待第二轮遍历处理。</p> <p>此时<code>oldFiber</code>剩下<code>key === 1</code>、<code>key === 2</code>未遍历，<code>newChildren</code>剩下<code>key === 2</code>、<code>key === 1</code>未遍历。</p> <h3 id="步骤4跳出的遍历"><a href="#步骤4跳出的遍历" class="header-anchor">#</a> <a href="https://react.iamkasong.com/diff/multi.html#%E6%AD%A5%E9%AA%A44%E8%B7%B3%E5%87%BA%E7%9A%84%E9%81%8D%E5%8E%86" target="_blank" rel="noopener noreferrer">#<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>步骤4跳出的遍历</h3> <p>可能<code>newChildren</code>遍历完，或<code>oldFiber</code>遍历完，或他们同时遍历完。</p> <p>举个例子，考虑如下代码：</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token comment">// 之前</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>0<span class="token punctuation">&quot;</span></span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>a<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">0</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>1<span class="token punctuation">&quot;</span></span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>b<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">1</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
            
<span class="token comment">// 之后 情况1 —— newChildren与oldFiber都遍历完</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>0<span class="token punctuation">&quot;</span></span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>aa<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">0</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>1<span class="token punctuation">&quot;</span></span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>bb<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">1</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
            
<span class="token comment">// 之后 情况2 —— newChildren没遍历完，oldFiber遍历完</span>
<span class="token comment">// newChildren剩下 key===&quot;2&quot; 未遍历</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>0<span class="token punctuation">&quot;</span></span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>aa<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">0</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>1<span class="token punctuation">&quot;</span></span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>bb<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">1</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>2<span class="token punctuation">&quot;</span></span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>cc<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">2</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
            
<span class="token comment">// 之后 情况3 —— newChildren遍历完，oldFiber没遍历完</span>
<span class="token comment">// oldFiber剩下 key===&quot;1&quot; 未遍历</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>0<span class="token punctuation">&quot;</span></span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>aa<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">0</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>带着第一轮遍历的结果，我们开始第二轮遍历。</p> <h2 id="第二轮遍历"><a href="#第二轮遍历" class="header-anchor">#</a> <a href="https://react.iamkasong.com/diff/multi.html#%E7%AC%AC%E4%BA%8C%E8%BD%AE%E9%81%8D%E5%8E%86" target="_blank" rel="noopener noreferrer">#<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>第二轮遍历</h2> <p>对于第一轮遍历的结果，我们分别讨论：</p> <h3 id="newchildren与oldfiber同时遍历完"><a href="#newchildren与oldfiber同时遍历完" class="header-anchor">#</a> <a href="https://react.iamkasong.com/diff/multi.html#newchildren%E4%B8%8Eoldfiber%E5%90%8C%E6%97%B6%E9%81%8D%E5%8E%86%E5%AE%8C" target="_blank" rel="noopener noreferrer">#<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a><code>newChildren</code>与<code>oldFiber</code>同时遍历完</h3> <p>那就是最理想的情况：只需在第一轮遍历进行组件<a href="https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactChildFiber.new.js#L825" target="_blank" rel="noopener noreferrer"><code>更新</code> (opens new window)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。此时<code>Diff</code>结束。</p> <h3 id="newchildren没遍历完-oldfiber遍历完"><a href="#newchildren没遍历完-oldfiber遍历完" class="header-anchor">#</a> <a href="https://react.iamkasong.com/diff/multi.html#newchildren%E6%B2%A1%E9%81%8D%E5%8E%86%E5%AE%8C-oldfiber%E9%81%8D%E5%8E%86%E5%AE%8C" target="_blank" rel="noopener noreferrer">#<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a><code>newChildren</code>没遍历完，<code>oldFiber</code>遍历完</h3> <p>已有的<code>DOM节点</code>都复用了，这时还有新加入的节点，意味着本次更新有新节点插入，我们只需要遍历剩下的<code>newChildren</code>为生成的<code>workInProgress fiber</code>依次标记<code>Placement</code>。</p> <blockquote><p>你可以在<a href="https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactChildFiber.new.js#L869" target="_blank" rel="noopener noreferrer">这里 (opens new window)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>看到这段源码逻辑</p></blockquote> <h3 id="newchildren遍历完-oldfiber没遍历完"><a href="#newchildren遍历完-oldfiber没遍历完" class="header-anchor">#</a> <a href="https://react.iamkasong.com/diff/multi.html#newchildren%E9%81%8D%E5%8E%86%E5%AE%8C-oldfiber%E6%B2%A1%E9%81%8D%E5%8E%86%E5%AE%8C" target="_blank" rel="noopener noreferrer">#<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a><code>newChildren</code>遍历完，<code>oldFiber</code>没遍历完</h3> <p>意味着本次更新比之前的节点数量少，有节点被删除了。所以需要遍历剩下的<code>oldFiber</code>，依次标记<code>Deletion</code>。</p> <blockquote><p>你可以在<a href="https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactChildFiber.new.js#L863" target="_blank" rel="noopener noreferrer">这里 (opens new window)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>看到这段源码逻辑</p></blockquote> <h3 id="newchildren与oldfiber都没遍历完"><a href="#newchildren与oldfiber都没遍历完" class="header-anchor">#</a> <a href="https://react.iamkasong.com/diff/multi.html#newchildren%E4%B8%8Eoldfiber%E9%83%BD%E6%B2%A1%E9%81%8D%E5%8E%86%E5%AE%8C" target="_blank" rel="noopener noreferrer">#<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a><code>newChildren</code>与<code>oldFiber</code>都没遍历完</h3> <p>这意味着有节点在这次更新中改变了位置。</p> <p>这是<code>Diff算法</code>最精髓也是最难懂的部分。我们接下来会重点讲解。</p> <blockquote><p>你可以在<a href="https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactChildFiber.new.js#L893" target="_blank" rel="noopener noreferrer">这里 (opens new window)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>看到这段源码逻辑</p></blockquote> <h2 id="处理移动的节点"><a href="#处理移动的节点" class="header-anchor">#</a> <a href="https://react.iamkasong.com/diff/multi.html#%E5%A4%84%E7%90%86%E7%A7%BB%E5%8A%A8%E7%9A%84%E8%8A%82%E7%82%B9" target="_blank" rel="noopener noreferrer">#<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>处理移动的节点</h2> <p>由于有节点改变了位置，所以不能再用位置索引<code>i</code>对比前后的节点，那么如何才能将同一个节点在两次更新中对应上呢？</p> <p>我们需要使用<code>key</code>。</p> <p>为了快速的找到<code>key</code>对应的<code>oldFiber</code>，我们将所有还未处理的<code>oldFiber</code>存入以<code>key</code>为key，<code>oldFiber</code>为value的<code>Map</code>中。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> existingChildren <span class="token operator">=</span> <span class="token function">mapRemainingChildren</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> oldFiber<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><blockquote><p>你可以在<a href="https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactChildFiber.new.js#L890" target="_blank" rel="noopener noreferrer">这里 (opens new window)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>看到这段源码逻辑</p></blockquote> <p>接下来遍历剩余的<code>newChildren</code>，通过<code>newChildren[i].key</code>就能在<code>existingChildren</code>中找到<code>key</code>相同的<code>oldFiber</code>。</p> <h2 id="标记节点是否移动"><a href="#标记节点是否移动" class="header-anchor">#</a> <a href="https://react.iamkasong.com/diff/multi.html#%E6%A0%87%E8%AE%B0%E8%8A%82%E7%82%B9%E6%98%AF%E5%90%A6%E7%A7%BB%E5%8A%A8" target="_blank" rel="noopener noreferrer">#<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>标记节点是否移动</h2> <p>既然我们的目标是寻找移动的节点，那么我们需要明确：节点是否移动是以什么为参照物？</p> <p>我们的参照物是：最后一个可复用的节点在<code>oldFiber</code>中的位置索引（用变量<code>lastPlacedIndex</code>表示）。</p> <p>由于本次更新中节点是按<code>newChildren</code>的顺序排列。在遍历<code>newChildren</code>过程中，每个<code>遍历到的可复用节点</code>一定是当前遍历到的<code>所有可复用节点</code>中<strong>最靠右的那个</strong>，即一定在<code>lastPlacedIndex</code>对应的<code>可复用的节点</code>在本次更新中位置的后面。</p> <p>那么我们只需要比较<code>遍历到的可复用节点</code>在上次更新时是否也在<code>lastPlacedIndex</code>对应的<code>oldFiber</code>后面，就能知道两次更新中这两个节点的相对位置改变没有。</p> <p>我们用变量<code>oldIndex</code>表示<code>遍历到的可复用节点</code>在<code>oldFiber</code>中的位置索引。如果<code>oldIndex &lt; lastPlacedIndex</code>，代表本次更新该节点需要向右移动。</p> <p><code>lastPlacedIndex</code>初始为<code>0</code>，每遍历一个可复用的节点，如果<code>oldIndex &gt;= lastPlacedIndex</code>，则<code>lastPlacedIndex = oldIndex</code>。</p> <p>单纯文字表达比较晦涩，这里我们提供两个Demo，你可以对照着理解。</p> <h2 id="demo1"><a href="#demo1" class="header-anchor">#</a> <a href="https://react.iamkasong.com/diff/multi.html#demo1" target="_blank" rel="noopener noreferrer">#<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>Demo1</h2> <p>在Demo中我们简化下书写，每个字母代表一个节点，字母的值代表节点的<code>key</code></p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token comment">// 之前</span>
abcd

<span class="token comment">// 之后</span>
acdb

<span class="token operator">===</span>第一轮遍历开始<span class="token operator">===</span>
a（之后）vs a（之前）  
key不变，可复用
此时 a 对应的oldFiber（之前的a）在之前的数组（abcd）中索引为<span class="token number">0</span>
所以 lastPlacedIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

继续第一轮遍历<span class="token operator">...</span>

c（之后）vs b（之前）  
key改变，不能复用，跳出第一轮遍历
此时 lastPlacedIndex <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token operator">===</span>第一轮遍历结束<span class="token operator">===</span>

<span class="token operator">===</span>第二轮遍历开始<span class="token operator">===</span>
newChildren <span class="token operator">===</span> cdb，没用完，不需要执行删除旧节点
oldFiber <span class="token operator">===</span> bcd，没用完，不需要执行插入新节点

将剩余oldFiber（bcd）保存为map

<span class="token comment">// 当前oldFiber：bcd</span>
<span class="token comment">// 当前newChildren：cdb</span>

继续遍历剩余newChildren

key <span class="token operator">===</span> c 在 oldFiber中存在
<span class="token keyword">const</span> oldIndex <span class="token operator">=</span> c（之前）<span class="token punctuation">.</span>index<span class="token punctuation">;</span>
此时 oldIndex <span class="token operator">===</span> <span class="token number">2</span><span class="token punctuation">;</span>  <span class="token comment">// 之前节点为 abcd，所以c.index === 2</span>
比较 oldIndex 与 lastPlacedIndex<span class="token punctuation">;</span>

如果 oldIndex <span class="token operator">&gt;=</span> lastPlacedIndex 代表该可复用节点不需要移动
并将 lastPlacedIndex <span class="token operator">=</span> oldIndex<span class="token punctuation">;</span>
如果 oldIndex <span class="token operator">&lt;</span> lastplacedIndex 该可复用节点之前插入的位置索引小于这次更新需要插入的位置索引，代表该节点需要向右移动

在例子中，oldIndex <span class="token number">2</span> <span class="token operator">&gt;</span> lastPlacedIndex <span class="token number">0</span>，
则 lastPlacedIndex <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
c节点位置不变

继续遍历剩余newChildren

<span class="token comment">// 当前oldFiber：bd</span>
<span class="token comment">// 当前newChildren：db</span>

key <span class="token operator">===</span> d 在 oldFiber中存在
<span class="token keyword">const</span> oldIndex <span class="token operator">=</span> d（之前）<span class="token punctuation">.</span>index<span class="token punctuation">;</span>
oldIndex <span class="token number">3</span> <span class="token operator">&gt;</span> lastPlacedIndex <span class="token number">2</span> <span class="token comment">// 之前节点为 abcd，所以d.index === 3</span>
则 lastPlacedIndex <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
d节点位置不变

继续遍历剩余newChildren

<span class="token comment">// 当前oldFiber：b</span>
<span class="token comment">// 当前newChildren：b</span>

key <span class="token operator">===</span> b 在 oldFiber中存在
<span class="token keyword">const</span> oldIndex <span class="token operator">=</span> b（之前）<span class="token punctuation">.</span>index<span class="token punctuation">;</span>
oldIndex <span class="token number">1</span> <span class="token operator">&lt;</span> lastPlacedIndex <span class="token number">3</span> <span class="token comment">// 之前节点为 abcd，所以b.index === 1</span>
则 b节点需要向右移动
<span class="token operator">===</span>第二轮遍历结束<span class="token operator">===</span>

最终acd <span class="token number">3</span>个节点都没有移动，b节点被标记为移动
</code></pre></div><h2 id="demo2"><a href="#demo2" class="header-anchor">#</a> <a href="https://react.iamkasong.com/diff/multi.html#demo2" target="_blank" rel="noopener noreferrer">#<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>Demo2</h2> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token comment">// 之前</span>
abcd

<span class="token comment">// 之后</span>
dabc

<span class="token operator">===</span>第一轮遍历开始<span class="token operator">===</span>
d（之后）vs a（之前）  
key改变，不能复用，跳出遍历
<span class="token operator">===</span>第一轮遍历结束<span class="token operator">===</span>

<span class="token operator">===</span>第二轮遍历开始<span class="token operator">===</span>
newChildren <span class="token operator">===</span> dabc，没用完，不需要执行删除旧节点
oldFiber <span class="token operator">===</span> abcd，没用完，不需要执行插入新节点

将剩余oldFiber（abcd）保存为map

继续遍历剩余newChildren

<span class="token comment">// 当前oldFiber：abcd</span>
<span class="token comment">// 当前newChildren dabc</span>

key <span class="token operator">===</span> d 在 oldFiber中存在
<span class="token keyword">const</span> oldIndex <span class="token operator">=</span> d（之前）<span class="token punctuation">.</span>index<span class="token punctuation">;</span>
此时 oldIndex <span class="token operator">===</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token comment">// 之前节点为 abcd，所以d.index === 3</span>
比较 oldIndex 与 lastPlacedIndex<span class="token punctuation">;</span>
oldIndex <span class="token number">3</span> <span class="token operator">&gt;</span> lastPlacedIndex <span class="token number">0</span>
则 lastPlacedIndex <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
d节点位置不变

继续遍历剩余newChildren

<span class="token comment">// 当前oldFiber：abc</span>
<span class="token comment">// 当前newChildren abc</span>

key <span class="token operator">===</span> a 在 oldFiber中存在
<span class="token keyword">const</span> oldIndex <span class="token operator">=</span> a（之前）<span class="token punctuation">.</span>index<span class="token punctuation">;</span> <span class="token comment">// 之前节点为 abcd，所以a.index === 0</span>
此时 oldIndex <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">;</span>
比较 oldIndex 与 lastPlacedIndex<span class="token punctuation">;</span>
oldIndex <span class="token number">0</span> <span class="token operator">&lt;</span> lastPlacedIndex <span class="token number">3</span>
则 a节点需要向右移动

继续遍历剩余newChildren

<span class="token comment">// 当前oldFiber：bc</span>
<span class="token comment">// 当前newChildren bc</span>

key <span class="token operator">===</span> b 在 oldFiber中存在
<span class="token keyword">const</span> oldIndex <span class="token operator">=</span> b（之前）<span class="token punctuation">.</span>index<span class="token punctuation">;</span> <span class="token comment">// 之前节点为 abcd，所以b.index === 1</span>
此时 oldIndex <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">;</span>
比较 oldIndex 与 lastPlacedIndex<span class="token punctuation">;</span>
oldIndex <span class="token number">1</span> <span class="token operator">&lt;</span> lastPlacedIndex <span class="token number">3</span>
则 b节点需要向右移动

继续遍历剩余newChildren

<span class="token comment">// 当前oldFiber：c</span>
<span class="token comment">// 当前newChildren c</span>

key <span class="token operator">===</span> c 在 oldFiber中存在
<span class="token keyword">const</span> oldIndex <span class="token operator">=</span> c（之前）<span class="token punctuation">.</span>index<span class="token punctuation">;</span> <span class="token comment">// 之前节点为 abcd，所以c.index === 2</span>
此时 oldIndex <span class="token operator">===</span> <span class="token number">2</span><span class="token punctuation">;</span>
比较 oldIndex 与 lastPlacedIndex<span class="token punctuation">;</span>
oldIndex <span class="token number">2</span> <span class="token operator">&lt;</span> lastPlacedIndex <span class="token number">3</span>
则 c节点需要向右移动

<span class="token operator">===</span>第二轮遍历结束<span class="token operator">===</span>
</code></pre></div><p>可以看到，我们以为从 <code>abcd</code> 变为 <code>dabc</code>，只需要将<code>d</code>移动到前面。</p> <p>但实际上React保持<code>d</code>不变，将<code>abc</code>分别移动到了<code>d</code>的后面。</p> <p>从这点可以看出，考虑性能，我们要尽量减少将节点从后面移动到前面的操作。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/react/react源码/4.commit.html" class="prev">
        /react/react源码/4.commit.html
      </a></span> <span class="next"><a href="/react/react源码/6.1.状态更新.html">
        几个关键节点
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.b51e4ccd.js" defer></script><script src="/assets/js/2.7229199a.js" defer></script><script src="/assets/js/44.5160f68a.js" defer></script>
  </body>
</html>
